<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Factory Planner — Key Numbers</title>
  <style>
    :root{
      --gap:14px;--pad:16px;
      --bg:#f6f8fc;--card:#ffffff;--ink:#0b1320;--muted:#4a5874;--accent:#0b5fff;--border:#e4e9f2;--field:#d6dbe6;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:24px var(--pad);border-bottom:1px solid var(--border)}
    h1{margin:0 0 6px;font-size:22px}
    h2{margin:0 0 10px;font-size:18px;color:var(--accent)}
    main{padding:20px var(--pad) 60px;display:grid;gap:14px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    label{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-weight:600}
    input,select{background:#fff;color:var(--ink);border:1px solid var(--field);border-radius:8px;padding:10px 12px;outline:none}
    input:focus,select:focus{border-color:#2c6fff;box-shadow:0 0 0 2px rgba(44,111,255,.14)}
    .results{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0 0;padding:0;list-style:none}
    .results li{background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .results li span{color:var(--muted)} .results li strong{font-size:15px}
    .actions{display:flex;gap:10px;margin-top:10px}
    .btn{display:inline-block;background:var(--accent);color:#fff;border:1px solid var(--accent);
      padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600}
    .btn:hover,.btn:focus{background:#094de8;border-color:#094de8}
  </style>
</head>
<body>
<header>
  <h1>Factory Planner</h1>
  <div class="muted">Type values or pass them via URL (commas as decimals are OK). Auto-calculates, keeps the URL in sync, and reads fixed costs you saved.</div>
  <div class="actions">
    <a class="btn" href="fixed-costs.html">Fixed costs</a>
  </div>
</header>

<main>
  <!-- Key Numbers -->
  <section class="card" id="key">
    <h2>Key Numbers</h2>
    <div class="grid">
      <label>Produced kg (net)<input id="producedKg" inputmode="numeric"></label>
      <label>Selling price / kg<input id="sellPriceDay" inputmode="decimal"></label>
      <label>Raw used kg<input id="rawUsedKg" inputmode="numeric"></label>
      <label>Yield % (optional)<input id="yieldPct" inputmode="decimal" data-decimals="1"></label>
      <label>Raw cost / kg<input id="rawCostPerKg" inputmode="decimal"></label>
      <label>Pack cost / kg<input id="packCostPerKg" inputmode="decimal"></label>
      <label>Freight / kg<input id="freightPerKg" inputmode="decimal"></label>
    </div>
    <ul class="results">
      <li><span>Net saleable kg</span><strong id="key-net-kg">–</strong></li>
      <li><span>Revenue</span><strong id="key-revenue">–</strong></li>
      <li><span>Total cost</span><strong id="key-total-cost">–</strong></li>
      <li><span>Profit</span><strong id="key-profit">–</strong></li>
      <li><span>Gross margin %</span><strong id="key-gm">–</strong></li>
      <li><span>Profit / kg</span><strong id="key-profit-kg">–</strong></li>
    </ul>
  </section>

  <!-- Factory Day -->
  <section class="card" id="day">
    <h2>Factory Day</h2>

    <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Labor</h3>
    <div class="grid">
      <label>Operators<input id="staffCount" inputmode="numeric"></label>
      <label>€/operator/hr<input id="staffCostPerPerson" inputmode="decimal"></label>
      <label>Supervisors<input id="supCount" inputmode="numeric"></label>
      <label>€/supervisor/hr<input id="supCostPerPerson" inputmode="decimal"></label>
      <label>Operator hours<input id="staffHoursDay" inputmode="decimal" data-decimals="1" value="8"></label>
      <label>Supervisor hours<input id="supHoursDay" inputmode="decimal" data-decimals="1" value="8"></label>
    </div>

    <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
    <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Materials & Production</h3>
    <div class="grid">
      <label>Raw used kg<input id="rawUsedKg_day" inputmode="numeric"></label>
      <label>Raw cost / kg<input id="rawCostPerKg_day" inputmode="decimal"></label>
      <label>Pack cost / kg<input id="packCostPerKg_day" inputmode="decimal"></label>
      <label>Produced kg (net)<input id="producedKg_day" inputmode="numeric"></label>
      <label>Selling price / kg<input id="sellPriceDay_day" inputmode="decimal"></label>
      <label>Freight / kg<input id="freightPerKg_day" inputmode="decimal"></label>
    </div>

    <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
    <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Fixed (ISK → EUR/day)</h3>
    <div class="grid">
      <label>ISK per EUR<input id="iskPerEur" inputmode="decimal" data-decimals="4"></label>
      <label>Working days (auto if empty)<input id="workingDays" inputmode="numeric"></label>
      <label>Housing (ISK/month)<input id="housingCost" inputmode="numeric"></label>
      <label>Equipment (ISK/month)<input id="equipCost" inputmode="numeric"></label>
      <label>Admin (ISK/month)<input id="adminCost" inputmode="numeric"></label>
      <label>Depreciation (€/day)<input id="deprCost" inputmode="decimal"></label>
      <label>Month
        <select id="month"></select>
      </label>
    </div>

    <ul class="results">
      <li><span>Yield</span><strong id="day-yield">–</strong></li>
      <li><span>Revenue</span><strong id="day-revenue">–</strong></li>
      <li><span>Total cost</span><strong id="day-total-cost">–</strong></li>
      <li><span>Profit</span><strong id="day-profit">–</strong></li>
      <li><span>Gross margin %</span><strong id="day-margin">–</strong></li>
      <li><span>Cost / kg</span><strong id="day-cost-kg">–</strong></li>
    </ul>

    <h3 style="margin:10px 0 8px;color:#0b5fff;font-size:16px">Breakdown</h3>
    <ul class="results">
      <li><span>Labor (operators)</span><strong id="bd-labor-staff">–</strong></li>
      <li><span>Labor (supervisors)</span><strong id="bd-labor-sup">–</strong></li>
      <li><span>Material</span><strong id="bd-material">–</strong></li>
      <li><span>Pack</span><strong id="bd-pack">–</strong></li>
      <li><span>Freight</span><strong id="bd-freight">–</strong></li>
      <li><span>Electricity €/day</span><strong id="bd-elec">–</strong></li>
      <li><span>Water €/day</span><strong id="bd-water">–</strong></li>
      <li><span>Maintenance €/day</span><strong id="bd-maint">–</strong></li>
      <li><span>Rentals €/day</span><strong id="bd-rentals">–</strong></li>
      <li><span>Spare parts €/day</span><strong id="bd-spares">–</strong></li>
      <li><span>Other €/day</span><strong id="bd-other">–</strong></li>
      <li><span>Housing €/day</span><strong id="bd-housing">–</strong></li>
      <li><span>Equipment €/day</span><strong id="bd-equip">–</strong></li>
      <li><span>Admin €/day</span><strong id="bd-admin">–</strong></li>
      <li><span>Depreciation €/day</span><strong id="bd-depr">–</strong></li>
    </ul>
  </section>
</main>

<script>
/* ... keep all helpers above ... */

/* -------------------- number formatting for inputs -------------------- */
function initNumberFormatting(){
  const decimalsFor=(el)=>{
    if(el.dataset.decimals!=null) return Math.max(0, Number(el.dataset.decimals)||0);
    return el.getAttribute('inputmode')==='numeric'? 0 : 2;
  };
  const cache=new Map();
  const getFmt=(d)=>{
    if(!cache.has(d)) cache.set(d,new Intl.NumberFormat('is-IS',{minimumFractionDigits:d,maximumFractionDigits:d}));
    return cache.get(d);
  };
  const pretty=(el)=>{
    const d=decimalsFor(el), n=toNumber(el.value);
    if(!Number.isFinite(n)) return;
    el.value= d===0? getFmt(d).format(Math.round(n)) : getFmt(d).format(n);
  };
  const raw=(el)=>{
    const d=decimalsFor(el), n=toNumber(el.value);
    if(!Number.isFinite(n)) return;
    el.value= d===0? String(Math.round(n)) : String(n.toFixed(d));
  };

  // Apply formatting on focus/blur
  document.addEventListener('focusin',e=>{
    const el=e.target;
    if(el.matches('input[inputmode="decimal"], input[inputmode="numeric"]')) raw(el);
  });
  document.addEventListener('focusout',e=>{
    const el=e.target;
    if(el.matches('input[inputmode="decimal"], input[inputmode="numeric"]')) pretty(el);
  });

  // Initial pretty pass (force after load)
  qa('input[inputmode="decimal"], input[inputmode="numeric"]').forEach(pretty);
}

/* -------------------- URL <-> inputs -------------------- */
function applyQueryParams(){
  const p=new URLSearchParams(location.search);
  for(const [k,sel] of Object.entries(bindings)){
    const el=q(sel); if(!el) continue;
    let v=p.get(k);
    if(v==null || v==='') continue;
    if(k==='month'){
      if(/^\d{4}-\d{2}$/.test(v)) v=v.slice(5);
      if(/^\d{1,2}$/.test(v)) v=v.padStart(2,'0');
    }
    el.value=v;
  }
  // Format immediately after setting from URL
  qa('input[inputmode="decimal"], input[inputmode="numeric"]').forEach(el=>{
    const n=toNumber(el.value);
    if(Number.isFinite(n)) {
      const d = el.getAttribute('inputmode')==='numeric'? 0 : 2;
      el.value=new Intl.NumberFormat('is-IS',{minimumFractionDigits:d,maximumFractionDigits:d}).format(d===0?Math.round(n):n);
    }
  });
}

function loadSimpleDefaults(){
  ['iskPerEur','workingDays','housingCost','equipCost','adminCost','deprCost'].forEach(id=>{
    const el=q('#'+id); if(!el || el.value) return;
    const v=localStorage.getItem(LS_PREFIX+id);
    if(v!=null && v!=='') {
      el.value=v;
      // Format immediately after setting from storage
      const d = el.getAttribute('inputmode')==='numeric'? 0 : 2;
      const n=toNumber(v);
      if(Number.isFinite(n)) el.value=new Intl.NumberFormat('is-IS',{minimumFractionDigits:d,maximumFractionDigits:d}).format(d===0?Math.round(n):n);
    }
  });
}

/* -------------------- boot -------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  populateMonthSelect();
  applyQueryParams();
  loadSimpleDefaults();
  initNumberFormatting();    // now runs after setting values
  attachSync();
  calcKeyNumbers();
  calcDay();
});
</script>

</body>
</html>
