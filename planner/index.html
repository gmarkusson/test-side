<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Factory Planner — Key Numbers</title>
  <style>
    :root{
      --gap:14px;--pad:16px;
      --bg:#f6f8fc;--card:#ffffff;--ink:#0b1320;--muted:#4a5874;--accent:#0b5fff;--border:#e4e9f2;--field:#d6dbe6;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:24px var(--pad);border-bottom:1px solid var(--border)}
    h1{margin:0 0 6px;font-size:22px}
    h2{margin:0 0 10px;font-size:18px;color:var(--accent)}
    main{padding:20px var(--pad) 60px;display:grid;gap:14px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    label{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-weight:600}
    input,select{background:#fff;color:var(--ink);border:1px solid var(--field);border-radius:8px;padding:10px 12px;outline:none}
    input:focus,select:focus{border-color:#2c6fff;box-shadow:0 0 0 2px rgba(44,111,255,.14)}
    .results{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0 0;padding:0;list-style:none}
    .results li{background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .results li span{color:var(--muted)} .results li strong{font-size:15px}
    .actions{display:flex;gap:10px;margin-top:10px}
    .btn{display:inline-block;background:var(--accent);color:#fff;border:1px solid var(--accent);
      padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600}
    .btn:hover,.btn:focus{background:#094de8;border-color:#094de8}
  </style>
</head>
<body>
<header>
  <h1>Factory Planner</h1>
  <div class="muted">Type values or pass them via URL (commas or dots for decimals are OK). Auto-calculates and keeps the URL in sync.</div>
  <div class="actions">
    <a class="btn" href="fixed-costs.html">Fixed costs</a>
  </div>
</header>

<main>
  <!-- Key Numbers -->
  <section class="card">
    <h2>Key Numbers</h2>
    <div class="grid">
      <label>Produced kg (net)<input id="producedKg" inputmode="decimal" data-decimals="0"></label>
      <label>Selling price / kg<input id="sellPriceDay" inputmode="decimal" data-decimals="2"></label>
      <label>Raw used kg<input id="rawUsedKg" inputmode="decimal" data-decimals="0"></label>
      <label>Yield % (optional)<input id="yieldPct" inputmode="decimal" data-decimals="1"></label>
      <label>Raw cost / kg<input id="rawCostPerKg" inputmode="decimal" data-decimals="2"></label>
      <label>Pack cost / kg<input id="packCostPerKg" inputmode="decimal" data-decimals="2"></label>
      <label>Freight / kg<input id="freightPerKg" inputmode="decimal" data-decimals="2"></label>
    </div>
    <ul class="results">
      <li><span>Net saleable kg</span><strong id="key-net-kg">–</strong></li>
      <li><span>Revenue</span><strong id="key-revenue">–</strong></li>
      <li><span>Total cost</span><strong id="key-total-cost">–</strong></li>
      <li><span>Profit</span><strong id="key-profit">–</strong></li>
      <li><span>Gross margin %</span><strong id="key-gm">–</strong></li>
      <li><span>Profit / kg</span><strong id="key-profit-kg">–</strong></li>
    </ul>
  </section>

  <!-- Factory Day -->
  <section class="card" id="day">
    <h2>Factory Day</h2>
    <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Labor</h3>
    <div class="grid">
      <label>Operators<input id="staffCount" inputmode="numeric" data-decimals="0"></label>
      <label>€/operator/hr<input id="staffCostPerPerson" inputmode="decimal" data-decimals="2"></label>
      <label>Supervisors<input id="supCount" inputmode="numeric" data-decimals="0"></label>
      <label>€/supervisor/hr<input id="supCostPerPerson" inputmode="decimal" data-decimals="2"></label>
      <label>Operator hours<input id="staffHoursDay" inputmode="decimal" data-decimals="2" value="8"></label>
      <label>Supervisor hours<input id="supHoursDay" inputmode="decimal" data-decimals="2" value="8"></label>
    </div>

    <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
    <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Materials & Production</h3>
    <div class="grid">
      <label>Raw used kg<input id="rawUsedKg_day" inputmode="decimal" data-decimals="0"></label>
      <label>Raw cost / kg<input id="rawCostPerKg_day" inputmode="decimal" data-decimals="2"></label>
      <label>Pack cost / kg<input id="packCostPerKg_day" inputmode="decimal" data-decimals="2"></label>
      <label>Produced kg (net)<input id="producedKg_day" inputmode="decimal" data-decimals="0"></label>
      <label>Selling price / kg<input id="sellPriceDay_day" inputmode="decimal" data-decimals="2"></label>
      <label>Freight / kg<input id="freightPerKg_day" inputmode="decimal" data-decimals="2"></label>
    </div>

    <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
    <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Fixed (ISK → EUR/day)</h3>
    <div class="grid">
      <label>ISK per EUR<input id="iskPerEur" inputmode="decimal" data-decimals="4"></label>
      <label>Working days<input id="workingDays" inputmode="numeric" data-decimals="0"></label>
      <label>Housing (ISK/month)<input id="housingCost" inputmode="decimal" data-decimals="0"></label>
      <label>Equipment (ISK/month)<input id="equipCost" inputmode="decimal" data-decimals="0"></label>
      <label>Admin (ISK/month)<input id="adminCost" inputmode="decimal" data-decimals="0"></label>
      <label>Depreciation (€/day)<input id="deprCost" inputmode="decimal" data-decimals="2"></label>
      <label>Month
        <select id="month"></select>
      </label>
    </div>

    <ul class="results">
      <li><span>Yield</span><strong id="day-yield">–</strong></li>
      <li><span>Revenue</span><strong id="day-revenue">–</strong></li>
      <li><span>Total cost</span><strong id="day-total-cost">–</strong></li>
      <li><span>Profit</span><strong id="day-profit">–</strong></li>
      <li><span>Gross margin %</span><strong id="day-margin">–</strong></li>
      <li><span>Cost / kg</span><strong id="day-cost-kg">–</strong></li>
    </ul>

    <h3 style="margin:10px 0 8px;color:#0b5fff;font-size:16px">Breakdown</h3>
    <ul class="results">
      <li><span>Labor (operators)</span><strong id="bd-labor-staff">–</strong></li>
      <li><span>Labor (supervisors)</span><strong id="bd-labor-sup">–</strong></li>
      <li><span>Material</span><strong id="bd-material">–</strong></li>
      <li><span>Pack</span><strong id="bd-pack">–</strong></li>
      <li><span>Freight</span><strong id="bd-freight">–</strong></li>
      <li><span>Electricity €/day</span><strong id="bd-elec">–</strong></li>
      <li><span>Water €/day</span><strong id="bd-water">–</strong></li>
      <li><span>Maintenance €/day</span><strong id="bd-maint">–</strong></li>
      <li><span>Rentals €/day</span><strong id="bd-rentals">–</strong></li>
      <li><span>Spare parts €/day</span><strong id="bd-spares">–</strong></li>
      <li><span>Other €/day</span><strong id="bd-other">–</strong></li>
      <li><span>Housing €/day</span><strong id="bd-housing">–</strong></li>
      <li><span>Equipment €/day</span><strong id="bd-equip">–</strong></li>
      <li><span>Admin €/day</span><strong id="bd-admin">–</strong></li>
      <li><span>Depreciation €/day</span><strong id="bd-depr">–</strong></li>
    </ul>
  </section>
</main>

<script>
/* ---------- helpers ---------- */
const locale='is-IS';
const LS_PREFIX='fp:';
const q=(s,r=document)=>r.querySelector(s);
const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));
const setText=(sel,val)=>{const el=typeof sel==='string'?q(sel):sel;if(el)el.textContent=val;};
const fmt=(n,d=2)=>Number.isFinite(n)? new Intl.NumberFormat(locale,{minimumFractionDigits:d,maximumFractionDigits:d}).format(n) : '–';

// Robust parser: accepts 1,234.56 / 1.234,56 / 1,000 / 1.000 / 8,90 / 8.90
function toNumber(v){
  if(v==null) return NaN;
  let s=String(v).trim().replace(/\u00A0/g,'').replace(/\s/g,'');
  if(!s) return NaN;
  const hasC=s.includes(','), hasD=s.includes('.');
  if(hasC && hasD){
    // pick the rightmost as decimal sep
    if(s.lastIndexOf(',')>s.lastIndexOf('.')){ s=s.replace(/\./g,'').replace(',', '.'); }
    else { s=s.replace(/,/g,''); }
  }else if(hasC){
    const parts=s.split(',');
    const looksThousands=parts.length>1 && parts.every((p,i)=> i===0 ? p.length<=3 : p.length===3);
    s = looksThousands ? s.replace(/,/g,'') : s.replace(',', '.');
  }else if(hasD){
    const parts=s.split('.');
    const looksThousands=parts.length>1 && parts.every((p,i)=> i===0 ? p.length<=3 : p.length===3);
    if(looksThousands) s=s.replace(/\./g,'');
  }
  const n=Number(s);
  return Number.isFinite(n)? n : NaN;
}

/* ---------- month / working days ---------- */
function workingDaysInMonth(val){
  let y = new Date().getFullYear(), m;
  if(/^\d{2}$/.test(val)) m=Number(val);
  else if(/^\d{4}-\d{2}$/.test(val)){ const t=val.split('-'); y=Number(t[0]); m=Number(t[1]); }
  else return NaN;
  const end=new Date(y,m,0).getDate();
  let days=0;
  for(let d=1; d<=end; d++){ const dow=new Date(y,m-1,d).getDay(); if(dow!==0 && dow!==6) days++; }
  return days;
}
function populateMonthSelect(){
  const sel=q('#month'); if(!sel) return;
  sel.innerHTML='';
  for(let i=0;i<12;i++){
    const label=new Date(2000,i,1).toLocaleString('en',{month:'long'});
    const m=String(i+1).padStart(2,'0');
    sel.add(new Option(label,m));
  }
  if(!sel.value) sel.value=String(new Date().getMonth()+1).padStart(2,'0');
}
function refreshWorkingDaysFromMonth(){
  const sel=q('#month'), box=q('#workingDays'); if(!sel||!box) return;
  if(box.dataset.manual==='1') return; // user overrode; don't clobber
  const wd=workingDaysInMonth(sel.value);
  if(Number.isFinite(wd)) box.value = new Intl.NumberFormat('is-IS',{maximumFractionDigits:0}).format(wd);
}

/* ---------- URL sync ---------- */
const bindings={
  producedKg:'#producedKg', sellPriceDay:'#sellPriceDay', rawUsedKg:'#rawUsedKg', yieldPct:'#yieldPct',
  rawCostPerKg:'#rawCostPerKg', packCostPerKg:'#packCostPerKg', freightPerKg:'#freightPerKg',
  rawUsedKg_day:'#rawUsedKg_day', rawCostPerKg_day:'#rawCostPerKg_day', packCostPerKg_day:'#packCostPerKg_day',
  producedKg_day:'#producedKg_day', sellPriceDay_day:'#sellPriceDay_day', freightPerKg_day:'#freightPerKg_day',
  month:'#month', workingDays:'#workingDays',
  iskPerEur:'#iskPerEur', housingCost:'#housingCost', equipCost:'#equipCost', adminCost:'#adminCost', deprCost:'#deprCost'
};
function applyQueryParams(){
  const p=new URLSearchParams(location.search);
  for(const [k,sel] of Object.entries(bindings)){
    const el=q(sel); if(!el) continue;
    let v=p.get(k);
    if(v==null || v==='') continue;
    if(k==='month'){
      if(/^\d{4}-\d{2}$/.test(v)) v=v.slice(5);
      if(/^\d{1,2}$/.test(v)) v=v.padStart(2,'0');
      el.value=v;
    }else{
      el.value=v;
    }
  }
}
function syncUrlFromInputs(){
  const p=new URLSearchParams(location.search);
  for(const [k,sel] of Object.entries(bindings)){
    const el=q(sel); if(!el) continue;
    const val=el.value?.trim();
    if(val) p.set(k,val); else p.delete(k);
  }
  history.replaceState(null,'',`${location.pathname}?${p.toString()}`);
}

/* ---------- number input pretty formatting (all inputs) ---------- */
const nfCache=new Map();
const getFmt=(d)=>{ if(!nfCache.has(d)) nfCache.set(d,new Intl.NumberFormat('is-IS',{minimumFractionDigits:d,maximumFractionDigits:d})); return nfCache.get(d); };
const decimalsFor=(el)=> el.dataset.decimals!=null ? Math.max(0,Number(el.dataset.decimals)||0) : (el.getAttribute('inputmode')==='numeric'?0:2);
function formatPretty(el){
  const d=decimalsFor(el), n=toNumber(el.value);
  if(!Number.isFinite(n)) return;
  el.value=getFmt(d).format(d===0?Math.round(n):n);
}
function formatRaw(el){
  const d=decimalsFor(el), n=toNumber(el.value);
  if(!Number.isFinite(n)) return;
  el.value=d===0? String(Math.round(n)) : String(n.toFixed(d));
}
function initNumberFormatting(){
  // delegate so it also works if nodes are replaced
  document.addEventListener('focusin',e=>{
    const el=e.target;
    if(el.matches('input[inputmode="decimal"],input[inputmode="numeric"]')) formatRaw(el);
  });
  document.addEventListener('focusout',e=>{
    const el=e.target;
    if(el.matches('input[inputmode="decimal"],input[inputmode="numeric"]')) formatPretty(el);
  });
  // initial pretty pass
  qa('input[inputmode="decimal"],input[inputmode="numeric"]').forEach(formatPretty);
}

/* ---------- storage helpers ---------- */
function getParamOrStoreNum(param, storeKey=param){
  const p=new URLSearchParams(location.search);
  const v=p.get(param);
  if(v!=null && v!==''){ const n=toNumber(v); if(Number.isFinite(n)) return n; }
  const s=localStorage.getItem(LS_PREFIX+storeKey);
  const n=toNumber(s);
  return Number.isFinite(n)? n : 0;
}

/* ---------- calculations ---------- */
function calcKeyNumbers(){
  const producedKg = toNumber(q('#producedKg').value);
  const sellPrice  = toNumber(q('#sellPriceDay').value);
  const rawCost    = toNumber(q('#rawCostPerKg').value)    || 0;
  const packCost   = toNumber(q('#packCostPerKg').value)   || 0;
  const freight    = toNumber(q('#freightPerKg').value)    || 0;

  const rawUsedEl  = q('#rawUsedKg');
  const yieldEl    = q('#yieldPct');
  const rawUsedIn  = toNumber(rawUsedEl.value);
  const yieldIn    = toNumber(yieldEl.value);

  let rawUsedEff = Number.isFinite(rawUsedIn) ? rawUsedIn : NaN;
  let yieldEff   = Number.isFinite(yieldIn)   ? yieldIn   : NaN;

  if (Number.isFinite(producedKg)) {
    if (Number.isFinite(yieldIn) && yieldIn > 0) {
      rawUsedEff = producedKg / (yieldIn / 100);
      if (!Number.isFinite(rawUsedIn)) { rawUsedEl.value = String(Math.round(rawUsedEff)); formatPretty(rawUsedEl); }
    } else if (Number.isFinite(rawUsedIn) && rawUsedIn > 0) {
      yieldEff = (producedKg / rawUsedIn) * 100;
      if (!Number.isFinite(yieldIn)) { yieldEl.value = yieldEff.toFixed(1); formatPretty(yieldEl); }
    }
  }

  const revenue    = (Number.isFinite(producedKg) && Number.isFinite(sellPrice)) ? producedKg * sellPrice : NaN;
  const rawMatCost = Number.isFinite(rawUsedEff) ? rawUsedEff * rawCost : NaN;
  const packC      = Number.isFinite(producedKg) ? producedKg * packCost : NaN;
  const freightC   = Number.isFinite(producedKg) ? producedKg * freight  : NaN;

  const totalCost  = [rawMatCost, packC, freightC].reduce((s,v)=>s + (Number.isFinite(v) ? v : 0), 0);
  const profit     = Number.isFinite(revenue) ? revenue - totalCost : NaN;
  const marginPct  = (Number.isFinite(revenue) && revenue !== 0) ? (profit / revenue) * 100 : NaN;
  const profitKg   = (Number.isFinite(producedKg) && producedKg > 0) ? profit / producedKg : NaN;

  setText('#key-net-kg',    Number.isFinite(producedKg)? fmt(producedKg,0) : '–');
  setText('#key-revenue',   fmt(revenue,2));
  setText('#key-total-cost',fmt(totalCost,2));
  setText('#key-profit',    fmt(profit,2));
  setText('#key-gm',        Number.isFinite(marginPct) ? fmt(marginPct,1)+' %' : '–');
  setText('#key-profit-kg', fmt(profitKg,2));
}

function calcDay(){
  // Labor
  const staffCount=toNumber(q('#staffCount').value);
  const staffHr   =toNumber(q('#staffHoursDay').value);
  const staffRate =toNumber(q('#staffCostPerPerson').value);
  const supCount  =toNumber(q('#supCount').value);
  const supHr     =toNumber(q('#supHoursDay').value);
  const supRate   =toNumber(q('#supCostPerPerson').value);

  const laborStaff=(Number.isFinite(staffCount)&&Number.isFinite(staffHr)&&Number.isFinite(staffRate))
    ? staffCount*staffHr*staffRate : 0;
  const laborSup  =(Number.isFinite(supCount)&&Number.isFinite(supHr)&&Number.isFinite(supRate))
    ? supCount*supHr*supRate : 0;

  // Materials & production
  const rawUsedKg_day    =toNumber(q('#rawUsedKg_day').value);
  const rawCostPerKg_day =toNumber(q('#rawCostPerKg_day').value);
  const packCostPerKg_day=toNumber(q('#packCostPerKg_day').value);
  const producedKg_day   =toNumber(q('#producedKg_day').value);
  const sellPriceDay_day =toNumber(q('#sellPriceDay_day').value);
  const freightPerKg_day =toNumber(q('#freightPerKg_day').value);

  const matCost =(Number.isFinite(rawUsedKg_day)&&Number.isFinite(rawCostPerKg_day)) ? rawUsedKg_day*rawCostPerKg_day : 0;
  const packCost=(Number.isFinite(producedKg_day)&&Number.isFinite(packCostPerKg_day))? producedKg_day*packCostPerKg_day : 0;
  const freight =(Number.isFinite(producedKg_day)&&Number.isFinite(freightPerKg_day))? producedKg_day*freightPerKg_day : 0;

  // Fixed / month → day
  const monthStr=q('#month').value?.trim();
  let workDays=toNumber(q('#workingDays').value);
  if(!Number.isFinite(workDays)){
    const wd=workingDaysInMonth(monthStr);
    if(Number.isFinite(wd)) workDays=wd;
  }
  if(!Number.isFinite(workDays) || workDays<=0) workDays=22;

  const iskPerEur=toNumber(q('#iskPerEur').value);
  const canFX=Number.isFinite(iskPerEur) && iskPerEur>0;

  const housingISK=toNumber(q('#housingCost').value);
  const equipISK  =toNumber(q('#equipCost').value);
  const adminISK  =toNumber(q('#adminCost').value);
  const deprEURd  =toNumber(q('#deprCost').value) || 0;

  const maintEURm   = getParamOrStoreNum('maintEurMonth');
  const rentalsEURm = getParamOrStoreNum('rentalsEurMonth');
  const sparesEURm  = getParamOrStoreNum('sparesEurMonth');
  const elecEURm    = getParamOrStoreNum('electricityEurMonth');
  const waterEURm   = getParamOrStoreNum('waterEurMonth');
  const otherEURm   = getParamOrStoreNum('otherEurMonth');

  const maintEURd   = maintEURm   / workDays;
  const rentalsEURd = rentalsEURm / workDays;
  const sparesEURd  = sparesEURm  / workDays;
  const elecEURd    = elecEURm    / workDays;
  const waterEURd   = waterEURm   / workDays;
  const otherEURd   = otherEURm   / workDays;

  const housingDay = (canFX && Number.isFinite(housingISK)) ? (housingISK*iskPerEur)/workDays : 0;
  const equipDay   = (canFX && Number.isFinite(equipISK))   ? (equipISK  *iskPerEur)/workDays : 0;
  const adminDay   = (canFX && Number.isFinite(adminISK))   ? (adminISK  *iskPerEur)/workDays : 0;

  const revenue = (Number.isFinite(producedKg_day)&&Number.isFinite(sellPriceDay_day))
    ? producedKg_day*sellPriceDay_day : NaN;

  const totalCost = laborStaff + laborSup + matCost + packCost + freight
                  + elecEURd + waterEURd + maintEURd + rentalsEURd + sparesEURd + otherEURd
                  + housingDay + equipDay + adminDay + deprEURd;

  const profit    = Number.isFinite(revenue)? revenue-totalCost : NaN;
  const marginPct = (Number.isFinite(revenue)&&revenue!==0)? (profit/revenue)*100 : NaN;
  const costPerKg = (Number.isFinite(producedKg_day)&&producedKg_day>0)? totalCost/producedKg_day : NaN;
  const yieldDay  = (Number.isFinite(producedKg_day)&&Number.isFinite(rawUsedKg_day)&&rawUsedKg_day>0)
    ? (producedKg_day/rawUsedKg_day)*100 : NaN;

  // Results
  setText('#day-yield',   Number.isFinite(yieldDay)? fmt(yieldDay,1)+' %':'–');
  setText('#day-revenue', fmt(revenue,2));
  setText('#day-total-cost', fmt(totalCost,2));
  setText('#day-profit',  fmt(profit,2));
  setText('#day-margin',  Number.isFinite(marginPct)? fmt(marginPct,1)+' %':'–');
  setText('#day-cost-kg', fmt(costPerKg,2));

  setText('#bd-labor-staff', fmt(laborStaff,2));
  setText('#bd-labor-sup',   fmt(laborSup,2));
  setText('#bd-material',    fmt(matCost,2));
  setText('#bd-pack',        fmt(packCost,2));
  setText('#bd-freight',     fmt(freight,2));

  setText('#bd-elec',        fmt(elecEURd,2));
  setText('#bd-water',       fmt(waterEURd,2));
  setText('#bd-maint',       fmt(maintEURd,2));
  setText('#bd-rentals',     fmt(rentalsEURd,2));
  setText('#bd-spares',      fmt(sparesEURd,2));
  setText('#bd-other',       fmt(otherEURd,2));

  setText('#bd-housing',     fmt(housingDay,2));
  setText('#bd-equip',       fmt(equipDay,2));
  setText('#bd-admin',       fmt(adminDay,2));
  setText('#bd-depr',        fmt(deprEURd,2));
}

/* ---------- wiring ---------- */
function attachSync(){
  const onChange=()=>{ syncUrlFromInputs(); calcKeyNumbers(); calcDay(); };
  qa('input,select').forEach(el=>{
    el.addEventListener('input',onChange);
    el.addEventListener('change',onChange);
  });
  // mark manual override of Working days
  q('#workingDays')?.addEventListener('input', e=>{ e.currentTarget.dataset.manual='1'; });
  q('#month')?.addEventListener('change', ()=>{
    refreshWorkingDaysFromMonth();
    calcDay(); syncUrlFromInputs();
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  initNumberFormatting();
  populateMonthSelect();
  refreshWorkingDaysFromMonth();

  applyQueryParams();

  // Pretty-format anything filled by URL
  qa('input[inputmode="decimal"],input[inputmode="numeric"]').forEach(formatPretty);

  attachSync();

  calcKeyNumbers();
  calcDay();
});
</script>
</body>
</html>
