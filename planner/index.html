<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Factory Planner — Key Numbers</title>
  <style>
    :root{
      --gap:14px;--pad:16px;
      --bg:#f6f8fc;--card:#ffffff;--ink:#0b1320;--muted:#4a5874;--accent:#0b5fff;--border:#e4e9f2;--field:#d6dbe6;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:24px var(--pad);border-bottom:1px solid var(--border)}
    h1{margin:0 0 6px;font-size:22px} h2{margin:0 0 10px;font-size:18px;color:var(--accent)}
    main{padding:20px var(--pad) 60px;display:grid;gap:14px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    label{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-weight:600}
    input{background:#fff;color:var(--ink);border:1px solid var(--field);border-radius:8px;padding:10px 12px;outline:none}
    input:focus{border-color:#2c6fff;box-shadow:0 0 0 2px rgba(44,111,255,.14)}
    .results{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0 0;padding:0;list-style:none}
    .results li{background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .results li span{color:var(--muted)} .results li strong{font-size:15px}
  </style>
</head>
<body>
  <header id="home">
    <h1>Factory Planner (white)</h1>
    <div class="muted">Type values or pass them via URL (commas as decimals are OK). The page auto-calculates and keeps the URL in sync.</div>
  </header>

  <main>
    <section class="card" id="key">
      <h2>Key Numbers</h2>
      <div class="grid">
        <label>Produced kg (net)<input id="producedKg" inputmode="decimal" /></label>
        <label>Selling price / kg<input id="sellPriceDay" inputmode="decimal" /></label>
        <label>Raw used kg<input id="rawUsedKg" inputmode="decimal" /></label>
        <label>Yield % (optional)<input id="yieldPct" inputmode="decimal" /></label>
        <label>Raw cost / kg<input id="rawCostPerKg" inputmode="decimal" /></label>
        <label>Pack cost / kg<input id="packCostPerKg" inputmode="decimal" /></label>
        <label>Freight / kg<input id="freightPerKg" inputmode="decimal" /></label>
      </div>
      <ul class="results">
        <li><span>Net saleable kg</span><strong id="key-net-kg">–</strong></li>
        <li><span>Revenue</span><strong id="key-revenue">–</strong></li>
        <li><span>Total cost</span><strong id="key-total-cost">–</strong></li>
        <li><span>Profit</span><strong id="key-profit">–</strong></li>
        <li><span>Gross margin %</span><strong id="key-gm">–</strong></li>
        <li><span>Profit / kg</span><strong id="key-profit-kg">–</strong></li>
        <li style="display:none"><span>Yield</span><strong id="key-yield">–</strong></li>
      </ul>
    </section>
  <!-- FACTORY DAY -->
<section class="card" id="day">
  <h2>Factory Day</h2>

  <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Labor</h3>
  <div class="grid">
    <label>Operators (count)<input id="staffCount" inputmode="numeric" /></label>
    <label>€/operator/hr<input id="staffCostPerPerson" inputmode="decimal" /></label>
    <label>Supervisors (count)<input id="supCount" inputmode="numeric" /></label>
    <label>€/supervisor/hr<input id="supCostPerPerson" inputmode="decimal" /></label>
    <label>Operator hours<input id="staffHoursDay" inputmode="decimal" value="8" /></label>
    <label>Supervisor hours<input id="supHoursDay" inputmode="decimal" value="8" /></label>
  </div>

  <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
  <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Materials & Production</h3>
  <div class="grid">
    <label>Raw used kg<input id="rawUsedKg_day" inputmode="decimal" /></label>
    <label>Raw cost / kg<input id="rawCostPerKg_day" inputmode="decimal" /></label>
    <label>Pack cost / kg<input id="packCostPerKg_day" inputmode="decimal" /></label>
    <label>Produced kg (net)<input id="producedKg_day" inputmode="decimal" /></label>
    <label>Selling price / kg<input id="sellPriceDay_day" inputmode="decimal" /></label>
    <label>Freight / kg<input id="freightPerKg_day" inputmode="decimal" /></label>
  </div>

  <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
  <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Utilities</h3>
  <div class="grid">
    <label>Electricity kWh<input id="elecKwh" inputmode="decimal" /></label>
    <label>€/kWh<input id="elecCostPerKwh" inputmode="decimal" /></label>
    <label>Water m³<input id="waterM3" inputmode="decimal" /></label>
    <label>€/m³<input id="waterCostPerM3" inputmode="decimal" /></label>
  </div>

  <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
  <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Fixed (ISK → EUR/day)</h3>
  <div class="grid">
    <label>ISK per EUR<input id="iskPerEur" inputmode="decimal" /></label>
    <label>Working days (auto if empty)<input id="workingDays" inputmode="numeric" /></label>
    <label>Housing (ISK/month)<input id="housingCost" inputmode="decimal" /></label>
    <label>Equipment (ISK/month)<input id="equipCost" inputmode="decimal" /></label>
    <label>Admin (ISK/month)<input id="adminCost" inputmode="decimal" /></label>
    <label>Maintenance (€/day)<input id="maintenanceCost" inputmode="decimal" /></label>
    <label>Depreciation (€/day)<input id="deprCost" inputmode="decimal" /></label>
    <label>Other (€/day)<input id="otherCost" inputmode="decimal" /></label>
    <label>Month (YYYY-MM)<input id="month" placeholder="2025-08" /></label>
  </div>

  <ul class="results">
    <li><span>Yield</span><strong id="day-yield">–</strong></li>
    <li><span>Revenue</span><strong id="day-revenue">–</strong></li>
    <li><span>Total cost</span><strong id="day-total-cost">–</strong></li>
    <li><span>Profit</span><strong id="day-profit">–</strong></li>
    <li><span>Gross margin %</span><strong id="day-margin">–</strong></li>
    <li><span>Cost / kg</span><strong id="day-cost-kg">–</strong></li>
  </ul>

  <h3 style="margin:10px 0 8px;color:#0b5fff;font-size:16px">Breakdown</h3>
  <ul class="results">
    <li><span>Labor (operators)</span><strong id="bd-labor-staff">–</strong></li>
    <li><span>Labor (supervisors)</span><strong id="bd-labor-sup">–</strong></li>
    <li><span>Material</span><strong id="bd-material">–</strong></li>
    <li><span>Pack</span><strong id="bd-pack">–</strong></li>
    <li><span>Freight</span><strong id="bd-freight">–</strong></li>
    <li><span>Utilities</span><strong id="bd-utilities">–</strong></li>
    <li><span>Housing €/day</span><strong id="bd-housing">–</strong></li>
    <li><span>Equipment €/day</span><strong id="bd-equip">–</strong></li>
    <li><span>Admin €/day</span><strong id="bd-admin">–</strong></li>
    <li><span>Maintenance €/day</span><strong id="bd-maint">–</strong></li>
    <li><span>Depreciation €/day</span><strong id="bd-depr">–</strong></li>
    <li><span>Other €/day</span><strong id="bd-other">–</strong></li>
  </ul>
</
  </main>

  <script>
    const locale='is-IS';
    const q=(s,r=document)=>r.querySelector(s);
    const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const setText=(sel,val)=>{const el=typeof sel==='string'?q(sel):sel;if(el)el.textContent=val;};
    function toNumber(v){ if(v==null)return NaN; const s=String(v).trim().replace(/\s/g,''); if(!s)return NaN;
      if(s.includes(',')&&!s.includes('.')) return Number(s.replace(/\./g,'').replace(',', '.'));
      return Number(s.replace(/,/g,'')); }
    const fmt=(n,d=2)=>Number.isFinite(n)?new Intl.NumberFormat(locale,{minimumFractionDigits:d,maximumFractionDigits:d}).format(n):'–';

    const bindings={producedKg:'#producedKg',sellPriceDay:'#sellPriceDay',rawUsedKg:'#rawUsedKg',yieldPct: '#yieldPct',rawCostPerKg:'#rawCostPerKg',packCostPerKg:'#packCostPerKg',freightPerKg:'#freightPerKg'};

    function applyQueryParams(){ const p=new URLSearchParams(location.search);
      for(const [k,sel] of Object.entries(bindings)){ const el=q(sel); if(!el) continue; const v=p.get(k); if(v!=null&&v!=='') el.value=decodeURIComponent(v); } }
    function syncUrlFromInputs(){ const p=new URLSearchParams();
      for(const [k,sel] of Object.entries(bindings)){ const el=q(sel); if(el&&el.value!=='') p.set(k,el.value); }
      history.replaceState(null,'',`${location.pathname}?${p.toString()}`); }
    function attachSync(){
  document.querySelectorAll('input, select, textarea').forEach(el => {
    el.addEventListener('input', () => {
      if (typeof syncUrlFromInputs === 'function') syncUrlFromInputs(); // safe guard
      calcKeyNumbers();
    });
  });
}


    function calcKeyNumbers(){
  const producedKg = toNumber(q('#producedKg')?.value);
  const sellPrice  = toNumber(q('#sellPriceDay')?.value);
  let   rawUsed    = toNumber(q('#rawUsedKg')?.value);
  const rawCost    = toNumber(q('#rawCostPerKg')?.value);
  const packCost   = toNumber(q('#packCostPerKg')?.value) || 0;
  const freight    = toNumber(q('#freightPerKg')?.value) || 0;
  let   yieldIn    = toNumber(q('#yieldPct')?.value);  // new

  const rawUsedEl = q('#rawUsedKg');
  const yieldEl   = q('#yieldPct');
  let changed = false;

  // If Raw used is empty but Yield % is provided → compute Raw used
  if (!Number.isFinite(rawUsed) && Number.isFinite(producedKg) && Number.isFinite(yieldIn) && yieldIn > 0) {
    const computedRaw = producedKg / (yieldIn / 100);
    rawUsedEl.value = String(Math.round(computedRaw));  // integer kg
    rawUsed = computedRaw;
    changed = true;
  }

  // If Yield % is empty but Raw used is provided → compute Yield %
  if (!Number.isFinite(yieldIn) && Number.isFinite(producedKg) && Number.isFinite(rawUsed) && rawUsed > 0) {
    const computedYield = (producedKg / rawUsed) * 100;
    yieldEl.value = computedYield.toFixed(1);           // 1 decimal
    yieldIn = computedYield;
    changed = true;
  }

  if (changed) syncUrlFromInputs();

  const yieldPct = Number.isFinite(yieldIn)
    ? yieldIn
    : (Number.isFinite(producedKg) && Number.isFinite(rawUsed) && rawUsed > 0)
        ? (producedKg / rawUsed) * 100
        : NaN;

  const revenue   = producedKg * sellPrice;
  const totalCost = producedKg * (rawCost + packCost + freight);
  const profit    = revenue - totalCost;
  const marginPct = revenue ? (profit / revenue) * 100 : NaN;
  const profitKg  = producedKg ? profit / producedKg : NaN;

  setText('#key-net-kg', fmt(producedKg, 0));
  setText('#key-revenue', fmt(revenue));
  setText('#key-total-cost', fmt(totalCost));
  setText('#key-profit', fmt(profit));
  setText('#key-gm', Number.isFinite(marginPct) ? fmt(marginPct, 1) + ' %' : '–');
  setText('#key-profit-kg', fmt(profitKg));
  setText('#key-yield', Number.isFinite(yieldPct) ? fmt(yieldPct, 1) + ' %' : '–');
}
  </script>
</body>
</html>
