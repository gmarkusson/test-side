<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Factory Planner — Key Numbers</title>
  <style>
    :root{
      --gap:14px;--pad:16px;
      --bg:#f6f8fc;--card:#ffffff;--ink:#0b1320;--muted:#4a5874;--accent:#0b5fff;--border:#e4e9f2;--field:#d6dbe6;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:24px var(--pad);border-bottom:1px solid var(--border)}
    h1{margin:0 0 6px;font-size:22px}
    h2{margin:0 0 10px;font-size:18px;color:var(--accent)}
    main{padding:20px var(--pad) 60px;display:grid;gap:14px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    label{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-weight:600}
    input,select{background:#fff;color:var(--ink);border:1px solid var(--field);border-radius:8px;padding:10px 12px;outline:none}
    input:focus,select:focus{border-color:#2c6fff;box-shadow:0 0 0 2px rgba(44,111,255,.14)}
    .results{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0 0;padding:0;list-style:none}
    .results li{background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .results li span{color:var(--muted)} .results li strong{font-size:15px}
    .actions{display:flex;gap:10px;margin-top:10px}
    .btn{display:inline-block;background:var(--accent);color:#fff;border:1px solid var(--accent);
      padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600}
    .btn:hover,.btn:focus{background:#094de8;border-color:#094de8}
  </style>
</head>
<body>
  <header id="home">
    <h1>Factory Planner</h1>
    <div class="muted">Type values or pass them via URL (commas as decimals are OK). The page auto-calculates and keeps the URL in sync.</div>
    <div class="actions">
      <a class="btn" href="fixed-costs.html">Fixed costs</a>
    </div>
  </header>

  <main>
    <section class="card" id="key">
      <h2>Key Numbers</h2>
      <div class="grid">
        <label>Produced kg (net)<input id="producedKg" inputmode="decimal" /></label>
        <label>Selling price / kg<input id="sellPriceDay" inputmode="decimal" /></label>
        <label>Raw used kg<input id="rawUsedKg" inputmode="decimal" /></label>
        <label>Yield % (optional)<input id="yieldPct" inputmode="decimal" /></label>
        <label>Raw cost / kg<input id="rawCostPerKg" inputmode="decimal" /></label>
        <label>Pack cost / kg<input id="packCostPerKg" inputmode="decimal" /></label>
        <label>Freight / kg<input id="freightPerKg" inputmode="decimal" /></label>
      </div>
      <ul class="results">
        <li><span>Net saleable kg</span><strong id="key-net-kg">–</strong></li>
        <li><span>Revenue</span><strong id="key-revenue">–</strong></li>
        <li><span>Total cost</span><strong id="key-total-cost">–</strong></li>
        <li><span>Profit</span><strong id="key-profit">–</strong></li>
        <li><span>Gross margin %</span><strong id="key-gm">–</strong></li>
        <li><span>Profit / kg</span><strong id="key-profit-kg">–</strong></li>
        <li style="display:none"><span>Yield</span><strong id="key-yield">–</strong></li>
      </ul>
    </section>

    <!-- FACTORY DAY -->
    <section class="card" id="day">
      <h2>Factory Day</h2>

      <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Labor</h3>
      <div class="grid">
        <label>Operators (count)<input id="staffCount" inputmode="numeric" /></label>
        <label>€/operator/hr<input id="staffCostPerPerson" inputmode="decimal" /></label>
        <label>Supervisors (count)<input id="supCount" inputmode="numeric" /></label>
        <label>€/supervisor/hr<input id="supCostPerPerson" inputmode="decimal" /></label>
        <label>Operator hours<input id="staffHoursDay" inputmode="decimal" value="8" /></label>
        <label>Supervisor hours<input id="supHoursDay" inputmode="decimal" value="8" /></label>
      </div>

      <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
      <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Materials & Production</h3>
      <div class="grid">
        <label>Raw used kg<input id="rawUsedKg_day" inputmode="decimal" /></label>
        <label>Raw cost / kg<input id="rawCostPerKg_day" inputmode="decimal" /></label>
        <label>Pack cost / kg<input id="packCostPerKg_day" inputmode="decimal" /></label>
        <label>Produced kg (net)<input id="producedKg_day" inputmode="decimal" /></label>
        <label>Selling price / kg<input id="sellPriceDay_day" inputmode="decimal" /></label>
        <label>Freight / kg<input id="freightPerKg_day" inputmode="decimal" /></label>
      </div>

      <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
      <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Fixed (ISK → EUR/day)</h3>
      <div class="grid">
        <label>ISK per EUR<input id="iskPerEur" inputmode="decimal" /></label>
        <label>Working days (auto if empty)<input id="workingDays" inputmode="numeric" /></label>
        <label>Housing (ISK/month)<input id="housingCost" inputmode="decimal" /></label>
        <label>Equipment (ISK/month)<input id="equipCost" inputmode="decimal" /></label>
        <label>Admin (ISK/month)<input id="adminCost" inputmode="decimal" /></label>
        <label>Depreciation (€/day)<input id="deprCost" inputmode="decimal" /></label>
        <label>Month
          <select id="month"></select>
        </label>
      </div>

      <ul class="results">
        <li><span>Yield</span><strong id="day-yield">–</strong></li>
        <li><span>Revenue</span><strong id="day-revenue">–</strong></li>
        <li><span>Total cost</span><strong id="day-total-cost">–</strong></li>
        <li><span>Profit</span><strong id="day-profit">–</strong></li>
        <li><span>Gross margin %</span><strong id="day-margin">–</strong></li>
        <li><span>Cost / kg</span><strong id="day-cost-kg">–</strong></li>
      </ul>

      <h3 style="margin:10px 0 8px;color:#0b5fff;font-size:16px">Breakdown</h3>
      <ul class="results">
        <li><span>Labor (operators)</span><strong id="bd-labor-staff">–</strong></li>
        <li><span>Labor (supervisors)</span><strong id="bd-labor-sup">–</strong></li>
        <li><span>Material</span><strong id="bd-material">–</strong></li>
        <li><span>Pack</span><strong id="bd-pack">–</strong></li>
        <li><span>Freight</span><strong id="bd-freight">–</strong></li>
        <li><span>Electricity €/day</span><strong id="bd-elec">–</strong></li>
        <li><span>Water €/day</span><strong id="bd-water">–</strong></li>
        <li><span>Maintenance €/day</span><strong id="bd-maint">–</strong></li>
        <li><span>Rentals €/day</span><strong id="bd-rentals">–</strong></li>
        <li><span>Spare parts €/day</span><strong id="bd-spares">–</strong></li>
        <li><span>Other €/day</span><strong id="bd-other">–</strong></li>
        <li><span>Housing €/day</span><strong id="bd-housing">–</strong></li>
        <li><span>Equipment €/day</span><strong id="bd-equip">–</strong></li>
        <li><span>Admin €/day</span><strong id="bd-admin">–</strong></li>
        <li><span>Depreciation €/day</span><strong id="bd-depr">–</strong></li>
      </ul>
    </section>
  </main>

  <script>
  const locale='is-IS';
  const q=(s,r=document)=>r.querySelector(s);
  const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const setText=(sel,val)=>{const el=typeof sel==='string'?q(sel):sel;if(el)el.textContent=val;};
  const fmt=(n,d=2)=>Number.isFinite(n)? new Intl.NumberFormat(locale,{minimumFractionDigits:d,maximumFractionDigits:d}).format(n) : '–';

  function toNumber(v){
    if(v==null) return NaN;
    let s=String(v).trim().replace(/\u00A0/g,'').replace(/\s/g,'');
    if(!s) return NaN;
    const hasC=s.includes(','), hasD=s.includes('.');
    if(hasC&&hasD){ if(s.lastIndexOf(',')>s.lastIndexOf('.')) s=s.replace(/\./g,'').replace(',', '.'); else s=s.replace(/,/g,''); }
    else if(hasC){ const parts=s.split(','), thousands=parts.length>1&&parts.every((p,i)=>(i===0?p.length<=3:p.length===3)); s=thousands?s.replace(/,/g,''):s.replace(',', '.'); }
    else if(hasD){ const parts=s.split('.'), thousands=parts.length>1&&parts.every((p,i)=>(i===0?p.length<=3:p.length===3)); if(thousands) s=s.replace(/\./g,''); }
    const n=Number(s); return Number.isFinite(n)? n : NaN;
  }

  const bindings={
    producedKg:'#producedKg', sellPriceDay:'#sellPriceDay', rawUsedKg:'#rawUsedKg', yieldPct:'#yieldPct',
    rawCostPerKg:'#rawCostPerKg', packCostPerKg:'#packCostPerKg', freightPerKg:'#freightPerKg',
    month:'#month', workingDays:'#workingDays',
    iskPerEur:'#iskPerEur', housingCost:'#housingCost', equipCost:'#equipCost', adminCost:'#adminCost', deprCost:'#deprCost'
  };

  function applyQueryParams(){
    const p = new URLSearchParams(location.search);
    for (const [k, sel] of Object.entries(bindings)) {
      const el = q(sel); if (!el) continue;
      let v = p.get(k);
      if (v == null || v === '') continue;
      if (k === 'month') {
        if (/^\d{4}-\d{2}$/.test(v)) v = v.slice(5);
        if (/^\d{1,2}$/.test(v))     v = v.padStart(2,'0');
        el.value = v;
      } else {
        el.value = decodeURIComponent(v);
      }
    }
  }
  function syncUrlFromInputs(){
    const p = new URLSearchParams(location.search);
    for (const [k, sel] of Object.entries(bindings)) {
      const el = q(sel);
      if (el && el.value !== '') p.set(k, el.value); else p.delete(k);
    }
    history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
  }

  function applyMonthlyParamsToDaily() {
    const p = new URLSearchParams(location.search);
    const maintEl = document.getElementById('maintenanceCost');
    const otherEl = document.getElementById('otherCost');
    if (!maintEl || !otherEl) return;
    if (maintEl.value && otherEl.value) return;

    let wd = toNumber(document.getElementById('workingDays')?.value);
    if (!Number.isFinite(wd)) {
      const m = document.getElementById('month')?.value;
      wd = Number.isFinite(workingDaysInMonth?.(m)) ? workingDaysInMonth(m) : 22;
    }

    const toN = (k) => toNumber(p.get(k));
    const maintMonth = (toN('maintEurMonth') || 0) + (toN('sparesEurMonth') || 0);
    const otherMonth = (toN('rentalsEurMonth') || 0)
                     + (toN('electricityEurMonth') || 0)
                     + (toN('waterEurMonth') || 0)
                     + (toN('otherEurMonth') || 0);

    if (Number.isFinite(wd) && wd > 0) {
      if (!maintEl.value && maintMonth) maintEl.value = (maintMonth / wd).toFixed(2);
      if (!otherEl.value && otherMonth) otherEl.value = (otherMonth / wd).toFixed(2);
    }
  }

  // One LS_PREFIX only
  const LS_PREFIX='fp:';
  function getParamOrStoreNum(param, storeKey=param){
    const p = new URLSearchParams(location.search);
    const v = p.get(param);
    if (v!=null && v!=='') { const n=toNumber(v); if(Number.isFinite(n)) return n; }
    const s = localStorage.getItem(LS_PREFIX + storeKey);
    const n = toNumber(s);
    return Number.isFinite(n) ? n : 0;
  }

  function workingDaysInMonth(val){
    let y,m;
    if(/^\d{2}$/.test(val)){ y=new Date().getFullYear(); m=Number(val); }
    else if(/^\d{4}-\d{2}$/.test(val)){ [y,m]=val.split('-').map(Number); }
    else return NaN;
    const end=new Date(y,m,0).getDate();
    let days=0;
    for(let d=1; d<=end; d++){
      const dow=new Date(y,m-1,d).getDay();
      if(dow!==0 && dow!==6) days++;
    }
    return days;
  }

  const nfIntIS=new Intl.NumberFormat('is-IS',{maximumFractionDigits:0});
  function formatIntInput(el){ if(!el) return; const n=toNumber(el.value); if(Number.isFinite(n)) el.value=nfIntIS.format(Math.round(n)); }

  /* calcKeyNumbers ... (unchanged) */
  /* calcDay ... (unchanged) */
  /* populateMonthSelect ... (unchanged) */

  function loadDefaultsFromStorage() {
    const ids = [
      'iskPerEur','workingDays',
      'housingCost','equipCost','adminCost',
      'deprCost' // keep only existing fields
    ];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.value !== '' && el.value != null) return;
      const v = localStorage.getItem(LS_PREFIX + id);
      if (v != null && v !== '') el.value = v;
    });

    // derive €/day if you still have maintenanceCost/otherCost inputs
    const wdBox = document.getElementById('workingDays');
    let wd = toNumber(wdBox?.value);
    if (!Number.isFinite(wd)) {
      const m = document.getElementById('month')?.value;
      wd = Number.isFinite(workingDaysInMonth?.(m)) ? workingDaysInMonth(m) : 22;
      if (wdBox && !wdBox.value) wdBox.value = String(wd);
    }
    const getM = (k) => toNumber(localStorage.getItem(LS_PREFIX + k));
    const maintMonth = (getM('maintEurMonth') || 0) + (getM('sparesEurMonth') || 0);
    const otherMonth = (getM('rentalsEurMonth') || 0)
                     + (getM('electricityEurMonth') || 0)
                     + (getM('waterEurMonth') || 0)
                     + (getM('otherEurMonth') || 0);
    const maintEl = document.getElementById('maintenanceCost');
    const otherEl = document.getElementById('otherCost');
    if (maintEl && !maintEl.value && wd>0) maintEl.value = (maintMonth/wd).toFixed(2);
    if (otherEl && !otherEl.value && wd>0) otherEl.value = (otherMonth/wd).toFixed(2);
  }

  function attachSync(){
    const onChange = () => { syncUrlFromInputs(); calcKeyNumbers(); calcDay(); };
    qa('input, select, textarea').forEach(el => {
      el.addEventListener('input', onChange);
      el.addEventListener('change', onChange);
    });
    const monthSel = q('#month');
    monthSel?.addEventListener('change', () => {
      const wdBox = q('#workingDays');
      if (wdBox && !wdBox.value) {
        const wd = workingDaysInMonth(monthSel.value);
        if (Number.isFinite(wd)) wdBox.value = String(wd);
      }
      onChange();
    });
    ['#producedKg','#rawUsedKg','#producedKg_day','#rawUsedKg_day'].forEach(sel=>{
      const el=q(sel); el?.addEventListener('blur',()=>formatIntInput(el));
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    populateMonthSelect();
    applyQueryParams();
    loadDefaultsFromStorage();
    applyMonthlyParamsToDaily();
    attachSync();
    calcKeyNumbers();
    calcDay();
  });
</script>

</body>
</html>
