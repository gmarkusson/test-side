<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Factory Planner — Key Numbers</title>
  <style>
    :root{
      --gap:14px;--pad:16px;
      --bg:#f6f8fc;--card:#ffffff;--ink:#0b1320;--muted:#4a5874;--accent:#0b5fff;--border:#e4e9f2;--field:#d6dbe6;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:24px var(--pad);border-bottom:1px solid var(--border)}
    h1{margin:0 0 6px;font-size:22px} h2{margin:0 0 10px;font-size:18px;color:var(--accent)}
    main{padding:20px var(--pad) 60px;display:grid;gap:14px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    label{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-weight:600}
   input,select{background:#fff;color:var(--ink);border:1px solid var(--field);border-radius:8px;padding:10px 12px;outline:none}
   input:focus,select:focus{border-color:#2c6fff;box-shadow:0 0 0 2px rgba(44,111,255,.14)}
    .results{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0 0;padding:0;list-style:none}
    .results li{background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .results li span{color:var(--muted)} .results li strong{font-size:15px}
  </style>
</head>
<body>
  <header id="home">
    <h1>Factory Planner (white)</h1>
    <div class="muted">Type values or pass them via URL (commas as decimals are OK). The page auto-calculates and keeps the URL in sync.</div>
  </header>

  <main>
    <section class="card" id="key">
      <h2>Key Numbers</h2>
      <div class="grid">
        <label>Produced kg (net)<input id="producedKg" inputmode="decimal" /></label>
        <label>Selling price / kg<input id="sellPriceDay" inputmode="decimal" /></label>
        <label>Raw used kg<input id="rawUsedKg" inputmode="decimal" /></label>
        <label>Yield % (optional)<input id="yieldPct" inputmode="decimal" /></label>
        <label>Raw cost / kg<input id="rawCostPerKg" inputmode="decimal" /></label>
        <label>Pack cost / kg<input id="packCostPerKg" inputmode="decimal" /></label>
        <label>Freight / kg<input id="freightPerKg" inputmode="decimal" /></label>
      </div>
      <ul class="results">
        <li><span>Net saleable kg</span><strong id="key-net-kg">–</strong></li>
        <li><span>Revenue</span><strong id="key-revenue">–</strong></li>
        <li><span>Total cost</span><strong id="key-total-cost">–</strong></li>
        <li><span>Profit</span><strong id="key-profit">–</strong></li>
        <li><span>Gross margin %</span><strong id="key-gm">–</strong></li>
        <li><span>Profit / kg</span><strong id="key-profit-kg">–</strong></li>
        <li style="display:none"><span>Yield</span><strong id="key-yield">–</strong></li>
      </ul>
    </section>
  <!-- FACTORY DAY -->
<section class="card" id="day">
  <h2>Factory Day</h2>

  <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Labor</h3>
  <div class="grid">
    <label>Operators (count)<input id="staffCount" inputmode="numeric" /></label>
    <label>€/operator/hr<input id="staffCostPerPerson" inputmode="decimal" /></label>
    <label>Supervisors (count)<input id="supCount" inputmode="numeric" /></label>
    <label>€/supervisor/hr<input id="supCostPerPerson" inputmode="decimal" /></label>
    <label>Operator hours<input id="staffHoursDay" inputmode="decimal" value="8" /></label>
    <label>Supervisor hours<input id="supHoursDay" inputmode="decimal" value="8" /></label>
  </div>

  <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
  <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Materials & Production</h3>
  <div class="grid">
    <label>Raw used kg<input id="rawUsedKg_day" inputmode="decimal" /></label>
    <label>Raw cost / kg<input id="rawCostPerKg_day" inputmode="decimal" /></label>
    <label>Pack cost / kg<input id="packCostPerKg_day" inputmode="decimal" /></label>
    <label>Produced kg (net)<input id="producedKg_day" inputmode="decimal" /></label>
    <label>Selling price / kg<input id="sellPriceDay_day" inputmode="decimal" /></label>
    <label>Freight / kg<input id="freightPerKg_day" inputmode="decimal" /></label>
  </div>

  <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
  <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Utilities</h3>
  <div class="grid">
    <label>Electricity kWh<input id="elecKwh" inputmode="decimal" /></label>
    <label>€/kWh<input id="elecCostPerKwh" inputmode="decimal" /></label>
    <label>Water m³<input id="waterM3" inputmode="decimal" /></label>
    <label>€/m³<input id="waterCostPerM3" inputmode="decimal" /></label>
  </div>

  <div style="height:1px;background:#e4e9f2;margin:10px 0"></div>
  <h3 style="margin:0 0 8px;color:#0b5fff;font-size:16px">Fixed (ISK → EUR/day)</h3>
  <div class="grid">
    <label>ISK per EUR<input id="iskPerEur" inputmode="decimal" /></label>
    <label>Working days (auto if empty)<input id="workingDays" inputmode="numeric" /></label>
    <label>Housing (ISK/month)<input id="housingCost" inputmode="decimal" /></label>
    <label>Equipment (ISK/month)<input id="equipCost" inputmode="decimal" /></label>
    <label>Admin (ISK/month)<input id="adminCost" inputmode="decimal" /></label>
    <label>Maintenance (€/day)<input id="maintenanceCost" inputmode="decimal" /></label>
    <label>Depreciation (€/day)<input id="deprCost" inputmode="decimal" /></label>
    <label>Other (€/day)<input id="otherCost" inputmode="decimal" /></label>
<label>Month
  <select id="month"></select>
</label>

  </div>

  <ul class="results">
    <li><span>Yield</span><strong id="day-yield">–</strong></li>
    <li><span>Revenue</span><strong id="day-revenue">–</strong></li>
    <li><span>Total cost</span><strong id="day-total-cost">–</strong></li>
    <li><span>Profit</span><strong id="day-profit">–</strong></li>
    <li><span>Gross margin %</span><strong id="day-margin">–</strong></li>
    <li><span>Cost / kg</span><strong id="day-cost-kg">–</strong></li>
  </ul>

  <h3 style="margin:10px 0 8px;color:#0b5fff;font-size:16px">Breakdown</h3>
  <ul class="results">
    <li><span>Labor (operators)</span><strong id="bd-labor-staff">–</strong></li>
    <li><span>Labor (supervisors)</span><strong id="bd-labor-sup">–</strong></li>
    <li><span>Material</span><strong id="bd-material">–</strong></li>
    <li><span>Pack</span><strong id="bd-pack">–</strong></li>
    <li><span>Freight</span><strong id="bd-freight">–</strong></li>
    <li><span>Utilities</span><strong id="bd-utilities">–</strong></li>
    <li><span>Housing €/day</span><strong id="bd-housing">–</strong></li>
    <li><span>Equipment €/day</span><strong id="bd-equip">–</strong></li>
    <li><span>Admin €/day</span><strong id="bd-admin">–</strong></li>
    <li><span>Maintenance €/day</span><strong id="bd-maint">–</strong></li>
    <li><span>Depreciation €/day</span><strong id="bd-depr">–</strong></li>
    <li><span>Other €/day</span><strong id="bd-other">–</strong></li>
  </ul>
</section>
  </main>
<script>
const locale='is-IS';
const q=(s,r=document)=>r.querySelector(s);
const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));
const setText=(sel,val)=>{const el=typeof sel==='string'?q(sel):sel;if(el)el.textContent=val;};

// Robust number parser
function toNumber(v){
  if(v==null) return NaN;
  let s=String(v).trim().replace(/\u00A0/g,'').replace(/\s/g,'');
  if(!s) return NaN;
  const hasComma=s.includes(','), hasDot=s.includes('.');
  if(hasComma&&hasDot){
    if(s.lastIndexOf(',')>s.lastIndexOf('.')) s=s.replace(/\./g,'').replace(',', '.');
    else s=s.replace(/,/g,'');
  }else if(hasComma){
    const parts=s.split(','), looksThousands=parts.length>1 && parts.every((p,i)=>(i===0?p.length<=3:p.length===3));
    s=looksThousands? s.replace(/,/g,'') : s.replace(',', '.');
  }else if(hasDot){
    const parts=s.split('.'), looksThousands=parts.length>1 && parts.every((p,i)=>(i===0?p.length<=3:p.length===3));
    if(looksThousands) s=s.replace(/\./g,'');
  }
  const n=Number(s);
  return Number.isFinite(n)? n : NaN;
}

const fmt=(n,d=2)=>Number.isFinite(n)? new Intl.NumberFormat(locale,{minimumFractionDigits:d,maximumFractionDigits:d}).format(n) : '–';

// URL bindings (include month & workingDays so they sync)
const bindings={
  producedKg:'#producedKg', sellPriceDay:'#sellPriceDay', rawUsedKg:'#rawUsedKg', yieldPct:'#yieldPct',
  rawCostPerKg:'#rawCostPerKg', packCostPerKg:'#packCostPerKg', freightPerKg:'#freightPerKg',
  month:'#month', workingDays:'#workingDays'
};

function applyQueryParams(){
  const p = new URLSearchParams(location.search);
  for (const [k, sel] of Object.entries(bindings)) {
    const el = q(sel); if (!el) continue;
    let v = p.get(k);
    if (v == null || v === '') continue;

    if (k === 'month') {
      // Accept ?month=2025-08, 8, 08 — normalize to "MM"
      if (/^\d{4}-\d{2}$/.test(v)) v = v.slice(5);     // "2025-08" -> "08"
      if (/^\d{1,2}$/.test(v))     v = v.padStart(2,'0'); // "8" -> "08"
      el.value = v; // your <select> options are "01".."12"
    } else {
      el.value = decodeURIComponent(v);
    }
  }
}
function syncUrlFromInputs(){
  const p = new URLSearchParams();
  for (const [k, sel] of Object.entries(bindings)) {
    const el = q(sel);
    if (el && el.value !== '') p.set(k, el.value);
  }
  history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
}

let lastEdited=null;

function attachSync(){
  // 'input' listeners
  qa('input, select, textarea').forEach(el=>{
    el.addEventListener('input',()=>{
      if(el.id==='yieldPct') lastEdited='yield';
      else if(el.id==='rawUsedKg') lastEdited='raw';
      syncUrlFromInputs();
      calcKeyNumbers();
      calcDay();
    });
  });
  // 'change' listeners (some browsers don’t fire input for <select>)
  qa('select').forEach(el=>{
    el.addEventListener('change',()=>{
      // Special: when month changes, clear working days so we auto-fill
      if(el.id==='month'){ const wd=q('#workingDays'); if(wd) wd.value=''; }
      syncUrlFromInputs();
      calcKeyNumbers();
      calcDay();
    });
  });

  // integer blur formatting
  q('#producedKg')?.addEventListener('blur',()=>formatIntInput(q('#producedKg')));
  q('#rawUsedKg')?.addEventListener('blur',()=>formatIntInput(q('#rawUsedKg')));
  q('#producedKg_day')?.addEventListener('blur',()=>formatIntInput(q('#producedKg_day')));
  q('#rawUsedKg_day')?.addEventListener('blur',()=>formatIntInput(q('#rawUsedKg_day')));
}

const nfIntIS=new Intl.NumberFormat('is-IS',{maximumFractionDigits:0});
function formatIntInput(el){ if(!el) return; const n=toNumber(el.value); if(Number.isFinite(n)) el.value=nfIntIS.format(Math.round(n)); }

// Key Numbers
function calcKeyNumbers(){
  const producedKg=toNumber(q('#producedKg').value);
  const sellPrice =toNumber(q('#sellPriceDay').value);
  let   rawUsed   =toNumber(q('#rawUsedKg').value);
  const rawCost   =toNumber(q('#rawCostPerKg').value);
  const packCost  =toNumber(q('#packCostPerKg').value)||0;
  const freight   =toNumber(q('#freightPerKg').value)||0;
  let   yieldIn   =toNumber(q('#yieldPct').value);

  const rawUsedEl=q('#rawUsedKg'); const yieldEl=q('#yieldPct'); let changed=false;

  if(Number.isFinite(producedKg)){
    if(Number.isFinite(yieldIn)&&yieldIn>0 && (lastEdited==='yield'||!Number.isFinite(rawUsed))){
      const computedRaw=producedKg/(yieldIn/100);
      rawUsed=computedRaw;
      if(rawUsedEl){ rawUsedEl.value=String(Math.round(computedRaw)); formatIntInput(rawUsedEl); }
      changed=true;
    }else if(Number.isFinite(rawUsed)&&rawUsed>0 && (lastEdited==='raw'||!Number.isFinite(yieldIn))){
      const computedYield=(producedKg/rawUsed)*100;
      yieldIn=computedYield;
      if(yieldEl) yieldEl.value=computedYield.toFixed(1);
      changed=true;
    }
  }
  if(changed) syncUrlFromInputs();

  const yieldPct=Number.isFinite(yieldIn)? yieldIn
    : (Number.isFinite(producedKg)&&Number.isFinite(rawUsed)&&rawUsed>0)? (producedKg/rawUsed)*100 : NaN;

  // revenue
const revenue = producedKg * sellPrice;

// costs (raw depends on rawUsed; pack & freight depend on producedKg)
const rawMatCost = (Number.isFinite(rawUsed) && Number.isFinite(rawCost))
  ? rawUsed * rawCost
  : NaN;

const packC    = Number.isFinite(producedKg) ? producedKg * packCost : 0;
const freightC = Number.isFinite(producedKg) ? producedKg * freight  : 0;

const totalCost = (Number.isFinite(rawMatCost) ? rawMatCost : 0) + packC + freightC;

// profit & ratios
const profit    = Number.isFinite(revenue) ? revenue - totalCost : NaN;
const marginPct = Number.isFinite(revenue) && revenue !== 0 ? (profit / revenue) * 100 : NaN;
const profitKg  = Number.isFinite(producedKg) && producedKg > 0 ? profit / producedKg : NaN;


  setText('#key-net-kg', fmt(producedKg,0));
  setText('#key-revenue', fmt(revenue));
  setText('#key-total-cost', fmt(totalCost));
  setText('#key-profit', fmt(profit));
  setText('#key-gm', Number.isFinite(marginPct)? fmt(marginPct,1)+' %':'–');
  setText('#key-profit-kg', fmt(profitKg));
  setText('#key-yield', Number.isFinite(yieldPct)? fmt(yieldPct,1)+' %':'–');
}

// --- Factory Day helpers ---
function workingDaysInMonth(val){
  let y,m;
  if(/^\d{2}$/.test(val)){ y=new Date().getFullYear(); m=Number(val); }          // "08"
  else if(/^\d{4}-\d{2}$/.test(val)){ [y,m]=val.split('-').map(Number); }        // "2025-08"
  else return NaN;

  const end=new Date(y,m,0).getDate();
  let days=0;
  for(let d=1; d<=end; d++){
    const dow=new Date(y,m-1,d).getDay(); // 0=Sun..6=Sat
    if(dow!==0 && dow!==6) days++;
  }
  return days;
}

function calcDay(){
  // Labor
  const staffCount=toNumber(q('#staffCount').value);
  const staffHr   =toNumber(q('#staffHoursDay').value);
  const staffRate =toNumber(q('#staffCostPerPerson').value);

  const supCount  =toNumber(q('#supCount').value);
  const supHr     =toNumber(q('#supHoursDay').value);
  const supRate   =toNumber(q('#supCostPerPerson').value);

  // Materials & Production
  const rawUsedKg_day    =toNumber(q('#rawUsedKg_day').value);
  const rawCostPerKg_day =toNumber(q('#rawCostPerKg_day').value);
  const packCostPerKg_day=toNumber(q('#packCostPerKg_day').value);
  const producedKg_day   =toNumber(q('#producedKg_day').value);
  const sellPriceDay_day =toNumber(q('#sellPriceDay_day').value);
  const freightPerKg_day =toNumber(q('#freightPerKg_day').value);

  // Utilities
  const elecKwh        =toNumber(q('#elecKwh').value);
  const elecCostPerKwh =toNumber(q('#elecCostPerKwh').value);
  const waterM3        =toNumber(q('#waterM3').value);
  const waterCostPerM3 =toNumber(q('#waterCostPerM3').value);

  // Fixed (ISK→EUR/day)
  const iskPerEur      =toNumber(q('#iskPerEur').value);
  let   workDays       =toNumber(q('#workingDays').value);
  const monthStr       =q('#month').value?.trim();

  // Auto-calc working days if empty/invalid
  if(!Number.isFinite(workDays) && monthStr){
    const wd=workingDaysInMonth(monthStr);
    if(Number.isFinite(wd)){ workDays=wd; q('#workingDays').value=String(wd); }
  }

  const housingISK=toNumber(q('#housingCost').value);
  const equipISK  =toNumber(q('#equipCost').value);
  const adminISK  =toNumber(q('#adminCost').value);

  const maintEURday=toNumber(q('#maintenanceCost').value);
  const deprEURday =toNumber(q('#deprCost').value);
  const otherEURday=toNumber(q('#otherCost').value);

  // Yields & revenue
  const yieldDay = (Number.isFinite(producedKg_day)&&Number.isFinite(rawUsedKg_day)&&rawUsedKg_day>0)
    ? (producedKg_day/rawUsedKg_day)*100 : NaN;
  const revenue = (Number.isFinite(producedKg_day)&&Number.isFinite(sellPriceDay_day))
    ? producedKg_day*sellPriceDay_day : NaN;

  // Labor €/day
  const laborStaff=(Number.isFinite(staffCount)&&Number.isFinite(staffHr)&&Number.isFinite(staffRate))
    ? staffCount*staffHr*staffRate : 0;
  const laborSup  =(Number.isFinite(supCount)&&Number.isFinite(supHr)&&Number.isFinite(supRate))
    ? supCount*supHr*supRate : 0;

  // Materials, pack, freight
  const matCost =(Number.isFinite(rawUsedKg_day)&&Number.isFinite(rawCostPerKg_day)) ? rawUsedKg_day*rawCostPerKg_day : 0;
  const packCost=(Number.isFinite(producedKg_day)&&Number.isFinite(packCostPerKg_day))? producedKg_day*packCostPerKg_day : 0;
  const freight =(Number.isFinite(producedKg_day)&&Number.isFinite(freightPerKg_day))? producedKg_day*freightPerKg_day : 0;

  // Utilities
  const utilities =
      (Number.isFinite(elecKwh)&&Number.isFinite(elecCostPerKwh)? elecKwh*elecCostPerKwh : 0)
    + (Number.isFinite(waterM3)&&Number.isFinite(waterCostPerM3)? waterM3*waterCostPerM3 : 0);

  // Fixed (ISK/month → EUR/day)
  const canFX   = Number.isFinite(iskPerEur) && Number.isFinite(workDays) && workDays>0;
  const housingDay = canFX&&Number.isFinite(housingISK)? (housingISK*iskPerEur)/workDays : 0;
  const equipDay   = canFX&&Number.isFinite(equipISK)  ? (equipISK  *iskPerEur)/workDays : 0;
  const adminDay   = canFX&&Number.isFinite(adminISK)  ? (adminISK  *iskPerEur)/workDays : 0;

  const totalCost = laborStaff + laborSup + matCost + packCost + freight
                  + utilities + housingDay + equipDay + adminDay
                  + (Number.isFinite(maintEURday)? maintEURday:0)
                  + (Number.isFinite(deprEURday) ? deprEURday :0)
                  + (Number.isFinite(otherEURday)? otherEURday:0);

  const profit    = Number.isFinite(revenue)? revenue-totalCost : NaN;
  const marginPct = (Number.isFinite(revenue)&&revenue!==0)? (profit/revenue)*100 : NaN;
  const costPerKg = (Number.isFinite(producedKg_day)&&producedKg_day>0)? totalCost/producedKg_day : NaN;

  // Outputs
  setText('#day-yield',   Number.isFinite(yieldDay)? fmt(yieldDay,1)+' %':'–');
  setText('#day-revenue', fmt(revenue));
  setText('#day-total-cost', fmt(totalCost));
  setText('#day-profit',  fmt(profit));
  setText('#day-margin',  Number.isFinite(marginPct)? fmt(marginPct,1)+' %':'–');
  setText('#day-cost-kg', fmt(costPerKg));

  // Breakdown
  setText('#bd-labor-staff', fmt(laborStaff));
  setText('#bd-labor-sup',   fmt(laborSup));
  setText('#bd-material',    fmt(matCost));
  setText('#bd-pack',        fmt(packCost));
  setText('#bd-freight',     fmt(freight));
  setText('#bd-utilities',   fmt(utilities));
  setText('#bd-housing',     fmt(housingDay));
  setText('#bd-equip',       fmt(equipDay));
  setText('#bd-admin',       fmt(adminDay));
  setText('#bd-maint',       fmt(Number.isFinite(maintEURday)? maintEURday:NaN));
  setText('#bd-depr',        fmt(Number.isFinite(deprEURday) ? deprEURday :NaN));
  setText('#bd-other',       fmt(Number.isFinite(otherEURday)? otherEURday:NaN));
}

function populateMonthSelect(){
  const sel = q('#month'); if (!sel) return;
  sel.innerHTML = '';

  for (let i = 0; i < 12; i++) {
    const label = new Date(2000, i, 1).toLocaleString('en', { month: 'long' });
    const m = String(i + 1).padStart(2, '0');   // "01".."12"
    const opt = document.createElement('option');
    opt.value = m;
    opt.textContent = label;
    sel.appendChild(opt);
  }

  // Default to current month unless URL already set it
  if (!sel.value) sel.value = String(new Date().getMonth() + 1).padStart(2, '0');

  // >>> NEW: fill Working days right now <<<
  const wdBox = q('#workingDays');
  if (wdBox && (!wdBox.value || !Number.isFinite(toNumber(wdBox.value)))) {
    const wd = workingDaysInMonth(sel.value);   // sel.value is "MM"
    if (Number.isFinite(wd)) wdBox.value = String(wd);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  populateMonthSelect();      // build 12-month dropdown
  applyQueryParams?.();       // read ?month, ?workingDays, etc.

  // Prefill Working days from the selected month (if empty)
  const m = q('#month')?.value;          // "MM"
  const wdBox = q('#workingDays');
  if (m && wdBox && !wdBox.value) {
    const wd = workingDaysInMonth(m);
    if (Number.isFinite(wd)) wdBox.value = String(wd);
  }

  attachSync();               // wire up listeners
  calcKeyNumbers();           // initial calc
  calcDay();                  // also fills Working days if still empty
});

</script>

</body>
</html>
