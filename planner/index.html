<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Factory Planner — Key Numbers</title>
  <style>
    :root{
      --gap:14px;--pad:16px;
      --bg:#f6f8fc;--card:#ffffff;--ink:#0b1320;--muted:#4a5874;--accent:#0b5fff;--border:#e4e9f2;--field:#d6dbe6;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:24px var(--pad);border-bottom:1px solid var(--border)}
    h1{margin:0 0 6px;font-size:22px}
    h2{margin:0 0 10px;font-size:18px;color:var(--accent)}
    main{padding:20px var(--pad) 60px;display:grid;gap:14px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    label{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-weight:600}
    input,select{background:#fff;color:var(--ink);border:1px solid var(--field);border-radius:8px;padding:10px 12px;outline:none}
    input:focus,select:focus{border-color:#2c6fff;box-shadow:0 0 0 2px rgba(44,111,255,.14)}
    .results{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0 0;padding:0;list-style:none}
    .results li{background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .results li span{color:var(--muted)} .results li strong{font-size:15px}
    .actions{display:flex;gap:10px;margin-top:10px}
    .btn{display:inline-block;background:var(--accent);color:#fff;border:1px solid var(--accent);
      padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600}
    .btn:hover,.btn:focus{background:#094de8;border-color:#094de8}
  </style>
</head>
<body>
<header>
  <h1>Factory Planner</h1>
  <div class="muted">Type values or pass them via URL (commas as decimals are OK). Auto-calculates and keeps the URL in sync.</div>
  <div class="actions">
    <a class="btn" href="fixed-costs.html">Fixed costs</a>
  </div>
</header>

<main>
  <!-- Key Numbers -->
  <section class="card">
    <h2>Key Numbers</h2>
    <div class="grid">
      <label>Produced kg (net)<input id="producedKg" inputmode="decimal"></label>
      <label>Selling price / kg<input id="sellPriceDay" inputmode="decimal"></label>
      <label>Raw used kg<input id="rawUsedKg" inputmode="decimal"></label>
      <label>Yield % (optional)<input id="yieldPct" inputmode="decimal"></label>
      <label>Raw cost / kg<input id="rawCostPerKg" inputmode="decimal"></label>
      <label>Pack cost / kg<input id="packCostPerKg" inputmode="decimal"></label>
      <label>Freight / kg<input id="freightPerKg" inputmode="decimal"></label>
    </div>
    <ul class="results">
      <li><span>Net saleable kg</span><strong id="key-net-kg">–</strong></li>
      <li><span>Revenue</span><strong id="key-revenue">–</strong></li>
      <li><span>Total cost</span><strong id="key-total-cost">–</strong></li>
      <li><span>Profit</span><strong id="key-profit">–</strong></li>
      <li><span>Gross margin %</span><strong id="key-gm">–</strong></li>
      <li><span>Profit / kg</span><strong id="key-profit-kg">–</strong></li>
    </ul>
  </section>

  <!-- Factory Day -->
  <section class="card" id="day">
    <h2>Factory Day</h2>
    <h3>Labor</h3>
    <div class="grid">
      <label>Operators<input id="staffCount" inputmode="numeric"></label>
      <label>€/operator/hr<input id="staffCostPerPerson" inputmode="decimal"></label>
      <label>Supervisors<input id="supCount" inputmode="numeric"></label>
      <label>€/supervisor/hr<input id="supCostPerPerson" inputmode="decimal"></label>
      <label>Operator hours<input id="staffHoursDay" inputmode="decimal" value="8"></label>
      <label>Supervisor hours<input id="supHoursDay" inputmode="decimal" value="8"></label>
    </div>

    <h3>Materials & Production</h3>
    <div class="grid">
      <label>Raw used kg<input id="rawUsedKg_day" inputmode="decimal"></label>
      <label>Raw cost / kg<input id="rawCostPerKg_day" inputmode="decimal"></label>
      <label>Pack cost / kg<input id="packCostPerKg_day" inputmode="decimal"></label>
      <label>Produced kg<input id="producedKg_day" inputmode="decimal"></label>
      <label>Selling price / kg<input id="sellPriceDay_day" inputmode="decimal"></label>
      <label>Freight / kg<input id="freightPerKg_day" inputmode="decimal"></label>
    </div>

    <h3>Fixed (ISK → EUR/day)</h3>
    <div class="grid">
      <label>ISK per EUR<input id="iskPerEur" inputmode="decimal"></label>
      <label>Working days<input id="workingDays" inputmode="numeric"></label>
      <label>Housing (ISK/month)<input id="housingCost" inputmode="decimal"></label>
      <label>Equipment (ISK/month)<input id="equipCost" inputmode="decimal"></label>
      <label>Admin (ISK/month)<input id="adminCost" inputmode="decimal"></label>
      <label>Depreciation (€/day)<input id="deprCost" inputmode="decimal"></label>
      <label>Month<select id="month"></select></label>
    </div>

    <h3>Breakdown</h3>
    <ul class="results">
      <li><span>Labor (operators)</span><strong id="bd-labor-staff">–</strong></li>
      <li><span>Labor (supervisors)</span><strong id="bd-labor-sup">–</strong></li>
      <li><span>Material</span><strong id="bd-material">–</strong></li>
      <li><span>Pack</span><strong id="bd-pack">–</strong></li>
      <li><span>Freight</span><strong id="bd-freight">–</strong></li>
      <li><span>Electricity €/day</span><strong id="bd-elec">–</strong></li>
      <li><span>Water €/day</span><strong id="bd-water">–</strong></li>
      <li><span>Maintenance €/day</span><strong id="bd-maint">–</strong></li>
      <li><span>Rentals €/day</span><strong id="bd-rentals">–</strong></li>
      <li><span>Spare parts €/day</span><strong id="bd-spares">–</strong></li>
      <li><span>Other €/day</span><strong id="bd-other">–</strong></li>
      <li><span>Housing €/day</span><strong id="bd-housing">–</strong></li>
      <li><span>Equipment €/day</span><strong id="bd-equip">–</strong></li>
      <li><span>Admin €/day</span><strong id="bd-admin">–</strong></li>
      <li><span>Depreciation €/day</span><strong id="bd-depr">–</strong></li>
    </ul>
  </section>
</main>

<script>
const locale = 'is-IS';
const LS_PREFIX = 'fp:';
const q = (s, r=document) => r.querySelector(s);
const qa = (s, r=document) => Array.from(r.querySelectorAll(s));
const setText = (sel,val) => { const el = typeof sel==='string'? q(sel):sel; if(el) el.textContent = val; };
const fmt = (n,d=2) => Number.isFinite(n)? new Intl.NumberFormat(locale,{minimumFractionDigits:d,maximumFractionDigits:d}).format(n) : '–';
const toNumber = v => { if(v==null) return NaN; let s=String(v).trim().replace(/\u00A0/g,'').replace(/\s/g,''); if(!s) return NaN; if(s.includes(',') && !s.includes('.')) s=s.replace(',','.'); return Number(s); };

// Populate month dropdown
function workingDaysInMonth(val){
  let y = new Date().getFullYear(), m = Number(val);
  const end = new Date(y, m, 0).getDate();
  let days = 0;
  for(let d=1; d<=end; d++){ const dow = new Date(y,m-1,d).getDay(); if(dow!==0 && dow!==6) days++; }
  return days;
}
function populateMonthSelect(){
  const sel = q('#month'); sel.innerHTML='';
  for(let i=0;i<12;i++){ const label=new Date(2000,i,1).toLocaleString('en',{month:'long'}); const m=String(i+1).padStart(2,'0'); sel.add(new Option(label,m)); }
  sel.value = String(new Date().getMonth()+1).padStart(2,'0');
  const wdBox = q('#workingDays'); wdBox.value = workingDaysInMonth(sel.value);
}

// Read URL params
const bindings = { iskPerEur:'#iskPerEur', workingDays:'#workingDays', housingCost:'#housingCost', equipCost:'#equipCost', adminCost:'#adminCost', deprCost:'#deprCost', month:'#month' };
function applyQueryParams(){
  const p = new URLSearchParams(location.search);
  for (const [k, sel] of Object.entries(bindings)) {
    const el = q(sel); if (!el) continue;
    let v = p.get(k); if (v==null) continue;
    if(k==='month' && /^\d{1,2}$/.test(v)) v=v.padStart(2,'0');
    el.value = v;
  }
}
function syncUrlFromInputs(){
  const p = new URLSearchParams(location.search);
  for (const [k, sel] of Object.entries(bindings)) {
    const el = q(sel); if (el && el.value) p.set(k, el.value);
  }
  history.replaceState(null,'',`${location.pathname}?${p.toString()}`);
}

// Get number from URL or LS
function getParamOrStoreNum(param){
  const p = new URLSearchParams(location.search);
  const v = p.get(param);
  if(v!=null && v!==''){ const n=toNumber(v); if(Number.isFinite(n)) return n; }
  const s = localStorage.getItem(LS_PREFIX + param);
  const n = toNumber(s);
  return Number.isFinite(n) ? n : 0;
}

// Calculations
function calcKeyNumbers(){ /* same as your working version */ }
function calcDay(){
  // same as your working version, but reads monthly buckets via getParamOrStoreNum()
  const wd = toNumber(q('#workingDays').value) || workingDaysInMonth(q('#month').value) || 22;
  const iskPerEur = toNumber(q('#iskPerEur').value) || 0;

  const maintEURm = getParamOrStoreNum('maintEurMonth');
  const rentalsEURm = getParamOrStoreNum('rentalsEurMonth');
  const sparesEURm = getParamOrStoreNum('sparesEurMonth');
  const elecEURm = getParamOrStoreNum('electricityEurMonth');
  const waterEURm = getParamOrStoreNum('waterEurMonth');
  const otherEURm = getParamOrStoreNum('otherEurMonth');

  // convert monthly→daily
  const maintEURd = maintEURm/wd, rentalsEURd = rentalsEURm/wd, sparesEURd = sparesEURm/wd, elecEURd = elecEURm/wd, waterEURd = waterEURm/wd, otherEURd = otherEURm/wd;
  // set breakdown
  setText('#bd-maint',fmt(maintEURd)); setText('#bd-rentals',fmt(rentalsEURd)); setText('#bd-spares',fmt(sparesEURd)); setText('#bd-elec',fmt(elecEURd)); setText('#bd-water',fmt(waterEURd)); setText('#bd-other',fmt(otherEURd));
}

function attachSync(){
  qa('input,select').forEach(el=>el.addEventListener('input',()=>{syncUrlFromInputs();calcKeyNumbers();calcDay();}));
}
// --- Thousands separator helpers (IS locale) ---
const nfIntIS = new Intl.NumberFormat('is-IS', { maximumFractionDigits: 0 });

function formatInt(el){
  const n = toNumber(el.value);
  if (Number.isFinite(n)) el.value = nfIntIS.format(Math.round(n));
}

function attachThousands(el){
  if (!el) return;
  el.addEventListener('focus', () => {
    const n = toNumber(el.value);
    if (Number.isFinite(n)) el.value = String(Math.round(n));
  });
  el.addEventListener('blur',  () => formatInt(el));
}

// --- Working days ⇐ Month ---
function updateWorkingDaysFromMonth(){
  const sel = q('#month');
  const box = q('#workingDays');
  if (!sel || !box) return;
  const wd = workingDaysInMonth(sel.value);   // accepts "MM" or "YYYY-MM"
  if (Number.isFinite(wd)) box.value = String(wd);
}

// ---------- Thousand/decimal formatting for ALL numeric inputs ----------
function initNumberFormatting(){
  // Decide decimals: default from inputmode (numeric=0, decimal=2), override with data-decimals
  const decimalsFor = (el) => {
    if (el.dataset.decimals != null) return Math.max(0, Number(el.dataset.decimals) || 0);
    return el.getAttribute('inputmode') === 'numeric' ? 0 : 2;
  };

  const fmtCache = new Map(); // cache Intl instances per decimals
  const getFmt = (d) => {
    if (!fmtCache.has(d)) fmtCache.set(d, new Intl.NumberFormat('is-IS', {
      minimumFractionDigits: d, maximumFractionDigits: d
    }));
    return fmtCache.get(d);
  };

  const formatPretty = (el) => {
    const d = decimalsFor(el);
    const n = toNumber(el.value);
    if (!Number.isFinite(n)) return;
    const v = d === 0 ? Math.round(n) : n;
    el.value = getFmt(d).format(v);
  };

  const formatRaw = (el) => {
    const d = decimalsFor(el);
    const n = toNumber(el.value);
    if (!Number.isFinite(n)) return;
    el.value = d === 0 ? String(Math.round(n)) : String(n.toFixed(d));
  };

  // Delegate focus/blur so it also works for any inputs added later
  document.addEventListener('focusin', (e) => {
    const el = e.target;
    if (el.matches('input[inputmode="decimal"], input[inputmode="numeric"]')) {
      formatRaw(el);
    }
  });
  document.addEventListener('focusout', (e) => {
    const el = e.target;
    if (el.matches('input[inputmode="decimal"], input[inputmode="numeric"]')) {
      formatPretty(el);
    }
  });

  // Initial pass: pretty format whatever is already filled (URL/LS)
  qa('input[inputmode="decimal"], input[inputmode="numeric"]').forEach(formatPretty);
}

  
document.addEventListener('DOMContentLoaded', () => {
  // Month select + default working days
  populateMonthSelect();
  updateWorkingDaysFromMonth();                   // <- set once on load
  q('#month')?.addEventListener('change', () => { // <- keep in sync on change
    updateWorkingDaysFromMonth();
    calcDay();
    syncUrlFromInputs?.();
    initNumberFormatting();
  });

  // Read query params (from "Copy to planner now")
  applyQueryParams?.();

  // LocalStorage -> inputs (+ derive €/day from monthly buckets if needed)
  loadDefaultsFromStorage?.();

  // If URL contains monthly buckets, convert them to €/day once
  applyMonthlyParamsToDaily?.();

  // Thousands separators for ISK/month fields
  ['#housingCost', '#equipCost', '#adminCost'].forEach(sel => {
    const el = q(sel);
    attachThousands(el);
    // If it already has a value, format it immediately
    if (el && el.value) formatInt(el);
  });

  // Keep URL + calcs live
  attachSync?.();

  // Initial calculations
  calcKeyNumbers?.();
  calcDay?.();
});

</script>
</body>
</html>
