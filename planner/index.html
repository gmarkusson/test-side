<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Factory Planner — Key Numbers</title>
<style>
  :root{--gap:14px;--pad:16px;--bg:#f6f8fc;--card:#fff;--ink:#0b1320;--muted:#4a5874;--accent:#0b5fff;--border:#e4e9f2;--field:#d6dbe6}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:24px var(--pad);border-bottom:1px solid var(--border)}
  h1{margin:0 0 6px;font-size:22px}
  h2{margin:0 0 10px;font-size:18px;color:var(--accent)}
  main{padding:20px var(--pad) 60px;display:grid;gap:14px}
  section.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  label{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-weight:600}
  input,select{background:#fff;color:var(--ink);border:1px solid var(--field);border-radius:8px;padding:10px 12px;outline:none}
  input:focus,select:focus{border-color:#2c6fff;box-shadow:0 0 0 2px rgba(44,111,255,.14)}
  .results{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0 0;padding:0;list-style:none}
  .results li{background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
  .results li span{color:var(--muted)} .results li strong{font-size:15px}
  .actions{display:flex;gap:10px;margin-top:10px}
  .btn{display:inline-block;background:var(--accent);color:#fff;border:1px solid var(--accent);padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600}
  .btn:hover,.btn:focus{background:#094de8;border-color:#094de8}
</style>
</head>
<body>
<header>
  <h1>Factory Planner</h1>
  <div class="muted">Type values or pass them via URL. Numbers show thousand separators automatically.</div>
  <div class="actions">
    <a class="btn" href="fixed-costs.html">Fixed costs</a>
  </div>
</header>

<main>
  <!-- Key Numbers -->
  <section class="card">
    <h2>Key Numbers</h2>
    <div class="grid">
      <label>Produced kg (net)<input id="producedKg" inputmode="numeric" data-decimals="0"></label>
      <label>Selling price / kg<input id="sellPriceDay" inputmode="decimal" data-decimals="2"></label>
      <label>Raw used kg<input id="rawUsedKg" inputmode="numeric" data-decimals="0"></label>
      <label>Yield % (optional)<input id="yieldPct" inputmode="decimal" data-decimals="1"></label>
      <label>Raw cost / kg<input id="rawCostPerKg" inputmode="decimal" data-decimals="2"></label>
      <label>Pack cost / kg<input id="packCostPerKg" inputmode="decimal" data-decimals="2"></label>
      <label>Freight / kg<input id="freightPerKg" inputmode="decimal" data-decimals="2"></label>
    </div>
    <ul class="results">
      <li><span>Net saleable kg</span><strong id="key-net-kg">–</strong></li>
      <li><span>Revenue</span><strong id="key-revenue">–</strong></li>
      <li><span>Total cost</span><strong id="key-total-cost">–</strong></li>
      <li><span>Profit</span><strong id="key-profit">–</strong></li>
      <li><span>Gross margin %</span><strong id="key-gm">–</strong></li>
      <li><span>Profit / kg</span><strong id="key-profit-kg">–</strong></li>
    </ul>
  </section>

  <!-- Factory Day -->
  <section class="card" id="day">
    <h2>Factory Day</h2>

    <h3>Labor</h3>
    <div class="grid">
      <label>Operators<input id="staffCount" inputmode="numeric" data-decimals="0"></label>
      <label>€/operator/hr<input id="staffCostPerPerson" inputmode="decimal" data-decimals="2"></label>
      <label>Supervisors<input id="supCount" inputmode="numeric" data-decimals="0"></label>
      <label>€/supervisor/hr<input id="supCostPerPerson" inputmode="decimal" data-decimals="2"></label>
      <label>Operator hours<input id="staffHoursDay" inputmode="decimal" data-decimals="2" value="8"></label>
      <label>Supervisor hours<input id="supHoursDay" inputmode="decimal" data-decimals="2" value="8"></label>
    </div>

    <h3>Materials & Production</h3>
    <div class="grid">
      <label>Raw used kg<input id="rawUsedKg_day" inputmode="numeric" data-decimals="0"></label>
      <label>Raw cost / kg<input id="rawCostPerKg_day" inputmode="decimal" data-decimals="2"></label>
      <label>Pack cost / kg<input id="packCostPerKg_day" inputmode="decimal" data-decimals="2"></label>
      <label>Produced kg<input id="producedKg_day" inputmode="numeric" data-decimals="0"></label>
      <label>Selling price / kg<input id="sellPriceDay_day" inputmode="decimal" data-decimals="2"></label>
      <label>Freight / kg<input id="freightPerKg_day" inputmode="decimal" data-decimals="2"></label>
    </div>

    <h3>Fixed (ISK → EUR/day)</h3>
    <div class="grid">
      <label>ISK per EUR<input id="iskPerEur" inputmode="decimal" data-decimals="4"></label>
      <label>Working days<input id="workingDays" inputmode="numeric" data-decimals="0"></label>
      <label>Housing (ISK/month)<input id="housingCost" inputmode="numeric" data-decimals="0"></label>
      <label>Equipment (ISK/month)<input id="equipCost" inputmode="numeric" data-decimals="0"></label>
      <label>Admin (ISK/month)<input id="adminCost" inputmode="numeric" data-decimals="0"></label>
      <label>Depreciation (€/day)<input id="deprCost" inputmode="decimal" data-decimals="2"></label>
      <label>Month
        <select id="month"></select>
      </label>
    </div>

    <h3>Breakdown</h3>
    <ul class="results">
      <li><span>Labor (operators)</span><strong id="bd-labor-staff">–</strong></li>
      <li><span>Labor (supervisors)</span><strong id="bd-labor-sup">–</strong></li>
      <li><span>Material</span><strong id="bd-material">–</strong></li>
      <li><span>Pack</span><strong id="bd-pack">–</strong></li>
      <li><span>Freight</span><strong id="bd-freight">–</strong></li>
      <li><span>Electricity €/day</span><strong id="bd-elec">–</strong></li>
      <li><span>Water €/day</span><strong id="bd-water">–</strong></li>
      <li><span>Maintenance €/day</span><strong id="bd-maint">–</strong></li>
      <li><span>Rentals €/day</span><strong id="bd-rentals">–</strong></li>
      <li><span>Spare parts €/day</span><strong id="bd-spares">–</strong></li>
      <li><span>Other €/day</span><strong id="bd-other">–</strong></li>
      <li><span>Housing €/day</span><strong id="bd-housing">–</strong></li>
      <li><span>Equipment €/day</span><strong id="bd-equip">–</strong></li>
      <li><span>Admin €/day</span><strong id="bd-admin">–</strong></li>
      <li><span>Depreciation €/day</span><strong id="bd-depr">–</strong></li>
    </ul>
  </section>
</main>

<script>
/* ---------- helpers ---------- */
const locale='is-IS';
const q=(s,r=document)=>r.querySelector(s);
const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));
const setText=(sel,val)=>{const el=typeof sel==='string'?q(sel):sel;if(el)el.textContent=val;};
const fmt=(n,d=2)=>Number.isFinite(n)? new Intl.NumberFormat(locale,{minimumFractionDigits:d,maximumFractionDigits:d}).format(n) : '–';

/* robust number parser: handles 1,000.50 / 1.000,50 / 1000,50 / 1000.50 */
function toNumber(v){
  if(v==null) return NaN;
  let s=String(v).trim().replace(/\u00A0/g,'').replace(/\s/g,'');
  if(!s) return NaN;
  const hasC=s.includes(','), hasD=s.includes('.');
  if(hasC&&hasD){
    if(s.lastIndexOf(',')>s.lastIndexOf('.')) s=s.replace(/\./g,'').replace(',', '.'); // 1.234.567,89
    else s=s.replace(/,/g,''); // 1,234,567.89
  }else if(hasC){
    const parts=s.split(','), thousands=parts.length>1&&parts.every((p,i)=>(i===0?p.length<=3:p.length===3));
    s=thousands?s.replace(/,/g,''):s.replace(',', '.');
  }else if(hasD){
    const parts=s.split('.'), thousands=parts.length>1&&parts.every((p,i)=>(i===0?p.length<=3:p.length===3));
    if(thousands) s=s.replace(/\./g,'');
  }
  const n=Number(s); return Number.isFinite(n)? n : NaN;
}

/* ---------- month / working days ---------- */
function workingDaysInMonth(val){
  // accepts "MM" or "YYYY-MM"
  let y,m;
  if(/^\d{2}$/.test(val)){ y=new Date().getFullYear(); m=Number(val); }
  else if(/^\d{4}-\d{2}$/.test(val)){ [y,m]=val.split('-').map(Number); }
  else { y=new Date().getFullYear(); m=new Date().getMonth()+1; }
  const end=new Date(y,m,0).getDate();
  let days=0;
  for(let d=1; d<=end; d++){
    const dow=new Date(y,m-1,d).getDay();
    if(dow!==0 && dow!==6) days++;
  }
  return days;
}
function populateMonthSelect(){
  const sel=q('#month'); sel.innerHTML='';
  for(let i=0;i<12;i++){
    const label=new Date(2000,i,1).toLocaleString('en',{month:'long'});
    const m=String(i+1).padStart(2,'0');
    sel.add(new Option(label,m));
  }
  sel.value=String(new Date().getMonth()+1).padStart(2,'0');
}

/* ---------- pretty typing (thousand separators) ---------- */
function initNumberFormatting(){
  const getDec = el => el.dataset.decimals!=null ? Math.max(0,Number(el.dataset.decimals)||0)
                                                 : (el.getAttribute('inputmode')==='numeric'?0:2);

  const nfCache=new Map();
  const nf=(d)=>{ if(!nfCache.has(d)) nfCache.set(d,new Intl.NumberFormat('is-IS',{minimumFractionDigits:d,maximumFractionDigits:d})); return nfCache.get(d); };

  const pretty=(el)=>{ const d=getDec(el), n=toNumber(el.value); if(!Number.isFinite(n))return; el.value=nf(d).format(d===0?Math.round(n):n); };
  const raw   =(el)=>{ const d=getDec(el), n=toNumber(el.value); if(!Number.isFinite(n))return; el.value=d===0?String(Math.round(n)):String(n.toFixed(d)); };

  document.addEventListener('focusin',e=>{
    const el=e.target;
    if(el.matches('input[inputmode="decimal"],input[inputmode="numeric"]')) raw(el);
  });
  document.addEventListener('focusout',e=>{
    const el=e.target;
    if(el.matches('input[inputmode="decimal"],input[inputmode="numeric"]')){ pretty(el); calcAll(); }
  });

  // initial pass
  qa('input[inputmode="decimal"],input[inputmode="numeric"]').forEach(pretty);
}

/* ---------- URL sync ---------- */
const bindings={
  producedKg:'#producedKg', sellPriceDay:'#sellPriceDay', rawUsedKg:'#rawUsedKg', yieldPct:'#yieldPct',
  rawCostPerKg:'#rawCostPerKg', packCostPerKg:'#packCostPerKg', freightPerKg:'#freightPerKg',
  rawUsedKg_day:'#rawUsedKg_day', rawCostPerKg_day:'#rawCostPerKg_day', packCostPerKg_day:'#packCostPerKg_day',
  producedKg_day:'#producedKg_day', sellPriceDay_day:'#sellPriceDay_day', freightPerKg_day:'#freightPerKg_day',
  staffCount:'#staffCount', staffCostPerPerson:'#staffCostPerPerson', supCount:'#supCount', supCostPerPerson:'#supCostPerPerson',
  staffHoursDay:'#staffHoursDay', supHoursDay:'#supHoursDay',
  iskPerEur:'#iskPerEur', workingDays:'#workingDays', housingCost:'#housingCost', equipCost:'#equipCost',
  adminCost:'#adminCost', deprCost:'#deprCost', month:'#month'
};
function applyQueryParams(){
  const p=new URLSearchParams(location.search);
  for(const [k,sel] of Object.entries(bindings)){
    const el=q(sel); if(!el)continue;
    let v=p.get(k); if(v==null||v==='')continue;
    if(k==='month'){ if(/^\d{4}-\d{2}$/.test(v)) v=v.slice(5); v=v.padStart(2,'0'); }
    el.value=v;
  }
}
function syncUrlFromInputs(){
  const p=new URLSearchParams();
  for(const [k,sel] of Object.entries(bindings)){
    const el=q(sel); if(el && String(el.value).trim()!=='') p.set(k,el.value);
  }
  history.replaceState(null,'',`${location.pathname}?${p.toString()}`);
}

/* ---------- calculations ---------- */
function calcKeyNumbers(){
  const producedKg=toNumber(q('#producedKg').value);
  const sellPrice =toNumber(q('#sellPriceDay').value);
  const rawUsed   =toNumber(q('#rawUsedKg').value);
  const yieldPct  =toNumber(q('#yieldPct').value);
  const rawCostKg =toNumber(q('#rawCostPerKg').value)||0;
  const packKg    =toNumber(q('#packCostPerKg').value)||0;
  const freightKg =toNumber(q('#freightPerKg').value)||0;

  // derive rawUsed or yield if one is missing
  let rawUsedEff = Number.isFinite(rawUsed) ? rawUsed : NaN;
  let yieldEff   = Number.isFinite(yieldPct) ? yieldPct : NaN;
  if (Number.isFinite(producedKg)) {
    if (Number.isFinite(yieldPct) && yieldPct>0) rawUsedEff = producedKg / (yieldPct/100);
    else if (Number.isFinite(rawUsed) && rawUsed>0) yieldEff = (producedKg/rawUsed)*100;
  }

  const revenue    = (Number.isFinite(producedKg)&&Number.isFinite(sellPrice)) ? producedKg*sellPrice : NaN;
  const rawMatCost = Number.isFinite(rawUsedEff) ? rawUsedEff*rawCostKg : NaN;
  const packCost   = Number.isFinite(producedKg) ? producedKg*packKg : NaN;
  const freight    = Number.isFinite(producedKg) ? producedKg*freightKg : NaN;

  const totalCost  = [rawMatCost,packCost,freight].reduce((s,v)=>s+(Number.isFinite(v)?v:0),0);
  const profit     = Number.isFinite(revenue)? revenue-totalCost : NaN;
  const marginPct  = (Number.isFinite(revenue)&&revenue!==0)? (profit/revenue)*100 : NaN;
  const profitKg   = (Number.isFinite(producedKg)&&producedKg>0)? profit/producedKg : NaN;

  setText('#key-net-kg',    fmt(producedKg,0));
  setText('#key-revenue',   fmt(revenue,2));
  setText('#key-total-cost',fmt(totalCost,2));
  setText('#key-profit',    fmt(profit,2));
  setText('#key-gm',        Number.isFinite(marginPct)? fmt(marginPct,1)+' %':'–');
  setText('#key-profit-kg', fmt(profitKg,2));
}

function calcDay(){
  // labor
  const staffCount=toNumber(q('#staffCount').value), staffHr=toNumber(q('#staffHoursDay').value), staffRate=toNumber(q('#staffCostPerPerson').value);
  const supCount  =toNumber(q('#supCount').value),   supHr  =toNumber(q('#supHoursDay').value),   supRate  =toNumber(q('#supCostPerPerson').value);
  const laborStaff=(Number.isFinite(staffCount)&&Number.isFinite(staffHr)&&Number.isFinite(staffRate))? staffCount*staffHr*staffRate : 0;
  const laborSup  =(Number.isFinite(supCount)&&Number.isFinite(supHr)&&Number.isFinite(supRate))? supCount*supHr*supRate : 0;

  // materials
  const rawUsed=toNumber(q('#rawUsedKg_day').value), rawCostKg=toNumber(q('#rawCostPerKg_day').value);
  const produced=toNumber(q('#producedKg_day').value), packKg=toNumber(q('#packCostPerKg_day').value), freightKg=toNumber(q('#freightPerKg_day').value);
  const matCost=(Number.isFinite(rawUsed)&&Number.isFinite(rawCostKg))? rawUsed*rawCostKg : 0;
  const packCost=(Number.isFinite(produced)&&Number.isFinite(packKg))? produced*packKg : 0;
  const freight =(Number.isFinite(produced)&&Number.isFinite(freightKg))? produced*freightKg : 0;

  // fixed
  const iskPerEur=toNumber(q('#iskPerEur').value);
  let workDays=toNumber(q('#workingDays').value);
  if(!Number.isFinite(workDays)||workDays<=0){ workDays=workingDaysInMonth(q('#month').value) || 22; q('#workingDays').value=String(workDays); }
  const housingISK=toNumber(q('#housingCost').value), equipISK=toNumber(q('#equipCost').value), adminISK=toNumber(q('#adminCost').value);
  const deprEURd  =toNumber(q('#deprCost').value)||0;

  // monthly EUR buckets from localStorage/URL (set by fixed-costs.html)
  const get=key=>{ const p=new URLSearchParams(location.search); const v=p.get(key)??localStorage.getItem('fp:'+key); const n=toNumber(v); return Number.isFinite(n)?n:0; };
  const maintEURm=get('maintEurMonth'), rentalsEURm=get('rentalsEurMonth'), sparesEURm=get('sparesEurMonth'), elecEURm=get('electricityEurMonth'), waterEURm=get('waterEurMonth'), otherEURm=get('otherEurMonth');

  const maintEURd=maintEURm/workDays, rentalsEURd=rentalsEURm/workDays, sparesEURd=sparesEURm/workDays, elecEURd=elecEURm/workDays, waterEURd=waterEURm/workDays, otherEURd=otherEURm/workDays;

  const canFX=Number.isFinite(iskPerEur)&&iskPerEur>0;
  const housingDay=(canFX&&Number.isFinite(housingISK))?(housingISK*iskPerEur)/workDays:0;
  const equipDay  =(canFX&&Number.isFinite(equipISK))  ?(equipISK  *iskPerEur)/workDays:0;
  const adminDay  =(canFX&&Number.isFinite(adminISK))  ?(adminISK  *iskPerEur)/workDays:0;

  const revenue=(Number.isFinite(produced)&&Number.isFinite(toNumber(q('#sellPriceDay_day').value)))? produced*toNumber(q('#sellPriceDay_day').value) : NaN;
  const totalCost=laborStaff+laborSup+matCost+packCost+freight+elecEURd+waterEURd+maintEURd+rentalsEURd+sparesEURd+otherEURd+housingDay+equipDay+adminDay+deprEURd;
  const profit=Number.isFinite(revenue)? revenue-totalCost : NaN;
  const marginPct=(Number.isFinite(revenue)&&revenue!==0)? (profit/revenue)*100 : NaN;
  const costPerKg=(Number.isFinite(produced)&&produced>0)? totalCost/produced : NaN;

  setText('#bd-labor-staff',fmt(laborStaff,2));
  setText('#bd-labor-sup',fmt(laborSup,2));
  setText('#bd-material',fmt(matCost,2));
  setText('#bd-pack',fmt(packCost,2));
  setText('#bd-freight',fmt(freight,2));
  setText('#bd-elec',fmt(elecEURd,2));
  setText('#bd-water',fmt(waterEURd,2));
  setText('#bd-maint',fmt(maintEURd,2));
  setText('#bd-rentals',fmt(rentalsEURd,2));
  setText('#bd-spares',fmt(sparesEURd,2));
  setText('#bd-other',fmt(otherEURd,2));
  setText('#bd-housing',fmt(housingDay,2));
  setText('#bd-equip',fmt(equipDay,2));
  setText('#bd-admin',fmt(adminDay,2));
  setText('#bd-depr',fmt(deprEURd,2));

  // also show top summary from key section
  setText('#day-revenue',fmt(revenue,2));
  setText('#day-total-cost',fmt(totalCost,2));
  setText('#day-profit',fmt(profit,2));
  setText('#day-margin',Number.isFinite(marginPct)?fmt(marginPct,1)+' %':'–');
  setText('#day-cost-kg',fmt(costPerKg,2));
}

function calcAll(){ syncUrlFromInputs(); calcKeyNumbers(); calcDay(); }

/* ---------- wiring ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  populateMonthSelect();

  // defaults for working days based on current month
  const wd = workingDaysInMonth(q('#month').value);
  if(q('#workingDays') && (!q('#workingDays').value || !Number.isFinite(toNumber(q('#workingDays').value)))) q('#workingDays').value=String(wd);

  q('#month').addEventListener('change',()=>{
    q('#workingDays').value=String(workingDaysInMonth(q('#month').value));
    calcAll();
  });

  applyQueryParams();
  initNumberFormatting();

  // live updates
  qa('input,select').forEach(el=>{
    el.addEventListener('input', calcAll);
    el.addEventListener('change', calcAll);
  });

  calcAll();
});
</script>
</body>
</html>
