<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Factory Planner — Key Numbers & Factory Day</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a;       /* slate-900 */
      --card:#111827;     /* gray-900 */
      --muted:#94a3b8;    /* slate-400 */
      --text:#e5e7eb;     /* gray-200 */
      --accent:#22d3ee;   /* cyan-400 */
      --ok:#10b981;       /* emerald-500 */
      --warn:#f59e0b;     /* amber-500 */
      --bad:#ef4444;      /* red-500 */
      --border:#1f2937;   /* gray-800 */
      --chip:#0b1222;
    }
    html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0}
    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{font-size:clamp(20px,3vw,28px);margin:0}
    a.button,button{
      background:var(--accent);color:#062028;border:none;border-radius:10px;
      padding:10px 14px;font-weight:600;cursor:pointer;transition:filter .15s;
    }
    a.button:hover,button:hover{filter:brightness(1.05)}
    .grid{display:grid;gap:16px}
    @media (min-width:900px){ .grid{grid-template-columns:1.1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .card h2{margin:0 0 10px 0;font-size:18px}
    .row{display:grid;grid-template-columns:240px 1fr;gap:12px;align-items:center;margin:8px 0}
    .row > label{color:var(--muted)}
    input[type="text"],select{
      width:100%;background:#0b1020;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:10px 12px;font-size:14px;outline:none;
    }
    input[type="text"]:focus,select:focus{border-color:#2b3b52}
    .help{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{display:inline-block;background:var(--chip);border:1px solid var(--border);padding:5px 8px;border-radius:999px;font-size:12px}
    .stack{display:flex;flex-wrap:wrap;gap:8px}
    .totals{display:grid;gap:8px}
    .totals .line{display:flex;justify-content:space-between;border-bottom:1px dashed #1f2a44;padding:6px 0}
    .totals .line strong{color:#fff}
    .totals .grand{font-weight:700}
    .badge{padding:4px 8px;border-radius:8px;background:#0d1b2a;border:1px solid var(--border);font-size:12px}
    .hl{color:var(--accent);font-weight:700}
    .money-ok{color:var(--ok)} .money-warn{color:var(--warn)} .money-bad{color:var(--bad)}
    .breakdown{margin-top:8px;border-top:1px solid var(--border);padding-top:8px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .section-title{display:flex;align-items:center;gap:8px;margin:0 0 6px 0}
    .inline{display:flex;align-items:center;gap:8px}
    .right{display:flex;justify-content:flex-end}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Factory Planner</h1>
    <div class="stack">
      <a class="button" href="fixed-costs.html">Open Fixed Costs</a>
      <span class="pill">Locale: <strong>is-IS</strong></span>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: Inputs -->
    <section class="card">
      <h2 class="section-title">Inputs</h2>

      <!-- Month + Working days -->
      <div class="row">
        <label for="month">Month</label>
        <select id="month">
          <option value="">— choose —</option>
        </select>
      </div>
      <div class="row">
        <label for="workingDays">Working days (Mon–Fri)</label>
        <input type="text" id="workingDays" class="num num-int" inputmode="decimal" placeholder="auto from month" />
      </div>
      <div class="help">Selecting a month fills working days for <span id="yearNow"></span>. Editing here manually overrides auto.</div>

      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">

      <!-- Yield triad -->
      <div class="row">
        <label for="rawKg">Raw used kg</label>
        <input type="text" id="rawKg" class="num" inputmode="decimal" placeholder="e.g. 1.500" />
      </div>
      <div class="row">
        <label for="yieldPct">Yield %</label>
        <input type="text" id="yieldPct" class="num" inputmode="decimal" placeholder="e.g. 63,5" />
      </div>
      <div class="row">
        <label for="netKg">Net saleable kg</label>
        <input type="text" id="netKg" class="num" inputmode="decimal" placeholder="auto if raw/yield set" />
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">

      <div class="row">
        <label for="pricePerKg">Sale price (EUR/kg)</label>
        <input type="text" id="pricePerKg" class="num" inputmode="decimal" placeholder="e.g. 6,90" />
      </div>

      <div class="row">
        <label for="iskPerEur">FX: ISK per EUR</label>
        <input type="text" id="iskPerEur" class="num" inputmode="decimal" placeholder="from Fixed Costs page" />
      </div>
    </section>

    <!-- RIGHT: Key Numbers -->
    <section class="card" id="keyNumbersCard">
      <h2 class="section-title">Key Numbers</h2>
      <div class="totals" id="keyNumbers">
        <div class="line"><span>Net saleable kg</span><strong id="kn_netKg" class="hl">–</strong></div>
        <div class="line"><span>Revenue (EUR)</span><strong id="kn_revenue">–</strong></div>
        <div class="line"><span>Total cost (EUR/day)</span><strong id="kn_totalCost">–</strong></div>
        <div class="line"><span>Profit (EUR/day)</span><strong id="kn_profit">–</strong></div>
        <div class="line"><span>Gross margin %</span><strong id="kn_margin">–</strong></div>
        <div class="line"><span>Profit / kg (EUR)</span><strong id="kn_profitPerKg">–</strong></div>
      </div>
      <div class="help">Key Numbers assume a single factory day using the breakdown on the left + fixed costs below.</div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2 class="section-title">Factory Day (EUR)</h2>

    <!-- Variable / direct daily costs -->
    <div class="row"><label for="laborOps">Labor — operators</label><input type="text" id="laborOps" class="num" inputmode="decimal" placeholder="EUR/day"></div>
    <div class="row"><label for="laborSup">Labor — supervisors</label><input type="text" id="laborSup" class="num" inputmode="decimal" placeholder="EUR/day"></div>
    <div class="row"><label for="materialsDay">Materials</label><input type="text" id="materialsDay" class="num" inputmode="decimal" placeholder="EUR/day"></div>
    <div class="row"><label for="packDay">Pack</label><input type="text" id="packDay" class="num" inputmode="decimal" placeholder="EUR/day"></div>
    <div class="row"><label for="freightDay">Freight</label><input type="text" id="freightDay" class="num" inputmode="decimal" placeholder="EUR/day"></div>

    <!-- Fixed costs from monthly buckets -->
    <div class="row"><label>Fixed costs (from monthly)</label>
      <div class="inline">
        <span class="badge">ISK→EUR/day: <span id="fcIskDay">–</span></span>
        <span class="badge">EUR/day: <span id="fcEurDay">–</span></span>
        <span class="badge">Total fixed/day: <span id="fcTotalDay">–</span></span>
      </div>
    </div>

    <!-- Depreciation -->
    <div class="row"><label for="deprDay">Depreciation / day</label><input type="text" id="deprDay" class="num" inputmode="decimal" placeholder="EUR/day"></div>

    <div class="breakdown">
      <h3 class="small">Breakdown</h3>
      <div class="totals" id="fdTotals">
        <!-- filled by JS -->
      </div>
    </div>
  </section>

  <div class="right">
    <div class="chips" id="chipsInfo"></div>
  </div>

</div>

<script>
/* ============================================================
   Locale + formatting helpers (is-IS)
   ------------------------------------------------------------
   - All numeric inputs show thousand separators on blur.
   - On focus: switch to "raw" (no grouping) for easy editing.
   - Robust parsing accepts commas or periods, ignores spaces.
   ============================================================ */

const LOCALE = 'is-IS';
const nf0 = new Intl.NumberFormat(LOCALE, { maximumFractionDigits: 0 });
const nf2 = new Intl.NumberFormat(LOCALE, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const nfDyn = (digits=2)=> new Intl.NumberFormat(LOCALE, { minimumFractionDigits: 0, maximumFractionDigits: digits });

/** Robust toNumber: accepts is-IS typing (comma or period), ignores spaces and NBSP, handles thousands. */
function toNumber(value){
  if (value == null) return NaN;
  if (typeof value === 'number') return value;
  let s = (''+value).replace(/\s|\u00A0/g,'').trim();
  if (s === '') return NaN;

  const hasComma = s.includes(',');
  const hasDot   = s.includes('.');
  if (hasComma && hasDot){
    // Assume the last separator is the decimal; remove all others as thousands
    const lastComma = s.lastIndexOf(',');
    const lastDot   = s.lastIndexOf('.');
    const decIsComma = lastComma > lastDot;
    if (decIsComma){
      s = s.replace(/\./g,'').replace(',', '.');
    } else {
      s = s.replace(/,/g,''); // dot is decimal already
    }
  } else if (hasComma){
    // If more than one comma, treat all as thousands except maybe last; simpler: remove all but last as thousands and convert last to dot
    if ((s.match(/,/g)||[]).length > 1){
      const last = s.lastIndexOf(',');
      s = s.slice(0,last).replace(/,/g,'') + '.' + s.slice(last+1);
    } else {
      // single comma: treat as decimal
      s = s.replace(',', '.');
    }
  } else if (hasDot){
    // If more than one dot, same approach
    if ((s.match(/\./g)||[]).length > 1){
      const last = s.lastIndexOf('.');
      s = s.slice(0,last).replace(/\./g,'') + '.' + s.slice(last+1);
    } // else single dot = decimal already
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}

/** Format number with is-IS grouping. If decimals unspecified, use up to 2. */
function fmt(n, decimals){
  if (!Number.isFinite(n)) return '–';
  if (typeof decimals === 'number'){
    return new Intl.NumberFormat(LOCALE, { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(n);
  }
  // Adaptive: 0 if integer, else up to 2
  const opts = Number.isInteger(n) ? { maximumFractionDigits: 0 } : { minimumFractionDigits: 0, maximumFractionDigits: 2 };
  return new Intl.NumberFormat(LOCALE, opts).format(n);
}

/** Attach formatting behavior to every .num input */
function wireFormatting(){
  document.querySelectorAll('input.num').forEach(inp=>{
    // On focus: show raw value (no grouping)
    inp.addEventListener('focus', ()=>{
      const n = toNumber(inp.value);
      if (Number.isFinite(n)){
        // Decide decimals for raw edit: keep as minimal string without grouping
        const decimalsAttr = inp.classList.contains('num-int') ? 0 : undefined;
        inp.value = (decimalsAttr === 0) ? String(Math.trunc(n)) : String(n).replace(/(?<=\d)\.0+$/,'');
      }
    });
    // On blur: reformat nicely
    inp.addEventListener('blur', ()=>{
      const n = toNumber(inp.value);
      const isInt = inp.classList.contains('num-int');
      inp.value = Number.isFinite(n) ? fmt(n, isInt ? 0 : undefined) : '';
      scheduleURLUpdate();
      computeAll();
    });
    // On direct typing: update URL minimally (no heavy compute every keystroke)
    inp.addEventListener('input', debounce(scheduleURLUpdate, 300));
  });
}

/* ============================================================
   URL <-> Inputs sync
   - Only include set values; remove when cleared.
   - No reloads (history.replaceState).
   ============================================================ */
const URL_KEYS = [
  'month','workingDays','rawKg','yieldPct','netKg',
  'pricePerKg','iskPerEur',
  'laborOps','laborSup','materialsDay','packDay','freightDay','deprDay'
];
let urlUpdateQueued = false;

function readParams(){
  const sp = new URLSearchParams(location.search);
  const get = k => sp.get(k);
  // Also accept fp_* params coming from fixed-costs.html for monthly totals & globals
  return Object.fromEntries([...sp.entries()].map(([k,v])=>[k,v]));
}

function setParams(obj){
  const sp = new URLSearchParams();
  for (const k of URL_KEYS){
    const el = document.getElementById(k);
    if (!el) continue;
    const val = (el.value||'').trim();
    if (val) sp.set(k, val);
  }
  // carry-through fp_* params if present and non-zero (so shares links cleanly)
  for (const [k,v] of Object.entries(obj)){
    if (k.startsWith('fp_') && v != null && String(v).trim() !== '' && toNumber(v) !== 0){
      sp.set(k, String(v));
    }
  }
  const qs = sp.toString();
  history.replaceState(null, '', qs ? ('?'+qs) : location.pathname);
}

function scheduleURLUpdate(){
  if (urlUpdateQueued) return;
  urlUpdateQueued = true;
  requestAnimationFrame(()=>{
    setParams(readParams());
    urlUpdateQueued = false;
  });
}

/* ============================================================
   Working days from month
   - Auto when month changes.
   - Manual override if user edits workingDays.
   ============================================================ */
const YEAR = new Date().getFullYear(); // current year (tooling says Atlantic/Reykjavík; no DST issues for weekday counting)
let workingDaysManual = false;

function fillMonthSelect(){
  const monthSel = document.getElementById('month');
  const monthNames = [];
  for (let m=0;m<12;m++){
    monthNames.push(new Intl.DateTimeFormat(LOCALE, { month:'long' }).format(new Date(2025, m, 1)));
  }
  monthNames.forEach((name,idx)=>{
    const opt = document.createElement('option');
    opt.value = String(idx+1); // 1..12
    opt.textContent = name.charAt(0).toUpperCase()+name.slice(1);
    monthSel.appendChild(opt);
  });
  document.getElementById('yearNow').textContent = YEAR;
}

function calcWorkingDays(year, monthIndex1to12){
  const m = monthIndex1to12-1;
  let d = new Date(year, m, 1);
  let days = 0;
  while (d.getMonth() === m){
    const weekday = d.getDay(); // 0 Sun .. 6 Sat
    if (weekday >= 1 && weekday <= 5) days++;
    d.setDate(d.getDate()+1);
  }
  return days;
}

function wireWorkingDays(){
  const monthSel = document.getElementById('month');
  const wdInput  = document.getElementById('workingDays');

  monthSel.addEventListener('change', ()=>{
    const mv = toNumber(monthSel.value);
    if (mv>=1 && mv<=12){
      const auto = calcWorkingDays(YEAR, mv);
      if (!workingDaysManual || !wdInput.value.trim()){
        wdInput.value = fmt(auto,0);
      }
      scheduleURLUpdate();
      computeAll();
    }
  });
  wdInput.addEventListener('input', ()=>{ workingDaysManual = true; });
}

/* ============================================================
   Fixed costs interop (localStorage + URL)
   Keys expected from fixed-costs.html (monthly):
   ISK/month: fp:housingCost, fp:equipCost, fp:adminCost
   EUR/month: fp:maintEurMonth, fp:rentalsEurMonth, fp:sparesEurMonth,
              fp:electricityEurMonth, fp:waterEurMonth, fp:otherEurMonth
   Globals:   fp:iskPerEur, fp:workingDays
   Also accept URL params fp_* mirroring these (with underscore).
   ============================================================ */
const LS_KEYS = [
  'fp:housingCost','fp:equipCost','fp:adminCost',
  'fp:maintEurMonth','fp:rentalsEurMonth','fp:sparesEurMonth','fp:electricityEurMonth','fp:waterEurMonth','fp:otherEurMonth',
  'fp:iskPerEur','fp:workingDays'
];

function readFixedCostsFromLS(){
  const o = {};
  for (const k of LS_KEYS){
    const v = localStorage.getItem(k);
    if (v!=null) o[k] = v;
  }
  return o;
}

function readFixedCostsFromURL(){
  const p = readParams();
  // map fp_xxx -> same semantic; index expects both
  const map = {
    'fp_housingCost':'fp:housingCost',
    'fp_equipCost':'fp:equipCost',
    'fp_adminCost':'fp:adminCost',
    'fp_maintEurMonth':'fp:maintEurMonth',
    'fp_rentalsEurMonth':'fp:rentalsEurMonth',
    'fp_sparesEurMonth':'fp:sparesEurMonth',
    'fp_electricityEurMonth':'fp:electricityEurMonth',
    'fp_waterEurMonth':'fp:waterEurMonth',
    'fp_otherEurMonth':'fp:otherEurMonth',
    'fp_iskPerEur':'fp:iskPerEur',
    'fp_workingDays':'fp:workingDays'
  };
  const o = {};
  for (const [k,v] of Object.entries(map)){
    if (p[k]!=null) o[v] = p[k];
  }
  return o;
}

function fixedCostsMonthlyTotals(){
  const fromLS  = readFixedCostsFromLS();
  const fromURL = readFixedCostsFromURL();

  const get = (key) => {
    // URL overrides LS if present
    if (fromURL[key]!=null) return toNumber(fromURL[key]);
    const v = fromLS[key]; return v!=null ? toNumber(v) : NaN;
  };

  const iskMonth = (get('fp:housingCost')||0) + (get('fp:equipCost')||0) + (get('fp:adminCost')||0);
  const eurMonth = (get('fp:maintEurMonth')||0) + (get('fp:rentalsEurMonth')||0) + (get('fp:sparesEurMonth')||0) + (get('fp:electricityEurMonth')||0) + (get('fp:waterEurMonth')||0) + (get('fp:otherEurMonth')||0);

  // carry globals in chips
  const chipData = [];
  if (iskMonth) chipData.push({label:'ISK/month (H+E+A)', value: fmt(iskMonth,0)+' ISK'});
  if (eurMonth) chipData.push({label:'EUR/month (ops)', value: fmt(eurMonth,2)+' €'});

  // Potential defaults
  const fxFromLSorURL = get('fp:iskPerEur');
  const wdFromLSorURL = get('fp:workingDays');

  return { iskMonth, eurMonth, fxFromLSorURL, wdFromLSorURL, chipData };
}

/* ============================================================
   Computations
   - Yield triad inference
   - Factory Day breakdown
   - Key Numbers
   ============================================================ */
function computeAll(){
  // 1) Maybe set default FX or working days from LS/URL if empty
  const { iskMonth, eurMonth, fxFromLSorURL, wdFromLSorURL, chipData } = fixedCostsMonthlyTotals();

  const fxInput = document.getElementById('iskPerEur');
  if (!fxInput.value.trim() && Number.isFinite(fxFromLSorURL)) {
    fxInput.value = fmt(fxFromLSorURL,2);
  }
  const wdInput = document.getElementById('workingDays');
  if (!wdInput.value.trim() && Number.isFinite(wdFromLSorURL) && !workingDaysManual){
    wdInput.value = fmt(wdFromLSorURL,0);
  }

  // Chips info line
  const chips = document.getElementById('chipsInfo');
  chips.innerHTML = '';
  chipData.forEach(c=>{
    const span = document.createElement('span'); span.className='badge'; span.textContent = `${c.label}: ${c.value}`;
    chips.appendChild(span);
  });

  // 2) Yield triad: rawKg, yieldPct, netKg (compute if one missing)
  const rawEl = document.getElementById('rawKg');
  const yEl   = document.getElementById('yieldPct');
  const netEl = document.getElementById('netKg');

  let raw = toNumber(rawEl.value);
  let y   = toNumber(yEl.value); // %
  let net = toNumber(netEl.value);

  // If any of the three is missing, infer when possible (two known -> compute third)
  if (!Number.isFinite(net) && Number.isFinite(raw) && Number.isFinite(y)){
    net = raw * (y/100);
    netEl.value = fmt(net);
  } else if (!Number.isFinite(raw) && Number.isFinite(net) && Number.isFinite(y) && y!==0){
    raw = net / (y/100);
    rawEl.value = fmt(raw);
  } else if (!Number.isFinite(y) && Number.isFinite(net) && Number.isFinite(raw) && raw!==0){
    y = (net/raw)*100;
    yEl.value = fmt(y);
  }

  // 3) Fixed costs per day
  const wd   = toNumber(document.getElementById('workingDays').value) || 0;
  const fx   = toNumber(document.getElementById('iskPerEur').value)   || 0;

  let fcIskDay = 0, fcEurDay = 0, fcTotalDay = 0;
  if (wd > 0){
    if (iskMonth > 0 && fx > 0) fcIskDay = (iskMonth / fx) / wd; // convert ISK->EUR then per day
    if (eurMonth > 0)          fcEurDay = (eurMonth) / wd;
    fcTotalDay = fcIskDay + fcEurDay;
  }

  document.getElementById('fcIskDay').textContent   = fmt(fcIskDay);
  document.getElementById('fcEurDay').textContent   = fmt(fcEurDay);
  document.getElementById('fcTotalDay').textContent = fmt(fcTotalDay);

  // 4) Factory day variable lines
  const lines = [
    { name:'Labor — operators', id:'laborOps' },
    { name:'Labor — supervisors', id:'laborSup' },
    { name:'Materials', id:'materialsDay' },
    { name:'Pack', id:'packDay' },
    { name:'Freight', id:'freightDay' },
    { name:'Fixed (ISK→EUR/day)', id:null, value: fcIskDay },
    { name:'Fixed (EUR/day)', id:null, value: fcEurDay },
    { name:'Depreciation', id:'deprDay' }
  ];

  let dayTotal = 0;
  const fdDiv = document.getElementById('fdTotals');
  fdDiv.innerHTML = '';
  for (const line of lines){
    const amount = (line.id ? toNumber(document.getElementById(line.id).value) : line.value) || 0;
    dayTotal += amount;
    const row = document.createElement('div');
    row.className = 'line';
    row.innerHTML = `<span>${line.name}</span><strong>${fmt(amount)}</strong>`;
    fdDiv.appendChild(row);
  }
  // Total
  const totalRow = document.createElement('div');
  totalRow.className = 'line grand';
  totalRow.innerHTML = `<span>Total / day</span><strong>${fmt(dayTotal)}</strong>`;
  fdDiv.appendChild(totalRow);

  // 5) Key Numbers
  const price = toNumber(document.getElementById('pricePerKg').value);
  const revenue = (Number.isFinite(net) && Number.isFinite(price)) ? (net * price) : NaN;
  const profit  = (Number.isFinite(revenue)) ? (revenue - dayTotal) : NaN;
  const margin  = (Number.isFinite(revenue) && revenue!==0) ? (profit / revenue * 100) : NaN;
  const pPerKg  = (Number.isFinite(profit) && Number.isFinite(net) && net!==0) ? (profit / net) : NaN;

  setText('kn_netKg', fmt(net));
  setText('kn_revenue', fmt(revenue));
  setText('kn_totalCost', fmt(dayTotal));
  setText('kn_profit', fmt(profit), (profit>0?'money-ok': (profit<0?'money-bad':'')));
  setText('kn_margin', Number.isFinite(margin) ? fmt(margin) + ' %' : '–');
  setText('kn_profitPerKg', fmt(pPerKg));
}

function setText(id, text, extraClass){
  const el = document.getElementById(id);
  el.textContent = text;
  el.classList.remove('money-ok','money-bad','money-warn');
  if (extraClass) el.classList.add(extraClass);
}

/* ============================================================
   Bootstrap: initial load from URL or LS and wire events
   ============================================================ */
function loadInitialValues(){
  // Months
  fillMonthSelect();

  const params = readParams();

  // If month param present, set it
  if (params.month){
    document.getElementById('month').value = params.month;
  }
  // Set any known inputs from URL
  for (const key of URL_KEYS){
    const el = document.getElementById(key);
    if (!el) continue;
    if (params[key]!=null){
      // Format nicely on load
      const n = toNumber(params[key]);
      el.value = Number.isFinite(n) ? (el.classList.contains('num-int')? fmt(n,0): fmt(n)) : params[key];
    }
  }

  // If working days provided via fp_workingDays, prefer it if empty and not overridden yet
  const fromURL = readFixedCostsFromURL();
  if (!document.getElementById('workingDays').value && fromURL['fp:workingDays']){
    const n = toNumber(fromURL['fp:workingDays']);
    if (Number.isFinite(n)) document.getElementById('workingDays').value = fmt(n,0);
  }
}

function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

document.addEventListener('DOMContentLoaded', ()=>{
  wireFormatting();
  fillMonthSelect();
  wireWorkingDays();
  loadInitialValues();
  computeAll();

  // Recompute on changes
  document.querySelectorAll('input,select').forEach(el=>{
    el.addEventListener('change', computeAll);
    el.addEventListener('input', debounce(computeAll, 250));
  });
});
</script>
</body>
</html>
