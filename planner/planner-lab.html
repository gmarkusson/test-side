<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Factory Planner — Lab (A/B/C)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff; --card:#f9fafb; --muted:#6b7280; --text:#111827; --accent:#0ea5e9;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --border:#d1d5db; --chip:#e5e7eb;
    }
    html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0}
    .wrap{max-width:1400px;margin:40px auto;padding:0 20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{font-size:clamp(20px,3vw,28px);margin:0}
    a.button,button{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:9px 12px;font-weight:600;cursor:pointer;transition:filter .15s}
    a.button:hover,button:hover{filter:brightness(1.05)}
    .grid3{display:grid;gap:16px}
    @media(min-width:1100px){ .grid3{grid-template-columns:1fr 1fr 1fr} }
    @media(max-width:1099px){ .grid3{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .factory{display:flex;flex-direction:column;gap:12px}
    .factory h2{margin:0 0 6px 0;font-size:18px;display:flex;align-items:center;justify-content:space-between}
    .row{display:grid;grid-template-columns:170px 1fr;gap:10px;align-items:center;margin:6px 0}
    label{color:var(--muted)}
    input[type="text"],select{width:100%;background:#fff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:9px 10px;font-size:14px;outline:none}
    input[type="text"]:focus,select:focus{border-color:var(--accent)}
    .small{font-size:12px;color:var(--muted)}
    .totals{display:grid;gap:6px}
    .line{display:flex;justify-content:space-between;border-bottom:1px dashed var(--border);padding:5px 0}
    .badge{padding:4px 8px;border-radius:8px;background:var(--chip);border:1px solid var(--border);font-size:12px}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .split{display:grid;row-gap:10px;column-gap:28px}
    @media(min-width:520px){ .split{grid-template-columns:1fr 1fr} }
    hr{border:none;border-top:1px solid var(--border);margin:10px 0}
    .compare{margin-top:18px}
    .compare table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .compare th,.compare td{padding:8px 10px;text-align:left}
    .compare th{color:var(--muted);font-weight:600;font-size:13px}
    .chip{display:inline-block;background:var(--chip);border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}
    .factory .split .row { grid-template-columns: 150px auto; }
    input.short { width:160px; min-width:160px; }
    .row input.short { justify-self:start; box-sizing:border-box; }
    @media (max-width:640px){ input.short { width:100%; min-width:0; } }
    .selected-month { margin-top:4px; color:var(--muted); font-style:italic; }
    .readonly{background:#f3f4f6}
    .money-ok{color:var(--ok)} .money-bad{color:var(--bad)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Factory Planner — Lab (A/B/C)</h1>
    <div class="stack">
      <a class="button" href="index.html">Back to Planner</a>
      <a class="button" href="fixed-costs.html">Fixed Costs</a>
      <span class="chip">Locale: <strong>is-IS</strong></span>
    </div>
  </header>

  <section class="grid3">
    <!-- ========================= FACTORY A (Salmon) ========================= -->
    <div class="card factory" id="fxA" data-factory="A">
      <h2>Salmon <span class="badge" data-badge="A">Ready</span></h2>
      <div class="split">
        <div>
          <div class="row">
            <label>Month</label>
            <div>
              <select class="month"></select>
              <div class="selected-month small"></div>
            </div>
          </div>
          <div class="row"><label>Working days</label><input type="text" class="num num-int workingDays" placeholder="auto from month"></div>
          <div class="small">Auto weekdays (Mon–Fri) for <span class="yr"></span>. Manual edit overrides auto.</div>
        </div>
        <div>
          <div class="row">
            <label title="1 € costs this many ISK">ISK per EUR</label>
            <input type="text" class="num iskPerEur short" placeholder="e.g. 153,50" aria-describedby="fxA-help-isk">
          </div>
          <div id="fxA-help-isk" class="small">1 € = this many ISK (used to convert ISK monthly costs to EUR/day).</div>

          <div class="row"><label>DV hours (daytime)</label><input type="text" class="num dvHours short" placeholder="e.g. 120"></div>
          <div class="row"><label>YV hours (overtime)</label><input type="text" class="num yvHours short" placeholder="e.g. 20"></div>
          <div class="row"><label>Labor from hours (ISK/day)</label><input type="text" class="num laborFromHoursDay readonly short" readonly></div>
        </div>
      </div>

      <hr>

      <div class="split">
        <div>
          <div class="row">
            <label>Net saleable kg</label>
            <input type="text" class="num num-int netKg" placeholder="e.g. 1.000">
          </div>
          <div class="row">
            <label>Yield %</label>
            <input type="text" class="num yieldPct" placeholder="e.g. 63,5">
          </div>
          <div class="row">
            <label>Raw used kg</label>
            <input type="text" class="num num-int rawKg" placeholder="auto from net & yield (or enter)">
          </div>
        </div>
        <div>
          <div class="row"><label>Price (EUR/kg)</label><input type="text" class="num pricePerKg short" placeholder="e.g. 6,90"></div>
          <div class="row"><label>Raw material cost (EUR/kg raw)</label><input type="text" class="num rawCostPerKg short" placeholder="e.g. 3,20"></div>

          <div class="row"><label>Materials</label><input type="text" class="num materialsDay" placeholder="EUR/day"></div>
          <div class="row"><label>Pack</label><input type="text" class="num packDay" placeholder="EUR/day"></div>
          <div class="row"><label>Freight</label><input type="text" class="num freightDay" placeholder="EUR/day"></div>
          <div class="row"><label>Depreciation</label><input type="text" class="num deprDay" placeholder="EUR/day"></div>
        </div>
      </div>

      <div class="row" style="margin-top:4px">
        <label>Fixed costs (per day)</label>
        <div class="stack">
          <span class="badge">ISK→EUR/day: <span class="fcIskDay">–</span></span>
          <span class="badge">EUR/day: <span class="fcEurDay">–</span></span>
          <span class="badge">Total fixed/day: <span class="fcTotalDay">–</span></span>
        </div>
      </div>

      <div class="card" style="padding:10px">
        <div class="totals">
          <div class="line"><span>Revenue (EUR)</span><strong class="kn_revenue">–</strong></div>
          <div class="line"><span>Total cost (EUR/day)</span><strong class="kn_totalCost">–</strong></div>
          <div class="line"><span>Profit (EUR/day)</span><strong class="kn_profit">–</strong></div>
          <div class="line"><span>Gross margin %</span><strong class="kn_margin">–</strong></div>
          <div class="line"><span>Profit / kg (EUR)</span><strong class="kn_profitPerKg">–</strong></div>
        </div>
      </div>
    </div>

    <!-- ========================= FACTORY B ========================= -->
    <div class="card factory" id="fxB" data-factory="B">
      <h2>Factory B <span class="badge" data-badge="B">Ready</span></h2>
      <div class="split">
        <div>
          <div class="row">
            <label>Month</label>
            <div>
              <select class="month"></select>
              <div class="selected-month small"></div>
            </div>
          </div>
          <div class="row"><label>Working days</label><input type="text" class="num num-int workingDays" placeholder="auto from month"></div>
          <div class="small">Auto weekdays (Mon–Fri) for <span class="yr"></span>. Manual edit overrides auto.</div>
        </div>
        <div>
          <div class="row">
            <label title="1 € costs this many ISK">ISK per EUR</label>
            <input type="text" class="num iskPerEur short" placeholder="e.g. 153,50" aria-describedby="fxB-help-isk">
          </div>
          <div id="fxB-help-isk" class="small">1 € = this many ISK (used to convert ISK monthly costs to EUR/day).</div>

          <div class="row"><label>DV hours (daytime)</label><input type="text" class="num dvHours short" placeholder="e.g. 120"></div>
          <div class="row"><label>YV hours (overtime)</label><input type="text" class="num yvHours short" placeholder="e.g. 20"></div>
          <div class="row"><label>Labor from hours (ISK/day)</label><input type="text" class="num laborFromHoursDay readonly short" readonly></div>
        </div>
      </div>

      <hr>

      <div class="split">
        <div>
          <div class="row">
            <label>Net saleable kg</label>
            <input type="text" class="num num-int netKg" placeholder="e.g. 1.000">
          </div>
          <div class="row">
            <label>Yield %</label>
            <input type="text" class="num yieldPct" placeholder="e.g. 63,5">
          </div>
          <div class="row">
            <label>Raw used kg</label>
            <input type="text" class="num num-int rawKg" placeholder="auto from net & yield (or enter)">
          </div>
        </div>
        <div>
          <div class="row"><label>Price (EUR/kg)</label><input type="text" class="num pricePerKg short" placeholder="e.g. 6,90"></div>
          <div class="row"><label>Raw material cost (EUR/kg raw)</label><input type="text" class="num rawCostPerKg short" placeholder="e.g. 3,20"></div>

          <div class="row"><label>Materials</label><input type="text" class="num materialsDay" placeholder="EUR/day"></div>
          <div class="row"><label>Pack</label><input type="text" class="num packDay" placeholder="EUR/day"></div>
          <div class="row"><label>Freight</label><input type="text" class="num freightDay" placeholder="EUR/day"></div>
          <div class="row"><label>Depreciation</label><input type="text" class="num deprDay" placeholder="EUR/day"></div>
        </div>
      </div>

      <div class="row" style="margin-top:4px">
        <label>Fixed costs (per day)</label>
        <div class="stack">
          <span class="badge">ISK→EUR/day: <span class="fcIskDay">–</span></span>
          <span class="badge">EUR/day: <span class="fcEurDay">–</span></span>
          <span class="badge">Total fixed/day: <span class="fcTotalDay">–</span></span>
        </div>
      </div>

      <div class="card" style="padding:10px">
        <div class="totals">
          <div class="line"><span>Revenue (EUR)</span><strong class="kn_revenue">–</strong></div>
          <div class="line"><span>Total cost (EUR/day)</span><strong class="kn_totalCost">–</strong></div>
          <div class="line"><span>Profit (EUR/day)</span><strong class="kn_profit">–</strong></div>
          <div class="line"><span>Gross margin %</span><strong class="kn_margin">–</strong></div>
          <div class="line"><span>Profit / kg (EUR)</span><strong class="kn_profitPerKg">–</strong></div>
        </div>
      </div>
    </div>

    <!-- ========================= FACTORY C ========================= -->
    <div class="card factory" id="fxC" data-factory="C">
      <h2>Factory C <span class="badge" data-badge="C">Ready</span></h2>
      <div class="split">
        <div>
          <div class="row">
            <label>Month</label>
            <div>
              <select class="month"></select>
              <div class="selected-month small"></div>
            </div>
          </div>
          <div class="row"><label>Working days</label><input type="text" class="num num-int workingDays" placeholder="auto from month"></div>
          <div class="small">Auto weekdays (Mon–Fri) for <span class="yr"></span>. Manual edit overrides auto.</div>
        </div>
        <div>
          <div class="row">
            <label title="1 € costs this many ISK">ISK per EUR</label>
            <input type="text" class="num iskPerEur short" placeholder="e.g. 153,50" aria-describedby="fxC-help-isk">
          </div>
          <div id="fxC-help-isk" class="small">1 € = this many ISK (used to convert ISK monthly costs to EUR/day).</div>

          <div class="row"><label>DV hours (daytime)</label><input type="text" class="num dvHours short" placeholder="e.g. 120"></div>
          <div class="row"><label>YV hours (overtime)</label><input type="text" class="num yvHours short" placeholder="e.g. 20"></div>
          <div class="row"><label>Labor from hours (ISK/day)</label><input type="text" class="num laborFromHoursDay readonly short" readonly></div>
        </div>
      </div>

      <hr>

      <div class="split">
        <div>
          <div class="row">
            <label>Net saleable kg</label>
            <input type="text" class="num num-int netKg" placeholder="e.g. 1.000">
          </div>
          <div class="row">
            <label>Yield %</label>
            <input type="text" class="num yieldPct" placeholder="e.g. 63,5">
          </div>
          <div class="row">
            <label>Raw used kg</label>
            <input type="text" class="num num-int rawKg" placeholder="auto from net & yield (or enter)">
          </div>
        </div>
        <div>
          <div class="row"><label>Price (EUR/kg)</label><input type="text" class="num pricePerKg short" placeholder="e.g. 6,90"></div>
          <div class="row"><label>Raw material cost (EUR/kg raw)</label><input type="text" class="num rawCostPerKg short" placeholder="e.g. 3,20"></div>

          <div class="row"><label>Materials</label><input type="text" class="num materialsDay" placeholder="EUR/day"></div>
          <div class="row"><label>Pack</label><input type="text" class="num packDay" placeholder="EUR/day"></div>
          <div class="row"><label>Freight</label><input type="text" class="num freightDay" placeholder="EUR/day"></div>
          <div class="row"><label>Depreciation</label><input type="text" class="num deprDay" placeholder="EUR/day"></div>
        </div>
      </div>

      <div class="row" style="margin-top:4px">
        <label>Fixed costs (per day)</label>
        <div class="stack">
          <span class="badge">ISK→EUR/day: <span class="fcIskDay">–</span></span>
          <span class="badge">EUR/day: <span class="fcEurDay">–</span></span>
          <span class="badge">Total fixed/day: <span class="fcTotalDay">–</span></span>
        </div>
      </div>

      <div class="card" style="padding:10px">
        <div class="totals">
          <div class="line"><span>Revenue (EUR)</span><strong class="kn_revenue">–</strong></div>
          <div class="line"><span>Total cost (EUR/day)</span><strong class="kn_totalCost">–</strong></div>
          <div class="line"><span>Profit (EUR/day)</span><strong class="kn_profit">–</strong></div>
          <div class="line"><span>Gross margin %</span><strong class="kn_margin">–</strong></div>
          <div class="line"><span>Profit / kg (EUR)</span><strong class="kn_profitPerKg">–</strong></div>
        </div>
      </div>
    </div>
  </section>

  <section class="card compare">
    <h2 style="margin:0 0 6px 0">Quick comparison</h2>
    <div class="small" style="margin-bottom:6px">Updates live as you type.</div>
    <div class="stack" id="chips"></div>
    <div style="overflow:auto;margin-top:8px">
      <table>
        <thead>
          <tr><th>Factory</th><th>Net kg</th><th>Revenue (€/day)</th><th>Total cost (€/day)</th><th>Profit (€/day)</th><th>Margin %</th><th>€/kg</th></tr>
        </thead>
        <tbody id="cmpBody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/* ===== Shared helpers (is-IS locale) ===== */
const LOCALE='is-IS';

function toNumber(value){
  if (value == null) return NaN;
  if (typeof value === 'number') return value;

  // Remove ALL common Unicode space separators (incl. NBSP, narrow NBSP, thin, figure, ideographic)
  let s = (''+value)
    .replace(/[\s\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g, '')
    .trim();
  if (s === '') return NaN;

  const hasComma = s.includes(','), hasDot = s.includes('.');
  if (hasComma && hasDot){
    const lastComma = s.lastIndexOf(','), lastDot = s.lastIndexOf('.');
    // Assume the last separator is decimal; remove the others as thousands
    s = (lastComma > lastDot) ? s.replace(/\./g,'').replace(',', '.') : s.replace(/,/g,'');
  } else if (hasComma){
    const commas = (s.match(/,/g)||[]).length;
    if (commas > 1){
      const last = s.lastIndexOf(',');
      s = s.slice(0,last).replace(/,/g,'') + '.' + s.slice(last+1);
    } else {
      // Single comma: infer decimal unless exactly 3 digits follow (then it's thousands)
      const idx = s.indexOf(','), fracLen = s.length - idx - 1;
      s = (fracLen === 3) ? s.replace(/,/g,'') : s.replace(',', '.');
    }
  } else if (hasDot){
    const dots = (s.match(/\./g)||[]).length;
    if (dots > 1){
      const last = s.lastIndexOf('.');
      s = s.slice(0,last).replace(/\./g,'') + '.' + s.slice(last+1);
    } else {
      // Single dot: if exactly 3 digits follow, treat as thousands (remove)
      const idx = s.indexOf('.'), fracLen = s.length - idx - 1;
      if (fracLen === 3) s = s.replace(/\./g,'');
    }
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}


function fmt(n,dec){
  if (!Number.isFinite(n)) return '–';
  return new Intl.NumberFormat(LOCALE, typeof dec==='number'
    ? { minimumFractionDigits: dec, maximumFractionDigits: dec }
    : (Number.isInteger(n) ? { maximumFractionDigits: 0 } : { maximumFractionDigits: 2 })
  ).format(n);
}

function fmtInt(n){
  if (!Number.isFinite(n)) return '–';
  return new Intl.NumberFormat(LOCALE, { maximumFractionDigits: 0 }).format(n);
}

function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

/* ===== URL sync (A_, B_, C_) ===== */
const FACTORIES=['A','B','C'];
const FIELD_KEYS = [
  'month','workingDays','iskPerEur',
  'dvHours','yvHours',
  'netKg','yieldPct','rawKg',
  'pricePerKg','rawCostPerKg',
  'materialsDay','packDay','freightDay','deprDay'
];
let urlUpdateQueued=false;
function readParams(){ return new URLSearchParams(location.search); }
function setParamsFromDOM(){
  const sp=new URLSearchParams(), current=readParams();
  const carry=['fp_housingCost','fp_equipCost','fp_adminCost','fp_maintEurMonth','fp_rentalsEurMonth','fp_sparesEurMonth','fp_electricityEurMonth','fp_waterEurMonth','fp_otherEurMonth','fp_iskPerEur','fp_workingDays','fp_dvRateISK','fp_yvRateISK'];
  carry.forEach(k=>{ if(current.get(k)!=null) sp.set(k, current.get(k)); });
  for (const f of FACTORIES){
    const root=document.getElementById('fx'+f);
    for (const key of FIELD_KEYS){
      const el=root.querySelector('.'+key);
      if (!el) continue;
      const val=(el.value||'').trim();
      if (val) sp.set(`${f}_${key}`, val);
    }
  }
  const qs=sp.toString(); history.replaceState(null,'', qs?('?'+qs):location.pathname);
}
function scheduleURLUpdate(){ if(urlUpdateQueued) return; urlUpdateQueued=true; requestAnimationFrame(()=>{ setParamsFromDOM(); urlUpdateQueued=false; }); }

/* ===== Fixed-costs interop ===== */
const LS_KEYS=['fp:housingCost','fp:equipCost','fp:adminCost','fp:maintEurMonth','fp:rentalsEurMonth','fp:sparesEurMonth','fp:electricityEurMonth','fp:waterEurMonth','fp:otherEurMonth','fp:iskPerEur','fp:workingDays','fp:dvRateISK','fp:yvRateISK'];
function readFixedFromLS(){ const o={}; for(const k of LS_KEYS){ const v=localStorage.getItem(k); if(v!=null) o[k]=v; } return o; }
function readFixedFromURL(){
  const p=readParams(); const map={
    'fp_housingCost':'fp:housingCost','fp_equipCost':'fp:equipCost','fp_adminCost':'fp:adminCost',
    'fp_maintEurMonth':'fp:maintEurMonth','fp_rentalsEurMonth':'fp:rentalsEurMonth','fp_sparesEurMonth':'fp:sparesEurMonth',
    'fp_electricityEurMonth':'fp:electricityEurMonth','fp_waterEurMonth':'fp:waterEurMonth','fp_otherEurMonth':'fp:otherEurMonth',
    'fp_iskPerEur':'fp:iskPerEur','fp_workingDays':'fp:workingDays',
    'fp_dvRateISK':'fp:dvRateISK','fp_yvRateISK':'fp:yvRateISK'
  };
  const o={}; for(const [k,v] of Object.entries(map)){ if(p.get(k)!=null) o[v]=p.get(k); } return o;
}
function fixedMonthlyTotals(){
  const fromLS=readFixedFromLS(), fromURL=readFixedFromURL();
  const get=(key)=> (fromURL[key]!=null ? toNumber(fromURL[key]) : (fromLS[key]!=null ? toNumber(fromLS[key]) : NaN));
  const iskMonth=(get('fp:housingCost')||0)+(get('fp:equipCost')||0)+(get('fp:adminCost')||0);
  const eurMonth=(get('fp:maintEurMonth')||0)+(get('fp:rentalsEurMonth')||0)+(get('fp:sparesEurMonth')||0)+(get('fp:electricityEurMonth')||0)+(get('fp:waterEurMonth')||0)+(get('fp:otherEurMonth')||0);
  return { iskMonth, eurMonth, fxDefault:get('fp:iskPerEur'), wdDefault:get('fp:workingDays'), dvRateISK:get('fp:dvRateISK'), yvRateISK:get('fp:yvRateISK')};
}

/* ===== Factory controller ===== */
class FactoryPane{
  constructor(root){
    this.root = root;
    this.id = root.dataset.factory;
    this.year = new Date().getFullYear();
    this.manualWD = false;

    this.bindRefs();
    this.fillMonthSelect();
    this.wireFormatting();
    this.wireLogic();
    this.loadFromURL();
    this.applyDefaultsFromFixed();
    this.refs.month.dispatchEvent(new Event('change')); // set selected-month + auto WD
    this.compute();
  }

  bindRefs(){
    const q = sel => this.root.querySelector(sel);
    this.refs = {
      month:q('.month'), workingDays:q('.workingDays'),
      iskPerEur:q('.iskPerEur'),
      dvHours:q('.dvHours'), yvHours:q('.yvHours'),
      laborFromHoursDay:q('.laborFromHoursDay'),
      // production block
      netKg:q('.netKg'), yieldPct:q('.yieldPct'), rawKg:q('.rawKg'),
      pricePerKg:q('.pricePerKg'), rawCostPerKg:q('.rawCostPerKg'),
      // other day costs
      materialsDay:q('.materialsDay'), packDay:q('.packDay'),
      freightDay:q('.freightDay'), deprDay:q('.deprDay'),
      // fixed + totals
      yr:q('.yr'), fcIskDay:q('.fcIskDay'), fcEurDay:q('.fcEurDay'), fcTotalDay:q('.fcTotalDay'),
      kn_revenue:q('.kn_revenue'), kn_totalCost:q('.kn_totalCost'), kn_profit:q('.kn_profit'),
      kn_margin:q('.kn_margin'), kn_profitPerKg:q('.kn_profitPerKg'),
      badge:this.root.querySelector(`[data-badge="${this.id}"]`),
      selectedMonth:q('.selected-month')
    };
    if (!this.refs.yr){
      const l=this.root.querySelector('.small');
      if(l){ const s=document.createElement('span'); s.className='yr'; l.prepend(s); this.refs.yr=s; }
    }
    this.refs.yr.textContent = this.year;
  }

  fillMonthSelect(){
    const names=[];
    for(let m=0;m<12;m++){
      names.push(new Intl.DateTimeFormat(LOCALE,{month:'long'}).format(new Date(this.year,m,1)));
    }
    this.refs.month.innerHTML =
      `<option value="">— choose —</option>` +
      names.map((n,i)=>`<option value="${i+1}">${n.charAt(0).toUpperCase()+n.slice(1)}</option>`).join('');
  }

  calcWorkingDays(month1to12){
    const m=(month1to12|0)-1; if(m<0) return NaN;
    let d=new Date(this.year,m,1), days=0;
    while(d.getMonth()===m){ const wd=d.getDay(); if(wd>=1&&wd<=5) days++; d.setDate(d.getDate()+1); }
    return days;
  }

 wireFormatting(){
  // don't attach formatting to readonly computed fields
  this.root.querySelectorAll('input.num:not(.readonly)').forEach(inp=>{
    inp.addEventListener('focus', ()=>{
      const n=toNumber(inp.value);
      if(Number.isFinite(n)){
        if(inp.classList.contains('num-int')) inp.value=String(Math.trunc(n));
        else inp.value=String(n).replace(/(?<=\d)\.0+$/,'');
      }
    });
    inp.addEventListener('blur', ()=>{
      const n=toNumber(inp.value);
      const isYield = inp.classList.contains('yieldPct');
      const isInt=inp.classList.contains('num-int');
      // Yield always 2 decimals on blur; others: int->0, else adaptive
      inp.value=Number.isFinite(n)?fmt(n, isYield ? 2 : (isInt?0:undefined)):'';
      scheduleURLUpdate();
      this.compute();
    });
    inp.addEventListener('input', debounce(()=>{ scheduleURLUpdate(); this.compute(); },250));
  });
}


  wireLogic(){
    const updateSelectedMonth = () => {
      const sel = this.refs.month;
      const txt = sel.options[sel.selectedIndex]?.text || '';
      if (this.refs.selectedMonth) this.refs.selectedMonth.textContent = txt ? `Selected: ${txt}` : '';
    };

    this.refs.month.addEventListener('change', ()=>{
      const mv = toNumber(this.refs.month.value);
      updateSelectedMonth();
      if(mv>=1 && mv<=12){
        const auto = this.calcWorkingDays(mv);
        if(!this.manualWD || !this.refs.workingDays.value.trim()){
          this.refs.workingDays.value = fmt(auto,0);
        }
        scheduleURLUpdate();
        this.compute();
      }
    });
    this.refs.workingDays.addEventListener('input', ()=>{ this.manualWD=true; });

    this.root.querySelectorAll('input,select').forEach(el=>{
      el.addEventListener('change', ()=>this.compute());
      el.addEventListener('input', debounce(()=>this.compute(),200));
    });

    updateSelectedMonth();
  }

  loadFromURL(){
    const sp = readParams();
    for(const key of FIELD_KEYS){
      const val = sp.get(`${this.id}_${key}`);
      if(val!=null){
        const el = this.refs[key];
        if(el){
          const n = toNumber(val);
          el.value = Number.isFinite(n)
            ? fmt(n, el.classList.contains('num-int')?0:undefined)
            : val;
        }
      }
    }
  }

  applyDefaultsFromFixed(){
    const { fxDefault, wdDefault }=fixedMonthlyTotals();
    if(!this.refs.iskPerEur.value && Number.isFinite(fxDefault)) this.refs.iskPerEur.value=fmt(fxDefault,2);
    if(!this.refs.workingDays.value && Number.isFinite(wdDefault) && !this.manualWD) this.refs.workingDays.value=fmt(wdDefault,0);
  }

  fixedPerDay(){
    const { iskMonth, eurMonth }=fixedMonthlyTotals();
    const wd=toNumber(this.refs.workingDays.value)||0;
    const fx=toNumber(this.refs.iskPerEur.value)||0;
    let iskDay=0, eurDay=0, total=0;
    if(wd>0){
      if(iskMonth>0 && fx>0) iskDay=(iskMonth/fx)/wd;
      if(eurMonth>0) eurDay=eurMonth/wd;
      total=iskDay+eurDay;
    }
    this.refs.fcIskDay.textContent=fmt(iskDay);
    this.refs.fcEurDay.textContent=fmt(eurDay);
    this.refs.fcTotalDay.textContent=fmt(total);
    return { iskDay, eurDay, total };
  }

  // Labor from hours – convert ISK to EUR/day for cost, show ISK/day in the readonly field
  laborFromHoursCosts(){
    const dvH = toNumber(this.refs.dvHours.value) || 0;
    const yvH = toNumber(this.refs.yvHours.value) || 0;
    const { dvRateISK, yvRateISK } = fixedMonthlyTotals();
    const dvR = Number.isFinite(dvRateISK) ? dvRateISK : 0;
    const yvR = Number.isFinite(yvRateISK) ? yvRateISK : 0;
    const fx  = toNumber(this.refs.iskPerEur.value) || 0;

    const iskDay = (dvH * dvR) + (yvH * yvR);
    const eurDay = fx > 0 ? (iskDay / fx) : 0;

    this.refs.laborFromHoursDay.value = Number.isFinite(iskDay) ? fmt(iskDay) : '';
    return { iskDay, eurDay };
  }

  compute(){
    // --- Net, Yield, Raw relationship (net+yield drives raw) ---
    let n  = toNumber(this.refs.netKg.value);
    let yy = toNumber(this.refs.yieldPct.value);
    let r  = toNumber(this.refs.rawKg.value);

    if (Number.isFinite(n) && Number.isFinite(yy) && yy !== 0) {
  r = n / (yy / 100);
  this.refs.rawKg.value = fmtInt(r);
} 
else if (Number.isFinite(r) && Number.isFinite(yy)) {
  n = r * (yy / 100);
  this.refs.netKg.value = fmtInt(n);
} 
else if (Number.isFinite(n) && Number.isFinite(r) && r !== 0) {
  yy = (n / r) * 100;
}

// Show Yield with two decimals, but don't fight the user while typing
if (Number.isFinite(yy) && document.activeElement !== this.refs.yieldPct) {
  this.refs.yieldPct.value = fmt(yy, 2);
}

    const price=toNumber(this.refs.pricePerKg.value);
    const rawCostPerKg=toNumber(this.refs.rawCostPerKg.value);
    const rawCostDay = (Number.isFinite(r) && Number.isFinite(rawCostPerKg)) ? (r * rawCostPerKg) : 0;

    const { total: fixedDay }=this.fixedPerDay();
    const { eurDay: laborHoursEUR } = this.laborFromHoursCosts();

    const parts=[
      rawCostDay || 0,
      toNumber(this.refs.materialsDay.value)||0,
      toNumber(this.refs.packDay.value)||0,
      toNumber(this.refs.freightDay.value)||0,
      toNumber(this.refs.deprDay.value)||0,
      laborHoursEUR||0,
      fixedDay||0
    ];
    const dayCost=parts.reduce((a,b)=>a+b,0);

    const revenue=(Number.isFinite(n) && Number.isFinite(price)) ? (n*price) : NaN;
    const profit=(Number.isFinite(revenue) ? (revenue-dayCost) : NaN);
    const margin=(Number.isFinite(revenue) && revenue!==0) ? (profit/revenue*100) : NaN;
    const pPerKg=(Number.isFinite(profit) && Number.isFinite(n) && n!==0) ? (profit/n) : NaN;

    this.setText(this.refs.kn_revenue, fmt(revenue));
    this.setText(this.refs.kn_totalCost, fmt(dayCost));
    this.setText(this.refs.kn_profit, fmt(profit), profit>0?'money-ok':(profit<0?'money-bad':''));
    this.setText(this.refs.kn_margin, Number.isFinite(margin)?fmt(margin)+' %':'–');
    this.setText(this.refs.kn_profitPerKg, fmt(pPerKg));

    this.refs.badge.textContent = (Number.isFinite(revenue) && Number.isFinite(dayCost)) ? 'Calculated' : 'Ready';
updateCompare(this.id, { netKg: n, revenue, totalCost: dayCost, profit, margin, pPerKg });

// Make sure URL reflects any auto-filled values (net/raw/yield)
scheduleURLUpdate();
}

  setText(el,text,extra){ el.textContent=text; el.classList.remove('money-ok','money-bad'); if(extra) el.classList.add(extra); }
}

/* ===== Compare table ===== */
const compareState={ A:{}, B:{}, C:{} };
function updateCompare(id,vals){
  compareState[id]=vals;
  const tbody=document.getElementById('cmpBody'); tbody.innerHTML='';
  for(const f of FACTORIES){
    const v=compareState[f]||{};
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><strong>${f}</strong></td>
      <td>${fmtInt(v.netKg)}</td>
      <td>${fmt(v.revenue)}</td>
      <td>${fmt(v.totalCost)}</td>
      <td class="${(v.profit>0)?'money-ok':(v.profit<0?'money-bad':'')}">${fmt(v.profit)}</td>
      <td>${Number.isFinite(v.margin)? fmt(v.margin)+' %' : '–'}</td>
      <td>${fmt(v.pPerKg)}</td>
    `;
    tbody.appendChild(tr);
  }
  const { iskMonth, eurMonth }=fixedMonthlyTotals();
  const chips=document.getElementById('chips'); chips.innerHTML='';
  if(iskMonth) chips.appendChild(chip(`ISK/month (H+E+A): ${fmt(iskMonth,0)} ISK`));
  if(eurMonth) chips.appendChild(chip(`EUR/month (ops): ${fmt(eurMonth,2)} €`));
}

function chip(text){ const s=document.createElement('span'); s.className='chip'; s.textContent=text; return s; }

/* ===== Bootstrap ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  for (const f of FACTORIES){ new FactoryPane(document.getElementById('fx'+f)); }
  updateCompare('A', compareState.A);
});
</script>
</body>
</html>
