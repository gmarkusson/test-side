<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Factory Planner — Fixed Costs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
 <style>
  :root{
    --bg:#ffffff; --card:#f9fafb; --muted:#6b7280; --text:#111827; --accent:#0ea5e9;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --border:#d1d5db; --chip:#e5e7eb;
  }

  html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0}
  .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  h1{font-size:clamp(20px,3vw,28px);margin:0}

 /* Primary buttons only */
.btn{
  background:var(--accent); color:#fff; border:none; border-radius:10px;
  padding:9px 12px; font-weight:600; cursor:pointer; transition:filter .15s;
}
.btn:hover{ filter:brightness(1.05) }
/* Quiet remove-row button (the little × in each row) */
table .danger{
  background:var(--chip);
  color:var(--muted);
  border:1px solid var(--border);
  width:32px; height:32px; padding:0;
  border-radius:8px;
  display:flex; align-items:center; justify-content:center;
  font-weight:700; line-height:1;
}
table .danger:hover{
  background:#fff;
  color:var(--bad);
  border-color:var(--bad);
}

  /* cards/tables */
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:980px){ .grid{grid-template-columns:1fr 1fr} }
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:8px 10px;text-align:left}
  th{color:var(--muted);font-weight:600;font-size:13px}
  td .row{display:flex;gap:8px;align-items:center}
  label{color:var(--muted)}

  /* inputs to match Lab (light fields) */
  input[type="text"]{
    width:100%;background:#fff;color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:9px 10px;font-size:14px;outline:none;
  }
  input[type="text"]:focus{border-color:var(--accent)}

  .muted{color:var(--muted);font-size:12px}
  .subtotal{font-weight:700}

  /* chips/pills same look as Lab’s badges */
  .pill{display:inline-block;background:var(--chip);border:1px solid var(--border);
        padding:5px 8px;border-radius:999px;font-size:12px;margin-left:8px}
  .inline{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .ok{color:var(--ok);font-weight:700}
</style>

</head>
<body>
<div class="wrap">
  <header>
    <h1>Fixed Costs — Monthly</h1>
    <div class="inline">
  <button id="copyToPlanner" class="btn">Copy to Planner URL</button>
  <a class="btn" href="index.html">Open Planner</a>
  <a class="btn" href="lab.html">Open Planner — Lab</a>
</div>
  </header>

  <!-- ===== Globals ===== -->
  <section class="card">
    <div class="inline" style="justify-content:space-between;align-items:flex-start">
      <div style="flex:1 1 auto">
        <div class="muted">Globals</div>
        <div class="inline" style="margin-top:6px">
          <label class="muted" for="iskPerEur">ISK per EUR</label>
          <input type="text" id="iskPerEur" class="num" inputmode="decimal" placeholder="e.g. 153,50" style="width:140px">

          <span class="spacer"></span>

          <label class="muted" for="workingDays">Working days (optional)</label>
          <input type="text" id="workingDays" class="num num-int" inputmode="decimal" placeholder="e.g. 21" style="width:120px">
        </div>

        <div class="inline" style="margin-top:10px">
          <label class="muted" for="dvRateISK">Daytime hourly rate (ISK/hour)</label>
          <input type="text" id="dvRateISK" class="num" inputmode="decimal" placeholder="e.g. 3.800" style="width:150px">

          <span class="spacer"></span>

          <label class="muted" for="yvRateISK">Overtime hourly rate (ISK/hour)</label>
          <input type="text" id="yvRateISK" class="num" inputmode="decimal" placeholder="e.g. 5.400" style="width:150px">
        </div>
      </div>
      <span class="pill">Locale: is-IS</span>
    </div>
  </section>

  <!-- ===== ISK/month per building ===== -->
  <section class="grid">
    <div class="card" id="iskA">
      <h2 style="margin:0 0 8px 0">Building A — ISK/month</h2>
      <table data-building="A" data-currency="ISK">
        <thead><tr><th>Category</th><th>Amount (ISK)</th><th></th></tr></thead>
        <tbody></tbody>
        <tfoot>
          <tr><td class="subtotal">Subtotal (A)</td><td class="subtotal" data-subtotal="A-ISK">–</td><td></td></tr>
        </tfoot>
      </table>
      <div class="inline" style="margin-top:6px">
        <button class="btn" data-add="A-ISK">Add row</button>
      </div>
      <div class="muted">Categories counted in ISK totals: <strong>housing</strong>, <strong>equipment</strong>, <strong>admin</strong>.</div>
    </div>

    <div class="card" id="iskB">
      <h2 style="margin:0 0 8px 0">Building B — ISK/month</h2>
      <table data-building="B" data-currency="ISK">
        <thead><tr><th>Category</th><th>Amount (ISK)</th><th></th></tr></thead>
        <tbody></tbody>
        <tfoot>
          <tr><td class="subtotal">Subtotal (B)</td><td class="subtotal" data-subtotal="B-ISK">–</td><td></td></tr>
        </tfoot>
      </table>
      <div class="inline" style="margin-top:6px">
        <button class="btn" data-add="B-ISK">Add row</button>
      </div>
      <div class="muted">Use category names “housing / equipment / admin” (case-insensitive). Extra ISK rows are allowed and will be ignored for totals if not matching.</div>
    </div>
  </section>

  <!-- ===== EUR/month per building ===== -->
  <section class="grid">
    <div class="card" id="eurA">
      <h2 style="margin:0 0 8px 0">Building A — EUR/month</h2>
      <table data-building="A" data-currency="EUR">
        <thead><tr><th>Category</th><th>Amount (EUR)</th><th></th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td class="subtotal">Subtotal (A)</td><td class="subtotal" data-subtotal="A-EUR">–</td><td></td></tr></tfoot>
      </table>
      <div class="inline" style="margin-top:6px">
        <button class="btn" data-add="A-EUR">Add row</button>
      </div>
      <div class="muted">EUR categories counted toward totals: <strong>maintenance</strong>, <strong>rentals</strong>, <strong>spares</strong>, <strong>electricity</strong>, <strong>water</strong>, <strong>other</strong>.</div>
    </div>

    <div class="card" id="eurB">
      <h2 style="margin:0 0 8px 0">Building B — EUR/month</h2>
      <table data-building="B" data-currency="EUR">
        <thead><tr><th>Category</th><th>Amount (EUR)</th><th></th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td class="subtotal">Subtotal (B)</td><td class="subtotal" data-subtotal="B-EUR">–</td><td></td></tr></tfoot>
      </table>
      <div class="inline" style="margin-top:6px">
        <button class="btn" data-add="B-EUR">Add row</button>
      </div>
    </div>
  </section>

  <!-- ===== Aggregated totals (and saved globals preview) ===== -->
  <section class="card">
    <h2 style="margin:0 0 8px 0">Aggregated totals (saved)</h2>
    <div class="inline" style="gap:18px">
      <div>ISK/month →
        <span class="pill">housing: <strong id="t_housing">–</strong></span>
        <span class="pill">equipment: <strong id="t_equip">–</strong></span>
        <span class="pill">admin: <strong id="t_admin">–</strong></span>
      </div>
    </div>
    <div class="inline" style="gap:12px;margin-top:10px">
      <div>EUR/month →
        <span class="pill">maintenance: <strong id="t_maint">–</strong></span>
        <span class="pill">rentals: <strong id="t_rentals">–</strong></span>
        <span class="pill">spares: <strong id="t_spares">–</strong></span>
        <span class="pill">electricity: <strong id="t_elec">–</strong></span>
        <span class="pill">water: <strong id="t_water">–</strong></span>
        <span class="pill">other: <strong id="t_other">–</strong></span>
      </div>
    </div>
    <div class="inline" style="gap:12px;margin-top:10px">
      <div>Labor rates (ISK/hour) →
        <span class="pill">Daytime: <strong id="t_dvRate">–</strong></span>
        <span class="pill">Overtime: <strong id="t_yvRate">–</strong></span>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">Saved keys:
      <code>fp:housingCost</code>, <code>fp:equipCost</code>, <code>fp:adminCost</code>,
      <code>fp:maintEurMonth</code>, <code>fp:rentalsEurMonth</code>, <code>fp:sparesEurMonth</code>, <code>fp:electricityEurMonth</code>, <code>fp:waterEurMonth</code>, <code>fp:otherEurMonth</code>,
      <code>fp:iskPerEur</code>, <code>fp:workingDays</code>, <code>fp:dvRateISK</code>, <code>fp:yvRateISK</code>.
    </div>
  </section>

</div>

<script>
/* ========================= Locale helpers (shared) ========================= */
const LOCALE='is-IS';
function toNumber(value){
  if (value == null) return NaN;
  if (typeof value === 'number') return value;
  let s = (''+value).replace(/\s|\u00A0/g,'').trim();
  if (s === '') return NaN;

  const hasComma = s.includes(',');
  const hasDot   = s.includes('.');

  if (hasComma && hasDot){
    // decimal is whichever appears last
    const lastComma = s.lastIndexOf(',');
    const lastDot   = s.lastIndexOf('.');
    if (lastComma > lastDot){
      // "3.000,75" -> "3000.75"
      s = s.replace(/\./g,'').replace(',', '.');
    } else {
      // "3,000.75" -> "3000.75"
      s = s.replace(/,/g,'');
    }
  } else if (hasComma){
    // If multiple commas, last is decimal; others are thousands
    const commas = (s.match(/,/g)||[]).length;
    if (commas > 1){
      const last = s.lastIndexOf(',');
      s = s.slice(0,last).replace(/,/g,'') + '.' + s.slice(last+1);
    } else {
      // Single comma: treat as thousands if exactly 3 digits after it; otherwise decimal
      const idx = s.indexOf(',');
      const fracLen = s.length - idx - 1;
      if (fracLen === 3) s = s.replace(/,/g,''); else s = s.replace(',', '.');
    }
  } else if (hasDot){
    // If multiple dots, last is decimal; others are thousands
    const dots = (s.match(/\./g)||[]).length;
    if (dots > 1){
      const last = s.lastIndexOf('.');
      s = s.slice(0,last).replace(/\./g,'') + '.' + s.slice(last+1);
    } else {
      // Single dot: treat as thousands if exactly 3 digits after it; otherwise decimal
      const idx = s.indexOf('.');
      const fracLen = s.length - idx - 1;
      if (fracLen === 3) s = s.replace(/\./g,'');
    }
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}


/* ========================= Row model & UI ========================= */
const CAT_ISK = ['housing','equipment','admin'];
const CAT_EUR = ['maintenance','rentals','spares','electricity','water','other'];

function makeRow(building, currency, cat='', amount=''){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" class="cat" placeholder="category" value="${cat}"></td>
    <td><input type="text" class="num amt" inputmode="decimal" placeholder="${currency}/month" value="${amount}"></td>
    <td><button class="danger" title="remove">×</button></td>
  `;
  tr.querySelector('button').addEventListener('click', ()=>{ tr.remove(); recalcAll(); saveAll(); });
  wireNum(tr.querySelector('input.amt'));
  tr.querySelector('input.cat').addEventListener('blur', ()=>{ saveAll(); recalcAll(); });
  tr.querySelector('input.cat').addEventListener('input', debounce(()=>{ saveAll(); recalcAll(); },250));
  return tr;
}
function wireNum(inp){
  inp.addEventListener('focus', ()=>{
    const n = toNumber(inp.value);
    if (Number.isFinite(n)) inp.value = String(n).replace(/(?<=\d)\.0+$/,'');
  });
  inp.addEventListener('blur', ()=>{
    const n = toNumber(inp.value);
    inp.value = Number.isFinite(n) ? fmt(n) : '';
    saveAll(); recalcAll();
  });
  inp.addEventListener('input', debounce(()=>{ saveAll(); recalcAll(); },250));
}
function addRow(building, currency, cat='', amount=''){
  const table = document.querySelector(`table[data-building="${building}"][data-currency="${currency}"] tbody`);
  table.appendChild(makeRow(building, currency, cat, amount));
}

/* ========================= Persistence ========================= */
function storageKey(building,currency){
  return `fp:rows:${building}:${currency}`;
}
function saveAll(){
  // Save tables
  for (const building of ['A','B']){
    for (const currency of ['ISK','EUR']){
      const rows = [...document.querySelectorAll(`table[data-building="${building}"][data-currency="${currency}"] tbody tr`)]
        .map(tr=>({ cat: tr.querySelector('input.cat').value.trim(), amount: tr.querySelector('input.amt').value.trim() }));
      localStorage.setItem(storageKey(building,currency), JSON.stringify(rows));
    }
  }
  // Save globals
  const g = {
    'fp:iskPerEur' : document.getElementById('iskPerEur').value.trim(),
    'fp:workingDays' : document.getElementById('workingDays').value.trim(),
    'fp:dvRateISK' : document.getElementById('dvRateISK').value.trim(),
    'fp:yvRateISK' : document.getElementById('yvRateISK').value.trim()
  };
  for (const [k,v] of Object.entries(g)){
    if (v !== '') {
  localStorage.setItem(k, String(toNumber(v)));
} else {
  localStorage.removeItem(k);
}
  }
}
function loadAll(){
  for (const building of ['A','B']){
    for (const currency of ['ISK','EUR']){
      const key = storageKey(building,currency);
      const tbody = document.querySelector(`table[data-building="${building}"][data-currency="${currency}"] tbody`);
      tbody.innerHTML = '';
      let rows = [];
      try { rows = JSON.parse(localStorage.getItem(key)||'[]') } catch(e){}
      if (!rows || !rows.length){
        const cats = currency==='ISK' ? CAT_ISK : CAT_EUR;
        for (const c of cats) addRow(building, currency, c, '');
      } else {
        for (const r of rows) addRow(building, currency, r.cat||'', r.amount||'');
      }
    }
  }
  // Load globals
  const fx = localStorage.getItem('fp:iskPerEur');   if (fx) document.getElementById('iskPerEur').value = fmt(toNumber(fx),2);
  const wd = localStorage.getItem('fp:workingDays'); if (wd) document.getElementById('workingDays').value = fmt(toNumber(wd),0);
  const dv = localStorage.getItem('fp:dvRateISK');
if (dv !== null) {
  document.getElementById('dvRateISK').value =
    new Intl.NumberFormat(LOCALE, { maximumFractionDigits: 0, useGrouping: false })
      .format(toNumber(dv));
}
const yv = localStorage.getItem('fp:yvRateISK');
if (yv !== null) {
  document.getElementById('yvRateISK').value =
    new Intl.NumberFormat(LOCALE, { maximumFractionDigits: 0, useGrouping: false })
      .format(toNumber(yv));
}

/* ========================= Totals & Saved keys ========================= */
function recalcAll(){
  // Subtotals
  for (const building of ['A','B']){
    for (const currency of ['ISK','EUR']){
      const rows = [...document.querySelectorAll(`table[data-building="${building}"][data-currency="${currency}"] tbody tr`)];
      let subtotal = 0;
      for (const tr of rows){
        const n = toNumber(tr.querySelector('input.amt').value);
        if (Number.isFinite(n)) subtotal += n;
      }
      const subCell = document.querySelector(`[data-subtotal="${building}-${currency}"]`);
      if (subCell) subCell.textContent = fmt(subtotal, currency==='ISK'?0:2);
    }
  }

  // Aggregate to saved keys
  const aggISK = { housing:0, equipment:0, admin:0 };
  const aggEUR = { maintenance:0, rentals:0, spares:0, electricity:0, water:0, other:0 };

  for (const building of ['A','B']){
    const rowsISK = [...document.querySelectorAll(`table[data-building="${building}"][data-currency="ISK"] tbody tr`)];
    for (const tr of rowsISK){
      const cat = (tr.querySelector('input.cat').value||'').trim().toLowerCase();
      const val = toNumber(tr.querySelector('input.amt').value)||0;
      if (cat in aggISK) aggISK[cat] += val;
    }
    const rowsEUR = [...document.querySelectorAll(`table[data-building="${building}"][data-currency="EUR"] tbody tr`)];
    for (const tr of rowsEUR){
      const cat = (tr.querySelector('input.cat').value||'').trim().toLowerCase();
      const val = toNumber(tr.querySelector('input.amt').value)||0;
      if (cat in aggEUR) aggEUR[cat] += val;
      else if (cat && !CAT_EUR.includes(cat)) aggEUR.other += val;
    }
  }

  // Save required numeric keys (remove if zero)
  saveKeyNum('fp:housingCost', aggISK.housing);
  saveKeyNum('fp:equipCost',   aggISK.equipment);
  saveKeyNum('fp:adminCost',   aggISK.admin);

  saveKeyNum('fp:maintEurMonth',      aggEUR.maintenance);
  saveKeyNum('fp:rentalsEurMonth',    aggEUR.rentals);
  saveKeyNum('fp:sparesEurMonth',     aggEUR.spares);
  saveKeyNum('fp:electricityEurMonth',aggEUR.electricity);
  saveKeyNum('fp:waterEurMonth',      aggEUR.water);
  saveKeyNum('fp:otherEurMonth',      aggEUR.other);

  // Update badges
  document.getElementById('t_housing').textContent = fmt(aggISK.housing,0);
  document.getElementById('t_equip').textContent   = fmt(aggISK.equipment,0);
  document.getElementById('t_admin').textContent   = fmt(aggISK.admin,0);

  document.getElementById('t_maint').textContent   = fmt(aggEUR.maintenance,2);
  document.getElementById('t_rentals').textContent = fmt(aggEUR.rentals,2);
  document.getElementById('t_spares').textContent  = fmt(aggEUR.spares,2);
  document.getElementById('t_elec').textContent    = fmt(aggEUR.electricity,2);
  document.getElementById('t_water').textContent   = fmt(aggEUR.water,2);
  document.getElementById('t_other').textContent   = fmt(aggEUR.other,2);

  // Rates preview
  const dv = toNumber(localStorage.getItem('fp:dvRateISK'));
  const yv = toNumber(localStorage.getItem('fp:yvRateISK'));
  document.getElementById('t_dvRate').textContent = Number.isFinite(dv) ? fmt(dv) : '–';
  document.getElementById('t_yvRate').textContent = Number.isFinite(yv) ? fmt(yv) : '–';
}
function saveKeyNum(key, num){
  if (num && Number.isFinite(num) && Math.abs(num) > 0){
    localStorage.setItem(key, String(num));
  } else {
    localStorage.removeItem(key);
  }
}

/* ========================= Copy to Planner URL ========================= */
function copyToPlannerURL(){
  const sp = new URLSearchParams();
  const pairs = [
    ['fp_housingCost',        localStorage.getItem('fp:housingCost')],
    ['fp_equipCost',          localStorage.getItem('fp:equipCost')],
    ['fp_adminCost',          localStorage.getItem('fp:adminCost')],
    ['fp_maintEurMonth',      localStorage.getItem('fp:maintEurMonth')],
    ['fp_rentalsEurMonth',    localStorage.getItem('fp:rentalsEurMonth')],
    ['fp_sparesEurMonth',     localStorage.getItem('fp:sparesEurMonth')],
    ['fp_electricityEurMonth',localStorage.getItem('fp:electricityEurMonth')],
    ['fp_waterEurMonth',      localStorage.getItem('fp:waterEurMonth')],
    ['fp_otherEurMonth',      localStorage.getItem('fp:otherEurMonth')],
    ['fp_iskPerEur',          localStorage.getItem('fp:iskPerEur')],
    ['fp_workingDays',        localStorage.getItem('fp:workingDays')],
    // NEW: rates
    ['fp_dvRateISK',          localStorage.getItem('fp:dvRateISK')],
    ['fp_yvRateISK',          localStorage.getItem('fp:yvRateISK')]
  ];
  for (const [k,v] of pairs){
    const n = toNumber(v);
    if (v!=null && Number.isFinite(n) && Math.abs(n)>0) sp.set(k, String(n));
  }
  const url = 'index.html' + (sp.toString() ? ('?'+sp.toString()) : '');
  try { navigator.clipboard.writeText(new URL(url, location.href).href); } catch(e){}
  location.href = url;
}

/* ========================= Events & bootstrap ========================= */
function wireButtons(){
  document.querySelectorAll('button[data-add]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const [building,currency] = btn.getAttribute('data-add').split('-');
      addRow(building, currency, '', '');
      saveAll(); recalcAll();
    });
  });
  document.getElementById('copyToPlanner').addEventListener('click', copyToPlannerURL);

  // Globals formatting & save
  ['iskPerEur','workingDays','dvRateISK','yvRateISK'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('focus', ()=>{ const n = toNumber(el.value); if (Number.isFinite(n)) el.value = String(n); });
  el.addEventListener('blur', ()=>{
    const n = toNumber(el.value);
    if (!Number.isFinite(n)) { el.value=''; saveAll(); return; }

    if (id==='workingDays') {
      el.value = new Intl.NumberFormat(LOCALE, { maximumFractionDigits:0, useGrouping:false }).format(n);
    } else if (id==='iskPerEur') {
      el.value = new Intl.NumberFormat(LOCALE, { minimumFractionDigits:2, maximumFractionDigits:2 }).format(n);
    } else if (id==='dvRateISK' || id==='yvRateISK') {
      // rates: integers, no grouping so “6200” stays “6200”
      el.value = new Intl.NumberFormat(LOCALE, { maximumFractionDigits:0, useGrouping:false }).format(n);
    }
    saveAll();
    recalcAll();
  });
  el.addEventListener('input', debounce(()=>{ saveAll(); recalcAll(); },300));
});
}

function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

document.addEventListener('DOMContentLoaded', ()=>{
  loadAll();
  recalcAll();
  wireButtons();
});
</script>
</body>
</html>
