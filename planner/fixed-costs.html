<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fixed Costs — Buildings</title>
  <style>
    :root{
      --gap:14px;--pad:16px;
      --bg:#f6f8fc;--card:#ffffff;--ink:#0b1320;--muted:#4a5874;--accent:#0b5fff;--border:#e4e9f2;--field:#d6dbe6;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:24px var(--pad);border-bottom:1px solid var(--border)}
    h1{margin:0 0 6px;font-size:22px}
    h2{margin:0 0 10px;font-size:18px;color:var(--accent)}
    main{padding:20px var(--pad) 60px;display:grid;gap:14px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    label{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-weight:600}
    input,select{background:#fff;color:var(--ink);border:1px solid var(--field);border-radius:8px;padding:9px 11px;outline:none}
    input:focus{border-color:#2c6fff;box-shadow:0 0 0 2px rgba(44,111,255,.14)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{display:inline-block;background:var(--accent);color:#fff;border:1px solid var(--accent);
      padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--accent)}
    .btn:hover,.btn:focus{filter:brightness(.95)}
    .muted{color:var(--muted)}
    .building{border:1px solid var(--border);border-radius:10px;padding:12px;margin-top:12px}
    .building h3{margin:0 0 8px;font-size:16px;color:#1b2746;display:flex;justify-content:space-between;align-items:center}
    .remove{background:#fff;color:#d11;border:1px solid #f1b5b5}
    ul.results{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0 0;padding:0;list-style:none}
    .results li{background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .results li span{color:var(--muted)} .results li strong{font-size:15px}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>Fixed Costs (by building)</h1>
    <div class="muted">Add one or more buildings. Totals are saved for the planner page.</div>
    <div class="actions">
      <a class="btn secondary" href="./">← Back to planner</a>
      <button id="saveBtn" class="btn">Save defaults</button>
      <button id="resetBtn" class="btn secondary">Reset saved defaults</button>
    </div>
  </header>

  <main>
    <!-- GLOBALS -->
    <section class="card">
      <h2>Globals</h2>
      <div class="grid">
        <label>ISK per EUR
          <input id="iskPerEur" inputmode="decimal" placeholder="e.g. 0.0068" />
        </label>
        <label>Working days (per month)
          <input id="workingDays" inputmode="numeric" placeholder="e.g. 21" />
          <span class="note">Optional. Planner can auto-calc from month if left blank.</span>
        </label>
        <label>Electricity €/kWh
          <input id="elecCostPerKwh" inputmode="decimal" placeholder="e.g. 0.15" />
        </label>
        <label>Water €/m³
          <input id="waterCostPerM3" inputmode="decimal" placeholder="e.g. 2.50" />
        </label>
      </div>
    </section>

    <!-- BUILDINGS -->
    <section class="card">
      <h2>Buildings</h2>
      <div id="buildingsList"></div>
      <div class="actions">
        <button id="addBuilding" class="btn">+ Add building</button>
      </div>
      <div class="note" style="margin-top:8px">
        Electricity (kWh/day) and Water (m³/day) are summed across buildings. Rates above are global.
      </div>
    </section>

    <!-- TOTALS -->
    <section class="card">
      <h2>Totals saved to planner</h2>
      <ul class="results" id="totals">
        <li><span>Housing (ISK/month)</span><strong id="t-housing">–</strong></li>
        <li><span>Equipment (ISK/month)</span><strong id="t-equip">–</strong></li>
        <li><span>Admin (ISK/month)</span><strong id="t-admin">–</strong></li>

        <li><span>Maintenance (€/day)</span><strong id="t-maint">–</strong></li>
        <li><span>Depreciation (€/day)</span><strong id="t-depr">–</strong></li>
        <li><span>Other (€/day)</span><strong id="t-other">–</strong></li>

        <li><span>Electricity (kWh/day)</span><strong id="t-elec">–</strong></li>
        <li><span>Water (m³/day)</span><strong id="t-water">–</strong></li>
      </ul>
    </section>
  </main>

  <script>
  // ---------- helpers ----------
  const locale = 'is-IS';
  const q = (s, r=document)=>r.querySelector(s);
  const qa = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const setText=(sel,val)=>{const el=typeof sel==='string'?q(sel):sel;if(el)el.textContent=val;};
  const fmt=(n,d=2)=>Number.isFinite(n)? new Intl.NumberFormat(locale,{minimumFractionDigits:d,maximumFractionDigits:d}).format(n) : '–';
  const nfIntIS = new Intl.NumberFormat('is-IS', { maximumFractionDigits: 0 });

  function toNumber(v){
    if(v==null) return NaN;
    let s=String(v).trim().replace(/\u00A0/g,'').replace(/\s/g,'');
    if(!s) return NaN;
    const hasComma=s.includes(','), hasDot=s.includes('.');
    if(hasComma&&hasDot){
      if(s.lastIndexOf(',')>s.lastIndexOf('.')) s=s.replace(/\./g,'').replace(',', '.');
      else s=s.replace(/,/g,'');
    }else if(hasComma){
      const parts=s.split(','), k=parts.length>1 && parts.every((p,i)=>(i===0?p.length<=3:p.length===3));
      s=k? s.replace(/,/g,'') : s.replace(',', '.');
    }else if(hasDot){
      const parts=s.split('.'), k=parts.length>1 && parts.every((p,i)=>(i===0?p.length<=3:p.length===3));
      if(k) s=s.replace(/\./g,'');
    }
    const n=Number(s); return Number.isFinite(n)? n : NaN;
  }

  // ---------- storage contract with planner ----------
  const LS_PREFIX = 'fp:'; // must match planner
  const AGGR_KEYS = [
    'iskPerEur','workingDays',
    'housingCost','equipCost','adminCost',
    'maintenanceCost','deprCost','otherCost',
    'elecKwh','elecCostPerKwh','waterM3','waterCostPerM3'
  ];
  const BUILDINGS_KEY = LS_PREFIX + 'buildings';

  // ---------- building UI ----------
  let buildingSeq = 1;

  function buildingTemplate(data={}){
    const {
      name = `Building ${buildingSeq++}`,
      housingISK = '', equipISK = '', adminISK = '',
      maintEURd = '', deprEURd = '', otherEURd = '',
      elecKwh = '', waterM3 = ''
    } = data;

    const wrapper = document.createElement('div');
    wrapper.className = 'building';
    wrapper.innerHTML = `
      <h3>
        <span contenteditable="true" class="b-name" spellcheck="false">${name}</span>
        <button class="btn remove" type="button">Remove</button>
      </h3>
      <div class="grid">
        <label>Housing (ISK/month)
          <input class="b-housing" inputmode="decimal" value="${housingISK}">
        </label>
        <label>Equipment (ISK/month)
          <input class="b-equip" inputmode="decimal" value="${equipISK}">
        </label>
        <label>Admin (ISK/month)
          <input class="b-admin" inputmode="decimal" value="${adminISK}">
        </label>

        <label>Maintenance (€/day)
          <input class="b-maint" inputmode="decimal" value="${maintEURd}">
        </label>
        <label>Depreciation (€/day)
          <input class="b-depr" inputmode="decimal" value="${deprEURd}">
        </label>
        <label>Other (€/day)
          <input class="b-other" inputmode="decimal" value="${otherEURd}">
        </label>

        <label>Electricity (kWh/day)
          <input class="b-elec" inputmode="decimal" value="${elecKwh}">
        </label>
        <label>Water (m³/day)
          <input class="b-water" inputmode="decimal" value="${waterM3}">
        </label>
      </div>
    `;
    // events
    wrapper.querySelector('.remove').addEventListener('click', ()=>{
      wrapper.remove();
      updateTotals();
      persistBuildingsDraft();
    });
    // recalc on edits
    qa('input', wrapper).forEach(i=>{
      i.addEventListener('input', ()=>{ updateTotals(); persistBuildingsDraft(); });
    });
    wrapper.querySelector('.b-name').addEventListener('input', ()=>persistBuildingsDraft());
    return wrapper;
  }

  function readBuildingFromEl(el){
    return {
      name: el.querySelector('.b-name')?.textContent?.trim() || '',
      housingISK: el.querySelector('.b-housing')?.value || '',
      equipISK:   el.querySelector('.b-equip')?.value   || '',
      adminISK:   el.querySelector('.b-admin')?.value   || '',
      maintEURd:  el.querySelector('.b-maint')?.value   || '',
      deprEURd:   el.querySelector('.b-depr')?.value    || '',
      otherEURd:  el.querySelector('.b-other')?.value   || '',
      elecKwh:    el.querySelector('.b-elec')?.value    || '',
      waterM3:    el.querySelector('.b-water')?.value   || ''
    };
  }

  function persistBuildingsDraft(){
    const list = qa('.building').map(readBuildingFromEl);
    localStorage.setItem(BUILDINGS_KEY, JSON.stringify(list));
  }

  function loadBuildingsDraft(){
    try{
      const raw = localStorage.getItem(BUILDINGS_KEY);
      if(!raw) return null;
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return null;
      return arr;
    }catch{ return null; }
  }

  function renderBuildings(list){
    const host = q('#buildingsList');
    host.innerHTML = '';
    (list && list.length ? list : [{name:'Building 1'}]).forEach(b=>{
      host.appendChild(buildingTemplate(b));
    });
  }

  // ---------- totals & save ----------
  function updateTotals(){
    let housing=0, equip=0, admin=0, maint=0, depr=0, other=0, elec=0, water=0;

    qa('.building').forEach(el=>{
      const b = readBuildingFromEl(el);
      const n = (x)=>toNumber(x)||0;

      housing += n(b.housingISK);
      equip   += n(b.equipISK);
      admin   += n(b.adminISK);

      maint   += n(b.maintEURd);
      depr    += n(b.deprEURd);
      other   += n(b.otherEURd);

      elec    += n(b.elecKwh);
      water   += n(b.waterM3);
    });

    setText('#t-housing', fmt(housing,0));
    setText('#t-equip',   fmt(equip,0));
    setText('#t-admin',   fmt(admin,0));

    setText('#t-maint',   fmt(maint));
    setText('#t-depr',    fmt(depr));
    setText('#t-other',   fmt(other));

    setText('#t-elec',    fmt(elec,0));
    setText('#t-water',   fmt(water,2));

    return {housing,equip,admin,maint,depr,other,elec,water};
  }

  function saveAll(){
    // 1) store buildings draft (structured)
    persistBuildingsDraft();

    // 2) globals
    const iskPerEur      = q('#iskPerEur').value;
    const workingDays    = q('#workingDays').value;
    const elecCostPerKwh = q('#elecCostPerKwh').value;
    const waterCostPerM3 = q('#waterCostPerM3').value;

    localStorage.setItem(LS_PREFIX+'iskPerEur', iskPerEur);
    if (workingDays !== '') localStorage.setItem(LS_PREFIX+'workingDays', workingDays);

    localStorage.setItem(LS_PREFIX+'elecCostPerKwh', elecCostPerKwh);
    localStorage.setItem(LS_PREFIX+'waterCostPerM3', waterCostPerM3);

    // 3) totals for planner fields
    const t = updateTotals();
    localStorage.setItem(LS_PREFIX+'housingCost', String(t.housing));
    localStorage.setItem(LS_PREFIX+'equipCost',   String(t.equip));
    localStorage.setItem(LS_PREFIX+'adminCost',   String(t.admin));

    localStorage.setItem(LS_PREFIX+'maintenanceCost', String(t.maint));
    localStorage.setItem(LS_PREFIX+'deprCost',        String(t.depr));
    localStorage.setItem(LS_PREFIX+'otherCost',       String(t.other));

    localStorage.setItem(LS_PREFIX+'elecKwh',   String(t.elec));
    localStorage.setItem(LS_PREFIX+'waterM3',   String(t.water));

    flashSaved();
  }

  function flashSaved(){
    const btn = q('#saveBtn');
    const old = btn.textContent;
    btn.textContent = 'Saved ✓';
    setTimeout(()=>btn.textContent = old, 1000);
  }

  function resetAll(){
    if(!confirm('Clear all fixed-cost defaults saved for the planner?')) return;
    // remove aggregated & globals
    AGGR_KEYS.forEach(k=>localStorage.removeItem(LS_PREFIX+k));
    localStorage.removeItem(BUILDINGS_KEY);
    // clear UI
    q('#iskPerEur').value = '';
    q('#workingDays').value = '';
    q('#elecCostPerKwh').value = '';
    q('#waterCostPerM3').value = '';
    renderBuildings([{name:'Building 1'}]);
    updateTotals();
  }

  // ---------- boot ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    // load globals
    q('#iskPerEur').value      = localStorage.getItem(LS_PREFIX+'iskPerEur')      || '';
    q('#workingDays').value    = localStorage.getItem(LS_PREFIX+'workingDays')    || '';
    q('#elecCostPerKwh').value = localStorage.getItem(LS_PREFIX+'elecCostPerKwh') || '';
    q('#waterCostPerM3').value = localStorage.getItem(LS_PREFIX+'waterCostPerM3') || '';

    // load buildings (or start with one)
    const draft = loadBuildingsDraft();
    renderBuildings(draft && draft.length ? draft : [{name:'Building 1'}]);
    updateTotals();

    // wire buttons
    q('#addBuilding').addEventListener('click', ()=>{
      q('#buildingsList').appendChild(buildingTemplate({}));
      updateTotals();
      persistBuildingsDraft();
    });
    q('#saveBtn').addEventListener('click', saveAll);
    q('#resetBtn').addEventListener('click', resetAll);

    // recalc totals if globals change? (rates don't affect totals here, only planner calc)
    qa('#iskPerEur,#workingDays,#elecCostPerKwh,#waterCostPerM3').forEach(el=>{
      el.addEventListener('input', ()=>{/* noop for totals */});
    });
  });
  </script>
</body>
</html>
