<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fixed Costs — 2 Buildings</title>
  <style>
    :root{
      --gap:14px;--pad:16px;
      --bg:#f6f8fc;--card:#fff;--ink:#0b1320;--muted:#4a5874;--accent:#0b5fff;--border:#e4e9f2;--field:#d6dbe6
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:24px var(--pad);border-bottom:1px solid var(--border)}
    h1{margin:0 0 6px;font-size:22px}
    h2{margin:0 0 10px;font-size:18px;color:var(--accent)}
    main{padding:20px var(--pad) 60px;display:grid;gap:14px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    label{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-weight:600}
    input,select{background:#fff;color:var(--ink);border:1px solid var(--field);border-radius:8px;padding:9px 11px;outline:none}
    input:focus,select:focus{border-color:#2c6fff;box-shadow:0 0 0 2px rgba(44,111,255,.14)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{display:inline-block;background:var(--accent);color:#fff;border:1px solid var(--accent);padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--accent)}
    .muted{color:var(--muted)}
    .buildings{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:14px}
    .building{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px}
    .building h3{margin:0 0 8px;font-size:16px;color:#1b2746}
    .section-sub{margin:12px 0 6px;color:#4a5874;font-weight:700}

    .rows{display:grid;gap:8px}
    .row{
      display:grid;
      grid-template-columns:minmax(160px,1fr) 130px minmax(200px,1.2fr) 140px 36px;
      gap:8px;align-items:center
    }
    .row input{padding:8px 10px}
    .row .cat{width:130px}
    .row .amt{text-align:right}
    .row .del{height:36px;width:36px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer}

    ul.results{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0 0;padding:0;list-style:none}
    .results li{background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .results li span{color:var(--muted)} .results li strong{font-size:15px}
    .mini{margin-top:10px}
    .note{font-size:12px;color:var(--muted)}

    @media (max-width:680px){
      .row{grid-template-columns:1fr 1fr;grid-auto-rows:auto}
      .row .cat{grid-column:1/3}
      .row .desc{grid-column:1/3}
      .row .amt{grid-column:1/2}
      .row .del{grid-column:2/3;justify-self:end}
    }
  </style>
</head>
<body>
<header>
  <h1>Fixed Costs (2 buildings)</h1>
  <div class="muted">Add monthly ISK costs and monthly/daily € costs per building. Totals are saved for the planner.</div>
  <div class="actions">
    <a class="btn secondary" href="./">← Back to planner</a>
    <button id="copyBtn" class="btn">Copy to planner now</button>
    <button id="saveBtn" class="btn secondary">Save defaults</button>
    <button id="resetBtn" class="btn secondary">Reset saved</button>
  </div>
</header>

<main>
  <!-- GLOBALS -->
  <section class="card">
    <h2>Globals</h2>
    <div class="grid">
      <label>ISK per EUR
        <input id="iskPerEur" inputmode="decimal" placeholder="e.g. 0.0068" />
      </label>
      <label>Working days (per month)
        <input id="workingDays" inputmode="numeric" placeholder="e.g. 21" />
        <span class="note">Optional. Planner can auto-calc from month if left blank.</span>
      </label>
      <label>Electricity €/kWh
        <input id="elecCostPerKwh" inputmode="decimal" placeholder="e.g. 0.15" />
      </label>
      <label>Water €/m³
        <input id="waterCostPerM3" inputmode="decimal" placeholder="e.g. 2.50" />
      </label>
    </div>
  </section>

  <!-- BUILDINGS -->
  <section class="card">
    <h2>Buildings</h2>

    <div class="buildings">
      <!-- Building A -->
      <div id="bA" class="building">
        <h3>Whitefish &amp; Salmon factories</h3>

        <div class="grid">
          <label>Electricity (kWh/day)<input class="elec" inputmode="decimal" /></label>
          <label>Water (m³/day)<input class="water" inputmode="decimal" /></label>
        </div>

        <div class="section-sub">Monthly costs — ISK/month</div>
        <div class="rows monthly-isk"></div>
        <div class="actions"><button class="btn add-monthly-isk" type="button">+ Add ISK cost</button></div>

        <div class="section-sub">Monthly costs — €/month</div>
        <div class="rows monthly-eur"></div>
        <div class="actions"><button class="btn add-monthly-eur" type="button">+ Add € cost</button></div>

        <div class="section-sub">Daily costs — €/day</div>
        <div class="rows daily-eur"></div>
        <div class="actions"><button class="btn add-daily-eur" type="button">+ Add €/day cost</button></div>

        <ul class="results mini">
          <li><span>Housing (ISK/mo)</span><strong id="b0-housing">–</strong></li>
          <li><span>Equipment (ISK/mo)</span><strong id="b0-equipment">–</strong></li>
          <li><span>Admin (ISK/mo)</span><strong id="b0-admin">–</strong></li>
          <li><span>Maintenance (€/mo)</span><strong id="b0-maint">–</strong></li>
          <li><span>Rentals (€/mo)</span><strong id="b0-rentals">–</strong></li>
          <li><span>Spare parts (€/mo)</span><strong id="b0-spares">–</strong></li>
          <li><span>Other (€/mo)</span><strong id="b0-othereur">–</strong></li>
          <li><span>Other (€/day)</span><strong id="b0-otherday">–</strong></li>
          <li><span>Elec (kWh/day)</span><strong id="b0-elec">–</strong></li>
          <li><span>Water (m³/day)</span><strong id="b0-water">–</strong></li>
        </ul>
      </div>

      <!-- Building B -->
      <div id="bB" class="building">
        <h3>Smokehouse</h3>

        <div class="grid">
          <label>Electricity (kWh/day)<input class="elec" inputmode="decimal" /></label>
          <label>Water (m³/day)<input class="water" inputmode="decimal" /></label>
        </div>

        <div class="section-sub">Monthly costs — ISK/month</div>
        <div class="rows monthly-isk"></div>
        <div class="actions"><button class="btn add-monthly-isk" type="button">+ Add ISK cost</button></div>

        <div class="section-sub">Monthly costs — €/month</div>
        <div class="rows monthly-eur"></div>
        <div class="actions"><button class="btn add-monthly-eur" type="button">+ Add € cost</button></div>

        <div class="section-sub">Daily costs — €/day</div>
        <div class="rows daily-eur"></div>
        <div class="actions"><button class="btn add-daily-eur" type="button">+ Add €/day cost</button></div>

        <ul class="results mini">
          <li><span>Housing (ISK/mo)</span><strong id="b1-housing">–</strong></li>
          <li><span>Equipment (ISK/mo)</span><strong id="b1-equipment">–</strong></li>
          <li><span>Admin (ISK/mo)</span><strong id="b1-admin">–</strong></li>
          <li><span>Maintenance (€/mo)</span><strong id="b1-maint">–</strong></li>
          <li><span>Rentals (€/mo)</span><strong id="b1-rentals">–</strong></li>
          <li><span>Spare parts (€/mo)</span><strong id="b1-spares">–</strong></li>
          <li><span>Other (€/mo)</span><strong id="b1-othereur">–</strong></li>
          <li><span>Other (€/day)</span><strong id="b1-otherday">–</strong></li>
          <li><span>Elec (kWh/day)</span><strong id="b1-elec">–</strong></li>
          <li><span>Water (m³/day)</span><strong id="b1-water">–</strong></li>
        </ul>
      </div>
    </div>
  </section>

  <!-- TOTALS SENT TO PLANNER -->
  <section class="card">
    <h2>Totals saved to planner</h2>
    <ul class="results" id="totals">
      <li><span>Housing (ISK/month)</span><strong id="t-housing">–</strong></li>
      <li><span>Equipment (ISK/month)</span><strong id="t-equipment">–</strong></li>
      <li><span>Admin (ISK/month)</span><strong id="t-admin">–</strong></li>
      <li><span>Maintenance (€/day)</span><strong id="t-maint">–</strong></li>
      <li><span>Other (€/day)</span><strong id="t-other">–</strong></li>
      <li><span>Electricity (kWh/day)</span><strong id="t-elec">–</strong></li>
      <li><span>Water (m³/day)</span><strong id="t-water">–</strong></li>
    </ul>
  </section>
</main>

<script>
  /* ---------- helpers ---------- */
  const locale='is-IS';
  const q=(s,r=document)=>r.querySelector(s);
  const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const setText=(sel,val)=>{const el=typeof sel==='string'?q(sel):sel;if(el)el.textContent=val;};
const fmt=(n,d=2)=>Number.isFinite(n)
  ? new Intl.NumberFormat(locale,{minimumFractionDigits:d,maximumFractionDigits:d}).format(n)
  : '–';

  // Robust number parser
  function toNumber(v){
    if(v==null) return NaN;
    let s=String(v).trim().replace(/\u00A0/g,'').replace(/\s/g,'');
    if(!s) return NaN;
    const hasC=s.includes(','), hasD=s.includes('.');
    if(hasC&&hasD){
      if(s.lastIndexOf(',')>s.lastIndexOf('.')) s=s.replace(/\./g,'').replace(',', '.');
      else s=s.replace(/,/g,'');
    }else if(hasC){
      const parts=s.split(','), thousands=parts.length>1&&parts.every((p,i)=>(i===0?p.length<=3:p.length===3));
      s=thousands?s.replace(/,/g,''):s.replace(',', '.');
    }else if(hasD){
      const parts=s.split('.'), thousands=parts.length>1&&parts.every((p,i)=>(i===0?p.length<=3:p.length===3));
      if(thousands) s=s.replace(/\./g,'');
    }
    const n=Number(s);
    return Number.isFinite(n)? n : NaN;
  }

  // Debounce
  const debounce=(fn,delay=120)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),delay);};};
  const debouncedSaveTotals = debounce(()=>{ updateTotals(); saveBuildings(); },120);

  const addStr=(qs,k,v)=>{ if(v!=null && String(v).trim()!=='') qs.set(k,String(v)); };
  const addNum=(qs,k,v)=>{ const n=toNumber(v); if(Number.isFinite(n) && n!==0) qs.set(k,String(n)); };

  /* ---------- categories ---------- */
  const CATS_MONTH_ISK = [
    {value:'housing',   label:'Housing (ISK/mo)'},
    {value:'equipment', label:'Equipment (ISK/mo)'},
    {value:'admin',     label:'Admin (ISK/mo)'}
  ];
  const CATS_MONTH_EUR = [
    {value:'maintenance', label:'Maintenance (€/mo)'},
    {value:'rentals',     label:'Rentals (€/mo)'},
    {value:'spares',      label:'Spare parts (€/mo)'},
    {value:'otherEur',    label:'Other (€/mo)'}
  ];
  const CATS_DAY_EUR = [
    {value:'otherDay', label:'Other (€/day)'}
  ];
  function fillCat(selectEl, list){
    selectEl.innerHTML = list.map(c=>`<option value="${c.value}">${c.label}</option>`).join('');
  }

  /* ---------- row builder ---------- */
  function addCostRow(rowsEl, preset={}){
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <input class="name" placeholder="Name (e.g. Rent, Waste pickup)" />
      <select class="cat"></select>
      <input class="desc" placeholder="Description (optional)" />
      <input class="amt" inputmode="decimal" placeholder="${rowsEl.classList.contains('monthly-isk') ? 'ISK/month' : rowsEl.classList.contains('monthly-eur') ? '€/month' : '€/day'}" />
      <button class="del" type="button">×</button>
    `;

    if (rowsEl.classList.contains('monthly-isk')) fillCat(row.querySelector('.cat'), CATS_MONTH_ISK);
    else if (rowsEl.classList.contains('monthly-eur')) fillCat(row.querySelector('.cat'), CATS_MONTH_EUR);
    else fillCat(row.querySelector('.cat'), CATS_DAY_EUR);

    if (preset.name) row.querySelector('.name').value = preset.name;
    if (preset.desc) row.querySelector('.desc').value = preset.desc;
    if (preset.amt)  row.querySelector('.amt').value  = preset.amt;
    if (preset.cat)  row.querySelector('.cat').value  = preset.cat;

    rowsEl.appendChild(row);
    row.addEventListener('input', debouncedSaveTotals);
    row.querySelector('.del').addEventListener('click', ()=>{ row.remove(); debouncedSaveTotals(); });
  }

  /* ---------- serialize / restore ---------- */
  const STORE_KEY = 'fp:fixed:v2';

  function serializeBuilding(bEl){
    const pack = (sel)=> qa(`${sel} .row`, bEl).map(r=>({
      name: r.querySelector('.name')?.value?.trim() || '',
      cat:  r.querySelector('.cat') ?.value || '',
      desc: r.querySelector('.desc')?.value?.trim() || '',
      amt:  r.querySelector('.amt') ?.value?.trim() || ''
    }));
    return {
      title: q('h3', bEl)?.textContent || '',
      elec:  q('.elec',  bEl)?.value || '',
      water: q('.water', bEl)?.value || '',
      monthlyISK: pack('.monthly-isk'),
      monthlyEUR: pack('.monthly-eur'),
      dailyEUR:   pack('.daily-eur')
    };
  }

  function restoreBuilding(bEl, data={}){
    if (data.elec)  q('.elec',  bEl).value = data.elec;
    if (data.water) q('.water', bEl).value = data.water;
    (data.monthlyISK||[]).forEach(x=> addCostRow(q('.monthly-isk', bEl), x));
    (data.monthlyEUR||[]).forEach(x=> addCostRow(q('.monthly-eur', bEl), x));
    (data.dailyEUR||[]).forEach(x=>   addCostRow(q('.daily-eur',   bEl), x));
  }

  function saveBuildings(){
    const data = qa('.building').map(serializeBuilding);
    localStorage.setItem(STORE_KEY, JSON.stringify(data));
  }

  function loadBuildings(){
    try{
      let data = JSON.parse(localStorage.getItem(STORE_KEY) || 'null');
      if (!Array.isArray(data)) data = JSON.parse(localStorage.getItem('fp:fixed:v3') || '[]'); // fallback
      const buildings = [q('#bA'), q('#bB')];
      buildings.forEach((bEl,i)=> restoreBuilding(bEl, data[i]||{}));
    }catch(e){}
  }

  /* ---------- totals & persistence to planner ---------- */
  const LS_PREFIX='fp:';
  function updateTotals(){
    const buildings = [q('#bA'), q('#bB')];
    const per = buildings.map(()=>({
      housing:0, equipment:0, admin:0,      // ISK/mo
      maint:0, rentals:0, spares:0, othereur:0, // €/mo
      otherday:0,                             // €/day
      elec:0, water:0
    }));

    buildings.forEach((bEl, idx)=>{
      per[idx].elec  = toNumber(q('.elec',  bEl)?.value)||0;
      per[idx].water = toNumber(q('.water', bEl)?.value)||0;

      qa('.monthly-isk .row', bEl).forEach(r=>{
        const cat = r.querySelector('.cat')?.value || '';
        const amt = toNumber(r.querySelector('.amt')?.value)||0;
        if (cat==='housing')        per[idx].housing   += amt;
        else if (cat==='equipment') per[idx].equipment += amt;
        else if (cat==='admin')     per[idx].admin     += amt;
      });

      qa('.monthly-eur .row', bEl).forEach(r=>{
        const cat = r.querySelector('.cat')?.value || '';
        const amt = toNumber(r.querySelector('.amt')?.value)||0;
        if (cat==='maintenance')      per[idx].maint    += amt;
        else if (cat==='rentals')     per[idx].rentals  += amt;
        else if (cat==='spares')      per[idx].spares   += amt;
        else if (cat==='otherEur')    per[idx].othereur += amt;
      });

      qa('.daily-eur .row', bEl).forEach(r=>{
        const amt = toNumber(r.querySelector('.amt')?.value)||0;
        per[idx].otherday += amt;
      });
    });

    per.forEach((b, i)=>{
      setText(`#b${i}-housing`,   fmt(b.housing,0));
      setText(`#b${i}-equipment`, fmt(b.equipment,0));
      setText(`#b${i}-admin`,     fmt(b.admin,0));
      setText(`#b${i}-maint`,     fmt(b.maint,2));
      setText(`#b${i}-rentals`,   fmt(b.rentals,2));
      setText(`#b${i}-spares`,    fmt(b.spares,2));
      setText(`#b${i}-othereur`,  fmt(b.othereur,2));
      setText(`#b${i}-otherday`,  fmt(b.otherday,2));
      setText(`#b${i}-elec`,      fmt(b.elec,0));
      setText(`#b${i}-water`,     fmt(b.water,2));
    });

    const agg = per.reduce((a,b)=>({
      housing:a.housing+b.housing,
      equipment:a.equipment+b.equipment,
      admin:a.admin+b.admin,
      maint:a.maint+b.maint,
      rentals:a.rentals+b.rentals,
      spares:a.spares+b.spares,
      othereur:a.othereur+b.othereur,
      otherday:a.otherday+b.otherday,
      elec:a.elec+b.elec,
      water:a.water+b.water
    }), {housing:0,equipment:0,admin:0,maint:0,rentals:0,spares:0,othereur:0,otherday:0,elec:0,water:0});

    const wd = toNumber(q('#workingDays')?.value);
    const workingDays = Number.isFinite(wd) && wd>0 ? wd : 22;

    const t_housing   = agg.housing;
    const t_equipment = agg.equipment;
    const t_admin     = agg.admin;

    const t_maint_day = (agg.maint + agg.spares) / (workingDays||1);
    const t_other_day = (agg.rentals + agg.othereur) / (workingDays||1) + agg.otherday;

    setText('#t-housing',   fmt(t_housing,0));
    setText('#t-equipment', fmt(t_equipment,0));
    setText('#t-admin',     fmt(t_admin,0));
    setText('#t-maint',     fmt(t_maint_day,2));
    setText('#t-other',     fmt(t_other_day,2));
    setText('#t-elec',      fmt(agg.elec,0));
    setText('#t-water',     fmt(agg.water,2));

    return {t_housing, t_equipment, t_admin, t_maint_day, t_other_day, elec:agg.elec, water:agg.water};
  }

  function saveDefaults(){
    saveBuildings();
    const totals = updateTotals();

    localStorage.setItem(LS_PREFIX+'iskPerEur',      q('#iskPerEur').value || '');
    if (q('#workingDays').value!=='') localStorage.setItem(LS_PREFIX+'workingDays', q('#workingDays').value);
    localStorage.setItem(LS_PREFIX+'elecCostPerKwh', q('#elecCostPerKwh').value || '');
    localStorage.setItem(LS_PREFIX+'waterCostPerM3', q('#waterCostPerM3').value || '');

    localStorage.setItem(LS_PREFIX+'housingCost',     String(totals.t_housing));
    localStorage.setItem(LS_PREFIX+'equipCost',       String(totals.t_equipment));
    localStorage.setItem(LS_PREFIX+'adminCost',       String(totals.t_admin));
    localStorage.setItem(LS_PREFIX+'maintenanceCost', String(totals.t_maint_day.toFixed(2)));
    localStorage.setItem(LS_PREFIX+'otherCost',       String(totals.t_other_day.toFixed(2)));
    localStorage.setItem(LS_PREFIX+'elecKwh',         String(totals.elec));
    localStorage.setItem(LS_PREFIX+'waterM3',         String(totals.water));

    const btn=q('#saveBtn'); if(btn){const old=btn.textContent; btn.textContent='Saved ✓'; setTimeout(()=>btn.textContent=old,900);}
    return totals;
  }

  function copyToPlanner(){
    const t = saveDefaults();
    const qs = new URLSearchParams();

    addStr(qs,'iskPerEur', q('#iskPerEur').value);
    if(q('#workingDays').value!=='') addStr(qs,'workingDays', q('#workingDays').value);

    addNum(qs,'housingCost', t.t_housing);
    addNum(qs,'equipCost',   t.t_equipment);
    addNum(qs,'adminCost',   t.t_admin);

    addNum(qs,'maintenanceCost', t.t_maint_day.toFixed(2));
    addNum(qs,'otherCost',        t.t_other_day.toFixed(2));

    addNum(qs,'elecKwh', t.elec);
    addStr(qs,'elecCostPerKwh', q('#elecCostPerKwh').value);
    addNum(qs,'waterM3', t.water);
    addStr(qs,'waterCostPerM3', q('#waterCostPerM3').value);

    location.href = './?' + qs.toString() + '#day';
  }

  function resetAll(){
    if(!confirm('Clear all fixed-cost defaults saved for the planner?')) return;
    [
      'iskPerEur','workingDays','elecCostPerKwh','waterCostPerM3',
      'housingCost','equipCost','adminCost','maintenanceCost','otherCost','elecKwh','waterM3'
    ].forEach(k=> localStorage.removeItem(LS_PREFIX+k));
    localStorage.removeItem(STORE_KEY);
    location.reload();
  }

  /* ---------- wiring ---------- */
  function wireButtons(){
    qa('.building').forEach(b=>{
      b.querySelector('.add-monthly-isk').addEventListener('click', ()=>{
        addCostRow(q('.monthly-isk', b));
        debouncedSaveTotals();
      });
      b.querySelector('.add-monthly-eur').addEventListener('click', ()=>{
        addCostRow(q('.monthly-eur', b));
        debouncedSaveTotals();
      });
      b.querySelector('.add-daily-eur').addEventListener('click', ()=>{
        addCostRow(q('.daily-eur', b));
        debouncedSaveTotals();
      });
      b.querySelector('.elec').addEventListener('input', debouncedSaveTotals);
      b.querySelector('.water').addEventListener('input', debouncedSaveTotals);
    });

    q('#saveBtn').addEventListener('click', saveDefaults);
    q('#copyBtn').addEventListener('click', copyToPlanner);
    q('#resetBtn').addEventListener('click', resetAll);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // load globals
    q('#iskPerEur').value      = localStorage.getItem(LS_PREFIX+'iskPerEur')      || '';
    q('#workingDays').value    = localStorage.getItem(LS_PREFIX+'workingDays')    || '';
    q('#elecCostPerKwh').value = localStorage.getItem(LS_PREFIX+'elecCostPerKwh') || '';
    q('#waterCostPerM3').value = localStorage.getItem(LS_PREFIX+'waterCostPerM3') || '';

    wireButtons();
    loadBuildings();
    updateTotals();
  });
</script>
</body>
</html>
